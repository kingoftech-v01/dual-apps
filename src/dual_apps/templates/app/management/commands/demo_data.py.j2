"""
Management command to generate demo data for {{ app_name }}.

Usage:
    python manage.py demo_{{ app_name }}
    python manage.py demo_{{ app_name }} --count=50

Generated by dual-apps v{{ version }}
"""

from django.core.management.base import BaseCommand, CommandError
from django.contrib.auth import get_user_model
from django.db import transaction

from {{ app_name }}.models import {{ model_name }}


User = get_user_model()


class Command(BaseCommand):
    """Generate demo data for {{ app_name }}."""

    help = 'Generate demo {{ model_name }} data for development/testing'

    def add_arguments(self, parser):
        """Add command arguments."""
        parser.add_argument(
            '--count',
            type=int,
            default=10,
            help='Number of demo items to create (default: 10)'
        )
        parser.add_argument(
            '--user',
            type=str,
            default=None,
            help='Username for owner (creates if not exists)'
        )
        parser.add_argument(
            '--clear',
            action='store_true',
            help='Clear existing data before creating'
        )

    @transaction.atomic
    def handle(self, *args, **options):
        """Execute the command."""
        count = options['count']
        username = options['user'] or 'demo_user'
        clear = options['clear']

        # Get or create user
        user, created = User.objects.get_or_create(
            username=username,
            defaults={
                'email': f'{username}@example.com',
                'is_active': True,
            }
        )
        if created:
            user.set_password('demo123')
            user.save()
            self.stdout.write(
                self.style.SUCCESS(f'Created user: {username} (password: demo123)')
            )

        # Clear existing data if requested
        if clear:
            deleted_count, _ = {{ model_name }}.objects.filter(owner=user).delete()
            self.stdout.write(
                self.style.WARNING(f'Deleted {deleted_count} existing items')
            )

        # Demo data templates
        demo_items = [
            {
                'title': f'Demo {{ model_name }} #{i+1}',
                'description': f'This is a demo item #{i+1} created by dual-apps generator. '
                              f'It showcases the dual-layer architecture with both '
                              f'frontend (HTMX) and API (DRF) access.',
                'status': ['draft', 'active', 'active', 'active', 'archived'][i % 5],
                'is_active': i % 5 != 4,  # archived items are inactive
            }
            for i in range(count)
        ]

        # Bulk create
        items = [
            {{ model_name }}(owner=user, **data)
            for data in demo_items
        ]
        created_items = {{ model_name }}.objects.bulk_create(items)

        self.stdout.write(
            self.style.SUCCESS(f'Created {len(created_items)} demo {{ model_name }} items')
        )

        # Summary
        self.stdout.write('\n' + '=' * 50)
        self.stdout.write(self.style.SUCCESS('Demo data created successfully!'))
        self.stdout.write(f'\nAccess URLs:')
        self.stdout.write(f'  Frontend: http://localhost:8000/{{ app_name }}/')
        self.stdout.write(f'  API:      http://localhost:8000/api/v1/{{ app_name }}/{{ model_name_kebab }}s/')
        self.stdout.write(f'\nLogin with:')
        self.stdout.write(f'  Username: {username}')
        self.stdout.write(f'  Password: demo123')
        self.stdout.write('=' * 50 + '\n')
