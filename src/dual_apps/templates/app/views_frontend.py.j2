"""
Frontend views for {{ app_name }} app.

HTMX-powered template views following the dual-layer convention:
- List view with search, filter, pagination
- Detail view
- Create/Update forms
- Delete confirmation
- Inline HTMX partials

Generated by dual-apps v{{ version }}

URL Patterns:
    GET  /{{ app_name }}/                          List all
    GET  /{{ app_name }}/<uuid:pk>/                Detail view
    GET  /{{ app_name }}/create/                   Create form
    POST /{{ app_name }}/create/                   Create submit
    GET  /{{ app_name }}/<uuid:pk>/edit/           Edit form
    POST /{{ app_name }}/<uuid:pk>/edit/           Edit submit
    POST /{{ app_name }}/<uuid:pk>/delete/         Delete action
"""

from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.http import HttpRequest, HttpResponse
from django.db.models import Q
from django.views.decorators.http import require_http_methods, require_POST

from {{ app_name }}.models import {{ model_name }}
from {{ app_name }}.forms import {{ model_name }}Form


{% if auth_required %}
@login_required
{% endif %}
def {{ model_name_snake }}_list(request: HttpRequest) -> HttpResponse:
    """
    List view with search, filter, and pagination.

    Template: {{ app_name }}/list.html
    HTMX: Returns partial for infinite scroll

    Query params:
        ?search=keyword     Search in title, description
        ?status=active      Filter by status
        ?page=2             Pagination
    """
    queryset = {{ model_name }}.objects.select_related('owner').filter(is_active=True)

    # Search
    search = request.GET.get('search', '').strip()
    if search:
        queryset = queryset.filter(
            Q(title__icontains=search) | Q(description__icontains=search)
        )

    # Filter by status
    status_filter = request.GET.get('status', '')
    if status_filter:
        queryset = queryset.filter(status=status_filter)

    # Filter by owner (own items only)
    if request.GET.get('mine') == '1' and request.user.is_authenticated:
        queryset = queryset.filter(owner=request.user)

    # Pagination
    paginator = Paginator(queryset, 20)
    page_number = request.GET.get('page', 1)
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'status_filter': status_filter,
        'status_choices': {{ model_name }}._meta.get_field('status').choices,
    }

    # HTMX partial response for infinite scroll
    if request.headers.get('HX-Request'):
        return render(request, '{{ app_name }}/partials/item_row.html', context)

    return render(request, '{{ app_name }}/list.html', context)


{% if auth_required %}
@login_required
{% endif %}
def {{ model_name_snake }}_detail(request: HttpRequest, pk) -> HttpResponse:
    """
    Detail view for a single {{ model_name }}.

    Template: {{ app_name }}/detail.html
    """
    obj = get_object_or_404(
        {{ model_name }}.objects.select_related('owner'),
        pk=pk,
        is_active=True
    )

    # Check if user can edit
    can_edit = request.user.is_authenticated and (
        obj.owner == request.user or request.user.is_staff
    )

    context = {
        'object': obj,
        'can_edit': can_edit,
    }

    return render(request, '{{ app_name }}/detail.html', context)


@login_required
def {{ model_name_snake }}_create(request: HttpRequest) -> HttpResponse:
    """
    Create form for {{ model_name }}.

    Template: {{ app_name }}/form.html
    POST: Creates object and redirects to list
    """
    if request.method == 'POST':
        form = {{ model_name }}Form(request.POST)
        if form.is_valid():
            obj = form.save(commit=False)
            obj.owner = request.user
            obj.save()
            messages.success(request, '{{ model_name }} created successfully!')

            # HTMX response
            if request.headers.get('HX-Request'):
                response = HttpResponse(status=204)
                response['HX-Redirect'] = obj.get_absolute_url()
                return response

            return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_list')
    else:
        form = {{ model_name }}Form()

    context = {
        'form': form,
        'action': 'Create',
    }

    return render(request, '{{ app_name }}/form.html', context)


@login_required
def {{ model_name_snake }}_edit(request: HttpRequest, pk) -> HttpResponse:
    """
    Edit form for {{ model_name }}.

    Template: {{ app_name }}/form.html
    Only owner or staff can edit.
    """
    obj = get_object_or_404({{ model_name }}, pk=pk)

    # Permission check
    if obj.owner != request.user and not request.user.is_staff:
        messages.error(request, 'You do not have permission to edit this item.')
        return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_detail', pk=pk)

    if request.method == 'POST':
        form = {{ model_name }}Form(request.POST, instance=obj)
        if form.is_valid():
            form.save()
            messages.success(request, '{{ model_name }} updated successfully!')

            # HTMX response
            if request.headers.get('HX-Request'):
                response = HttpResponse(status=204)
                response['HX-Redirect'] = obj.get_absolute_url()
                return response

            return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_detail', pk=pk)
    else:
        form = {{ model_name }}Form(instance=obj)

    context = {
        'form': form,
        'object': obj,
        'action': 'Edit',
    }

    return render(request, '{{ app_name }}/form.html', context)


@login_required
@require_POST
def {{ model_name_snake }}_delete(request: HttpRequest, pk) -> HttpResponse:
    """
    Delete {{ model_name }} (soft delete).

    POST only. Only owner or staff can delete.
    Uses soft delete (is_active=False).
    """
    obj = get_object_or_404({{ model_name }}, pk=pk)

    # Permission check
    if obj.owner != request.user and not request.user.is_staff:
        messages.error(request, 'You do not have permission to delete this item.')
        return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_detail', pk=pk)

    # Soft delete
    obj.soft_delete()
    messages.success(request, '{{ model_name }} deleted successfully!')

    # HTMX response
    if request.headers.get('HX-Request'):
        response = HttpResponse(status=204)
        response['HX-Redirect'] = '/{{ app_name }}/'
        return response

    return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_list')


@login_required
@require_POST
def {{ model_name_snake }}_archive(request: HttpRequest, pk) -> HttpResponse:
    """
    Archive {{ model_name }}.

    POST only. Sets status to 'archived'.
    """
    obj = get_object_or_404({{ model_name }}, pk=pk)

    # Permission check
    if obj.owner != request.user and not request.user.is_staff:
        messages.error(request, 'You do not have permission to archive this item.')
        return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_detail', pk=pk)

    obj.status = 'archived'
    obj.save(update_fields=['status', 'updated_at'])
    messages.success(request, '{{ model_name }} archived successfully!')

    # HTMX response
    if request.headers.get('HX-Request'):
        return render(request, '{{ app_name }}/partials/item_row.html', {'object': obj})

    return redirect('frontend:{{ app_name }}:{{ model_name_snake }}_detail', pk=pk)
