"""
Permission tests for {{ project_name }}.
Generated by dual-apps v{{ version }}

Tests object-level permissions across all apps.
"""

import pytest
from django.contrib.auth import get_user_model

User = get_user_model()


{% for app in apps_config %}
class Test{{ app.name_pascal }}Permissions:
    """Permission tests for {{ app.name_title }}."""

    def test_owner_has_full_access(self, auth_api_client, {{ app.name }}_instance, user):
        """Test owner has full CRUD access."""
        instance = {{ app.name }}_instance
        # Read
        response = auth_api_client.get(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 200

        # Update
        response = auth_api_client.patch(
            f"/api/v1/{{ app.name }}/{instance.id}/",
            {"title": "Updated"}
        )
        assert response.status_code == 200

        # Delete
        response = auth_api_client.delete(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 204

    def test_non_owner_read_only(self, api_client, {{ app.name }}_instance, db):
        """Test non-owner has read-only access."""
        instance = {{ app.name }}_instance
        other_user = User.objects.create_user(
            username="other_{{ app.name }}",
            password="otherpass123"
        )
        api_client.force_authenticate(user=other_user)

        # Read - allowed
        response = api_client.get(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 200

        # Update - denied
        response = api_client.patch(
            f"/api/v1/{{ app.name }}/{instance.id}/",
            {"title": "Hacked"}
        )
        assert response.status_code == 403

        # Delete - denied
        response = api_client.delete(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 403

    def test_unauthenticated_read_only(self, api_client, {{ app.name }}_instance):
        """Test unauthenticated users have read-only access."""
        instance = {{ app.name }}_instance
        # Read - allowed
        response = api_client.get(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 200

        # Create - denied
        response = api_client.post("/api/v1/{{ app.name }}/", {"title": "Test"})
        assert response.status_code in [401, 403]

        # Update - denied
        response = api_client.patch(
            f"/api/v1/{{ app.name }}/{instance.id}/",
            {"title": "Hacked"}
        )
        assert response.status_code in [401, 403]

    def test_admin_has_full_access(self, admin_api_client, {{ app.name }}_instance):
        """Test admin has full access to all objects."""
        instance = {{ app.name }}_instance
        # Read
        response = admin_api_client.get(f"/api/v1/{{ app.name }}/{instance.id}/")
        assert response.status_code == 200

        # Update
        response = admin_api_client.patch(
            f"/api/v1/{{ app.name }}/{instance.id}/",
            {"title": "Admin Updated"}
        )
        # Admin may or may not have permission depending on implementation
        assert response.status_code in [200, 403]

{% endfor %}

class TestCrossAppPermissions:
    """Test permission consistency across apps."""

    def test_user_isolated_data(self, api_client, db):
        """Test users only see their own data in filtered views."""
        user1 = User.objects.create_user(username="user1", password="pass1")
        user2 = User.objects.create_user(username="user2", password="pass2")

        {% for app in apps_config %}
        from apps.{{ app.name }}.models import {{ app.name_pascal }}

        # Create items for user1
        item1 = {{ app.name_pascal }}.objects.create(
            owner=user1,
            title="User1 {{ app.name_title }}"
        )

        # Create items for user2
        item2 = {{ app.name_pascal }}.objects.create(
            owner=user2,
            title="User2 {{ app.name_title }}"
        )

        # User1 can see both (read-only for public)
        api_client.force_authenticate(user=user1)
        response = api_client.get("/api/v1/{{ app.name }}/")
        assert response.status_code == 200

        # User1 cannot modify user2's item
        response = api_client.patch(f"/api/v1/{{ app.name }}/{item2.id}/", {"title": "Hacked"})
        assert response.status_code == 403

        {% endfor %}

    def test_permission_class_applied(self):
        """Test permission classes are correctly applied to viewsets."""
        {% for app in apps_config %}
        from apps.{{ app.name }}.views_api import {{ app.name_pascal }}ViewSet
        from apps.{{ app.name }}.permissions import IsOwnerOrReadOnly

        assert IsOwnerOrReadOnly in {{ app.name_pascal }}ViewSet.permission_classes
        {% endfor %}
