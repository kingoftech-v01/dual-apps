"""
Model tests for {{ app_name }}.

Tests:
- Model creation
- Field validation
- Methods (soft_delete, get_absolute_url)
- Querysets

Generated by dual-apps v{{ version }}
"""

import pytest
from django.core.exceptions import ValidationError
from django.db import IntegrityError

from {{ app_name }}.models import {{ model_name }}


class Test{{ model_name }}Model:
    """Tests for {{ model_name }} model."""

    def test_create_{{ model_name_snake }}(self, regular_user):
        """Test creating a {{ model_name }}."""
        obj = {{ model_name }}.objects.create(
            title='Test Title',
            description='Test Description',
            status='draft',
            owner=regular_user,
        )
        assert obj.id is not None
        assert obj.title == 'Test Title'
        assert obj.owner == regular_user
        assert obj.is_active is True

    def test_{{ model_name_snake }}_str(self, {{ model_name_snake }}):
        """Test string representation."""
        assert str({{ model_name_snake }}) == {{ model_name_snake }}.title

    def test_{{ model_name_snake }}_uuid_pk(self, {{ model_name_snake }}):
        """Test that primary key is UUID."""
        import uuid
        assert isinstance({{ model_name_snake }}.id, uuid.UUID)

    def test_{{ model_name_snake }}_auto_timestamps(self, {{ model_name_snake }}):
        """Test automatic timestamp fields."""
        assert {{ model_name_snake }}.created_at is not None
        assert {{ model_name_snake }}.updated_at is not None
        assert {{ model_name_snake }}.created_at <= {{ model_name_snake }}.updated_at

    def test_{{ model_name_snake }}_soft_delete(self, {{ model_name_snake }}):
        """Test soft delete method."""
        assert {{ model_name_snake }}.is_active is True
        {{ model_name_snake }}.soft_delete()
        {{ model_name_snake }}.refresh_from_db()
        assert {{ model_name_snake }}.is_active is False

    def test_{{ model_name_snake }}_get_absolute_url(self, {{ model_name_snake }}):
        """Test get_absolute_url method."""
        url = {{ model_name_snake }}.get_absolute_url()
        assert '{{ app_name }}' in url
        assert str({{ model_name_snake }}.id) in url

    def test_{{ model_name_snake }}_owner_required(self, db):
        """Test that owner is required."""
        with pytest.raises(IntegrityError):
            {{ model_name }}.objects.create(
                title='No Owner',
                status='draft',
            )

    def test_{{ model_name_snake }}_status_choices(self, regular_user):
        """Test status field choices."""
        for status in ['draft', 'active', 'archived']:
            obj = {{ model_name }}.objects.create(
                title=f'Status {status}',
                status=status,
                owner=regular_user,
            )
            assert obj.status == status

    def test_{{ model_name_snake }}_active_objects(self, {{ model_name_snake }}_list):
        """Test active_objects class method."""
        active_count = {{ model_name }}.active_objects().count()
        all_count = {{ model_name }}.objects.count()
        assert active_count < all_count
        assert all(obj.is_active for obj in {{ model_name }}.active_objects())

    def test_{{ model_name_snake }}_ordering(self, {{ model_name_snake }}_list):
        """Test default ordering is by -created_at."""
        items = list({{ model_name }}.objects.all()[:5])
        assert items == sorted(items, key=lambda x: x.created_at, reverse=True)

    def test_{{ model_name_snake }}_related_name(self, regular_user, {{ model_name_snake }}):
        """Test reverse relation from User to {{ model_name }}."""
        assert {{ model_name_snake }} in regular_user.{{ model_name_snake }}s.all()


class Test{{ model_name }}QuerySet:
    """Tests for {{ model_name }} queryset optimizations."""

    def test_select_related_owner(self, {{ model_name_snake }}_list):
        """Test that queryset uses select_related."""
        from django.db import connection
        from django.test.utils import CaptureQueriesContext

        with CaptureQueriesContext(connection) as context:
            items = list({{ model_name }}.objects.select_related('owner').all()[:10])
            _ = [item.owner.username for item in items]

        # Should be 1 query with select_related
        assert len(context) == 1

    def test_filter_by_owner(self, {{ model_name_snake }}_list, regular_user, other_user_{{ model_name_snake }}):
        """Test filtering by owner."""
        own_items = {{ model_name }}.objects.filter(owner=regular_user)
        assert all(item.owner == regular_user for item in own_items)

    def test_filter_by_status(self, {{ model_name_snake }}_list):
        """Test filtering by status."""
        active_items = {{ model_name }}.objects.filter(status='active')
        assert all(item.status == 'active' for item in active_items)
