"""
Permission tests for {{ app_name }}.

Tests:
- IsOwnerOrReadOnly
- Staff permissions
- Anonymous access
- Cross-user access

Generated by dual-apps v{{ version }}
"""

import pytest
from rest_framework import status


class TestIsOwnerOrReadOnlyPermission:
    """Tests for IsOwnerOrReadOnly permission class."""

    def test_owner_can_read(self, authenticated_client, {{ model_name_snake }}):
        """Test owner can read own item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.get(url)
        assert response.status_code == status.HTTP_200_OK

    def test_owner_can_update(self, authenticated_client, {{ model_name_snake }}):
        """Test owner can update own item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.patch(url, {'title': 'Updated'})
        assert response.status_code == status.HTTP_200_OK

    def test_owner_can_delete(self, authenticated_client, {{ model_name_snake }}):
        """Test owner can delete own item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.delete(url)
        assert response.status_code == status.HTTP_204_NO_CONTENT

    def test_other_user_can_read(self, authenticated_client, other_user_{{ model_name_snake }}):
        """Test other user can read active item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = authenticated_client.get(url)
        assert response.status_code == status.HTTP_200_OK

    def test_other_user_cannot_update(self, authenticated_client, other_user_{{ model_name_snake }}):
        """Test other user cannot update."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = authenticated_client.patch(url, {'title': 'Hacked'})
        assert response.status_code == status.HTTP_403_FORBIDDEN

    def test_other_user_cannot_delete(self, authenticated_client, other_user_{{ model_name_snake }}):
        """Test other user cannot delete."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = authenticated_client.delete(url)
        assert response.status_code == status.HTTP_403_FORBIDDEN


class TestStaffPermissions:
    """Tests for staff user permissions."""

    def test_staff_can_read_any(self, staff_client, other_user_{{ model_name_snake }}):
        """Test staff can read any item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = staff_client.get(url)
        assert response.status_code == status.HTTP_200_OK

    def test_staff_can_update_any(self, staff_client, other_user_{{ model_name_snake }}):
        """Test staff can update any item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = staff_client.patch(url, {'title': 'Staff Edit'})
        assert response.status_code == status.HTTP_200_OK

    def test_staff_can_delete_any(self, staff_client, other_user_{{ model_name_snake }}):
        """Test staff can delete any item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = staff_client.delete(url)
        assert response.status_code == status.HTTP_204_NO_CONTENT

    def test_staff_sees_all_items(self, staff_client, {{ model_name_snake }}_list, other_user_{{ model_name_snake }}):
        """Test staff sees all items in list."""
        response = staff_client.get('/api/v1/{{ app_name }}/{{ model_name_kebab }}s/')
        assert response.status_code == status.HTTP_200_OK
        ids = [item['id'] for item in response.data['results']]
        assert str(other_user_{{ model_name_snake }}.id) in ids


class TestAnonymousAccess:
    """Tests for anonymous user access."""

    {% if auth_required %}
    def test_anonymous_cannot_list(self, api_client):
        """Test anonymous cannot access list."""
        response = api_client.get('/api/v1/{{ app_name }}/{{ model_name_kebab }}s/')
        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_anonymous_cannot_create(self, api_client):
        """Test anonymous cannot create."""
        response = api_client.post('/api/v1/{{ app_name }}/{{ model_name_kebab }}s/', {'title': 'Test'})
        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_anonymous_cannot_read(self, api_client, {{ model_name_snake }}):
        """Test anonymous cannot read detail."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = api_client.get(url)
        assert response.status_code == status.HTTP_401_UNAUTHORIZED
    {% else %}
    def test_anonymous_can_list(self, api_client, {{ model_name_snake }}_list):
        """Test anonymous can access public list."""
        response = api_client.get('/api/v1/{{ app_name }}/{{ model_name_kebab }}s/')
        assert response.status_code == status.HTTP_200_OK

    def test_anonymous_cannot_create(self, api_client):
        """Test anonymous cannot create."""
        response = api_client.post('/api/v1/{{ app_name }}/{{ model_name_kebab }}s/', {'title': 'Test'})
        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_anonymous_can_read_active(self, api_client, {{ model_name_snake }}):
        """Test anonymous can read active items."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = api_client.get(url)
        assert response.status_code == status.HTTP_200_OK
    {% endif %}


class TestOwnershipInvariant:
    """Tests for ownership security invariants."""

    def test_owner_cannot_be_changed(self, authenticated_client, {{ model_name_snake }}, other_user):
        """Test owner field cannot be changed via API."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.patch(url, {'owner': other_user.id})
        # Owner should remain unchanged (field is read-only)
        {{ model_name_snake }}.refresh_from_db()
        assert {{ model_name_snake }}.owner != other_user

    def test_create_respects_authenticated_owner(self, authenticated_client, regular_user, other_user):
        """Test create always sets owner to authenticated user."""
        response = authenticated_client.post(
            '/api/v1/{{ app_name }}/{{ model_name_kebab }}s/',
            {'title': 'Test', 'status': 'draft', 'owner': other_user.id}
        )
        assert response.status_code == status.HTTP_201_CREATED
        # Owner should be the authenticated user, not the submitted one
        assert response.data['owner']['id'] == regular_user.id
