"""
API tests for {{ app_name }}.

Tests all API endpoints:
- List, Create, Retrieve, Update, Delete
- Custom actions (archive, publish, duplicate)
- Filtering, search, pagination
- Permissions

Generated by dual-apps v{{ version }}
"""

import pytest
from rest_framework import status


class Test{{ model_name }}APIList:
    """Tests for {{ model_name }} API list endpoint."""

    def test_list_unauthenticated(self, api_client, api_list_url, {{ model_name_snake }}_list):
        """Test list endpoint without authentication."""
        response = api_client.get(api_list_url)
        {% if auth_required %}
        assert response.status_code == status.HTTP_401_UNAUTHORIZED
        {% else %}
        assert response.status_code == status.HTTP_200_OK
        {% endif %}

    def test_list_authenticated(self, authenticated_client, api_list_url, {{ model_name_snake }}_list):
        """Test list endpoint with authentication."""
        response = authenticated_client.get(api_list_url)
        assert response.status_code == status.HTTP_200_OK
        assert 'results' in response.data

    def test_list_pagination(self, authenticated_client, api_list_url, {{ model_name_snake }}_list):
        """Test list pagination."""
        response = authenticated_client.get(api_list_url)
        assert response.status_code == status.HTTP_200_OK
        assert 'count' in response.data
        assert 'next' in response.data
        assert 'previous' in response.data

    def test_list_search(self, authenticated_client, api_list_url, {{ model_name_snake }}_list):
        """Test list search functionality."""
        response = authenticated_client.get(f'{api_list_url}?search=Test')
        assert response.status_code == status.HTTP_200_OK
        assert all('Test' in item['title'] for item in response.data['results'])

    def test_list_filter_status(self, authenticated_client, api_list_url, {{ model_name_snake }}_list):
        """Test list status filter."""
        response = authenticated_client.get(f'{api_list_url}?status=active')
        assert response.status_code == status.HTTP_200_OK
        assert all(item['status'] == 'active' for item in response.data['results'])


class Test{{ model_name }}APICreate:
    """Tests for {{ model_name }} API create endpoint."""

    def test_create_unauthenticated(self, api_client, api_list_url):
        """Test create without authentication."""
        data = {'title': 'New Item', 'status': 'draft'}
        response = api_client.post(api_list_url, data)
        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_create_authenticated(self, authenticated_client, api_list_url):
        """Test create with authentication."""
        data = {'title': 'New Item', 'description': 'Test', 'status': 'draft'}
        response = authenticated_client.post(api_list_url, data)
        assert response.status_code == status.HTTP_201_CREATED
        assert response.data['title'] == 'New Item'

    def test_create_auto_owner(self, authenticated_client, api_list_url, regular_user):
        """Test that owner is automatically set."""
        data = {'title': 'New Item', 'status': 'draft'}
        response = authenticated_client.post(api_list_url, data)
        assert response.status_code == status.HTTP_201_CREATED
        assert response.data['owner']['id'] == regular_user.id

    def test_create_validation_error(self, authenticated_client, api_list_url):
        """Test validation errors on create."""
        data = {'title': 'AB', 'status': 'draft'}  # Title too short
        response = authenticated_client.post(api_list_url, data)
        assert response.status_code == status.HTTP_400_BAD_REQUEST


class Test{{ model_name }}APIRetrieve:
    """Tests for {{ model_name }} API retrieve endpoint."""

    def test_retrieve(self, authenticated_client, {{ model_name_snake }}):
        """Test retrieve single item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.get(url)
        assert response.status_code == status.HTTP_200_OK
        assert response.data['id'] == str({{ model_name_snake }}.id)

    def test_retrieve_not_found(self, authenticated_client):
        """Test retrieve non-existent item."""
        import uuid
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{uuid.uuid4()}/'
        response = authenticated_client.get(url)
        assert response.status_code == status.HTTP_404_NOT_FOUND


class Test{{ model_name }}APIUpdate:
    """Tests for {{ model_name }} API update endpoint."""

    def test_update_own(self, authenticated_client, {{ model_name_snake }}):
        """Test update own item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        data = {'title': 'Updated Title'}
        response = authenticated_client.patch(url, data)
        assert response.status_code == status.HTTP_200_OK
        assert response.data['title'] == 'Updated Title'

    def test_update_other_user_forbidden(self, authenticated_client, other_user_{{ model_name_snake }}):
        """Test cannot update other user's item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        data = {'title': 'Updated Title'}
        response = authenticated_client.patch(url, data)
        assert response.status_code == status.HTTP_403_FORBIDDEN

    def test_update_staff_can_edit_any(self, staff_client, other_user_{{ model_name_snake }}):
        """Test staff can update any item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        data = {'title': 'Staff Updated'}
        response = staff_client.patch(url, data)
        assert response.status_code == status.HTTP_200_OK


class Test{{ model_name }}APIDelete:
    """Tests for {{ model_name }} API delete endpoint."""

    def test_delete_own(self, authenticated_client, {{ model_name_snake }}):
        """Test delete own item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/'
        response = authenticated_client.delete(url)
        assert response.status_code == status.HTTP_204_NO_CONTENT

    def test_delete_other_user_forbidden(self, authenticated_client, other_user_{{ model_name_snake }}):
        """Test cannot delete other user's item."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{other_user_{{ model_name_snake }}.id}/'
        response = authenticated_client.delete(url)
        assert response.status_code == status.HTTP_403_FORBIDDEN


class Test{{ model_name }}APICustomActions:
    """Tests for {{ model_name }} API custom actions."""

    def test_archive_action(self, authenticated_client, {{ model_name_snake }}):
        """Test archive custom action."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/archive/'
        response = authenticated_client.post(url)
        assert response.status_code == status.HTTP_200_OK
        assert response.data['status'] == 'archived'

    def test_publish_action(self, authenticated_client, {{ model_name_snake }}_draft):
        """Test publish custom action."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}_draft.id{{"}"}}/publish/'
        response = authenticated_client.post(url)
        assert response.status_code == status.HTTP_200_OK
        assert response.data['status'] == 'published'

    def test_duplicate_action(self, authenticated_client, {{ model_name_snake }}):
        """Test duplicate custom action."""
        url = f'/api/v1/{{ app_name }}/{{ model_name_kebab }}s/{{"{"}}{{ model_name_snake }}.id{{"}"}}/duplicate/'
        response = authenticated_client.post(url)
        assert response.status_code == status.HTTP_201_CREATED
        assert response.data['id'] != str({{ model_name_snake }}.id)
        assert response.data['status'] == 'draft'

    def test_my_items_action(self, authenticated_client, {{ model_name_snake }}_list, other_user_{{ model_name_snake }}):
        """Test my_items custom action."""
        url = '/api/v1/{{ app_name }}/{{ model_name_kebab }}s/my_items/'
        response = authenticated_client.get(url)
        assert response.status_code == status.HTTP_200_OK
        # Should not include other user's items
        ids = [item['id'] for item in response.data['results']]
        assert str(other_user_{{ model_name_snake }}.id) not in ids
