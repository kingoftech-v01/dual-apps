"""
Authentication views for {{ project_name }}.
Generated by dual-apps v{{ version }}
"""

from django.contrib.auth import get_user_model
from django.utils import timezone
from rest_framework import status, generics, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
{% if auth_type == 'jwt' %}
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView
from rest_framework_simplejwt.tokens import RefreshToken
{% endif %}
from drf_spectacular.utils import extend_schema, OpenApiResponse

from .serializers import (
    UserSerializer,
    UserCreateSerializer,
    PasswordChangeSerializer,
    PasswordResetRequestSerializer,
    PasswordResetConfirmSerializer,
    EmailVerificationSerializer,
{% if auth_type == 'jwt' %}
    CustomTokenObtainPairSerializer,
{% endif %}
)

User = get_user_model()


@extend_schema(tags=["Authentication"])
class RegisterView(generics.CreateAPIView):
    """
    Register a new user account.

    Creates a new user and sends verification email.
    """
    queryset = User.objects.all()
    serializer_class = UserCreateSerializer
    permission_classes = [permissions.AllowAny]

    @extend_schema(
        summary="Register new user",
        responses={
            201: UserSerializer,
            400: OpenApiResponse(description="Validation error"),
        }
    )
    def post(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        user = serializer.save()

        # TODO: Send verification email
        # send_verification_email(user)

        return Response(
            {
                "message": "Registration successful. Please verify your email.",
                "user": UserSerializer(user).data,
            },
            status=status.HTTP_201_CREATED
        )


{% if auth_type == 'jwt' %}
@extend_schema(tags=["Authentication"])
class LoginView(TokenObtainPairView):
    """
    Obtain JWT token pair (access + refresh).

    Returns access token, refresh token, and user info.
    """
    serializer_class = CustomTokenObtainPairSerializer

    @extend_schema(
        summary="Login with email and password",
        responses={
            200: OpenApiResponse(description="Token pair with user info"),
            401: OpenApiResponse(description="Invalid credentials"),
        }
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)


@extend_schema(tags=["Authentication"])
class LogoutView(APIView):
    """
    Logout user by blacklisting refresh token.
    """
    permission_classes = [permissions.IsAuthenticated]

    @extend_schema(
        summary="Logout user",
        responses={
            200: OpenApiResponse(description="Successfully logged out"),
            400: OpenApiResponse(description="Invalid token"),
        }
    )
    def post(self, request):
        try:
            refresh_token = request.data.get("refresh")
            if refresh_token:
                token = RefreshToken(refresh_token)
                token.blacklist()
            return Response(
                {"message": "Successfully logged out."},
                status=status.HTTP_200_OK
            )
        except Exception:
            return Response(
                {"error": "Invalid token."},
                status=status.HTTP_400_BAD_REQUEST
            )


@extend_schema(tags=["Authentication"])
class TokenRefreshView(TokenRefreshView):
    """
    Refresh access token using refresh token.
    """
    @extend_schema(
        summary="Refresh access token",
        responses={
            200: OpenApiResponse(description="New access token"),
            401: OpenApiResponse(description="Invalid refresh token"),
        }
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)
{% else %}
from django.contrib.auth import authenticate, login, logout

@extend_schema(tags=["Authentication"])
class LoginView(APIView):
    """
    Login with session authentication.
    """
    permission_classes = [permissions.AllowAny]

    @extend_schema(
        summary="Login with email and password",
        responses={
            200: UserSerializer,
            401: OpenApiResponse(description="Invalid credentials"),
        }
    )
    def post(self, request):
        email = request.data.get("email")
        password = request.data.get("password")

        user = authenticate(request, username=email, password=password)

        if user is not None:
            login(request, user)
            return Response(UserSerializer(user).data)

        return Response(
            {"error": "Invalid credentials."},
            status=status.HTTP_401_UNAUTHORIZED
        )


@extend_schema(tags=["Authentication"])
class LogoutView(APIView):
    """
    Logout user (session).
    """
    permission_classes = [permissions.IsAuthenticated]

    @extend_schema(
        summary="Logout user",
        responses={200: OpenApiResponse(description="Successfully logged out")}
    )
    def post(self, request):
        logout(request)
        return Response({"message": "Successfully logged out."})
{% endif %}


@extend_schema(tags=["Authentication"])
class MeView(generics.RetrieveUpdateAPIView):
    """
    Get or update current user profile.
    """
    serializer_class = UserSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_object(self):
        return self.request.user

    @extend_schema(summary="Get current user")
    def get(self, request, *args, **kwargs):
        return super().get(request, *args, **kwargs)

    @extend_schema(summary="Update current user")
    def patch(self, request, *args, **kwargs):
        return super().patch(request, *args, **kwargs)


@extend_schema(tags=["Authentication"])
class PasswordChangeView(APIView):
    """
    Change password for authenticated user.
    """
    permission_classes = [permissions.IsAuthenticated]

    @extend_schema(
        summary="Change password",
        request=PasswordChangeSerializer,
        responses={
            200: OpenApiResponse(description="Password changed successfully"),
            400: OpenApiResponse(description="Validation error"),
        }
    )
    def post(self, request):
        serializer = PasswordChangeSerializer(
            data=request.data,
            context={"request": request}
        )
        serializer.is_valid(raise_exception=True)

        request.user.set_password(serializer.validated_data["new_password"])
        request.user.save()

        return Response({"message": "Password changed successfully."})


@extend_schema(tags=["Authentication"])
class PasswordResetRequestView(APIView):
    """
    Request password reset email.
    """
    permission_classes = [permissions.AllowAny]

    @extend_schema(
        summary="Request password reset",
        request=PasswordResetRequestSerializer,
        responses={
            200: OpenApiResponse(description="Reset email sent if account exists"),
        }
    )
    def post(self, request):
        serializer = PasswordResetRequestSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        email = serializer.validated_data["email"]
        user = User.objects.filter(email=email).first()

        if user:
            # TODO: Generate token and send email
            # token = generate_reset_token(user)
            # send_reset_email(user, token)
            pass

        # Always return success to prevent email enumeration
        return Response({
            "message": "If an account exists with this email, a reset link has been sent."
        })


@extend_schema(tags=["Authentication"])
class PasswordResetConfirmView(APIView):
    """
    Confirm password reset with token.
    """
    permission_classes = [permissions.AllowAny]

    @extend_schema(
        summary="Confirm password reset",
        request=PasswordResetConfirmSerializer,
        responses={
            200: OpenApiResponse(description="Password reset successfully"),
            400: OpenApiResponse(description="Invalid or expired token"),
        }
    )
    def post(self, request):
        serializer = PasswordResetConfirmSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        # TODO: Validate token and reset password
        # user = validate_reset_token(serializer.validated_data["token"])
        # user.set_password(serializer.validated_data["password"])
        # user.save()

        return Response({"message": "Password reset successfully."})


@extend_schema(tags=["Authentication"])
class EmailVerificationView(APIView):
    """
    Verify email address with token.
    """
    permission_classes = [permissions.AllowAny]

    @extend_schema(
        summary="Verify email",
        request=EmailVerificationSerializer,
        responses={
            200: OpenApiResponse(description="Email verified successfully"),
            400: OpenApiResponse(description="Invalid or expired token"),
        }
    )
    def post(self, request):
        serializer = EmailVerificationSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        # TODO: Validate token and verify email
        # user = validate_email_token(serializer.validated_data["token"])
        # user.email_verified = True
        # user.email_verified_at = timezone.now()
        # user.save()

        return Response({"message": "Email verified successfully."})


@extend_schema(tags=["Authentication"])
class ResendVerificationView(APIView):
    """
    Resend email verification link.
    """
    permission_classes = [permissions.IsAuthenticated]

    @extend_schema(
        summary="Resend verification email",
        responses={
            200: OpenApiResponse(description="Verification email sent"),
            400: OpenApiResponse(description="Email already verified"),
        }
    )
    def post(self, request):
        user = request.user

        if user.email_verified:
            return Response(
                {"error": "Email already verified."},
                status=status.HTTP_400_BAD_REQUEST
            )

        # TODO: Send verification email
        # send_verification_email(user)

        return Response({"message": "Verification email sent."})
