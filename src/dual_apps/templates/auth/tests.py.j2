"""
Authentication tests for {{ project_name }}.
Generated by dual-apps v{{ version }}
"""

import pytest
from django.contrib.auth import get_user_model
from django.urls import reverse
from rest_framework import status
from rest_framework.test import APIClient

User = get_user_model()


@pytest.fixture
def api_client():
    return APIClient()


@pytest.fixture
def user_data():
    return {
        "email": "test@example.com",
        "username": "testuser",
        "password": "TestPass123!",
        "password_confirm": "TestPass123!",
        "first_name": "Test",
        "last_name": "User",
    }


@pytest.fixture
def user(db, user_data):
    return User.objects.create_user(
        email=user_data["email"],
        username=user_data["username"],
        password=user_data["password"],
        first_name=user_data["first_name"],
        last_name=user_data["last_name"],
    )


class TestRegistration:
    """Test user registration."""

    def test_register_success(self, api_client, user_data, db):
        """Test successful registration."""
        url = reverse("auth:register")
        response = api_client.post(url, user_data)

        assert response.status_code == status.HTTP_201_CREATED
        assert "user" in response.data
        assert response.data["user"]["email"] == user_data["email"]
        assert User.objects.filter(email=user_data["email"]).exists()

    def test_register_password_mismatch(self, api_client, user_data, db):
        """Test registration with mismatched passwords."""
        user_data["password_confirm"] = "DifferentPass123!"
        url = reverse("auth:register")
        response = api_client.post(url, user_data)

        assert response.status_code == status.HTTP_400_BAD_REQUEST
        assert "password_confirm" in response.data

    def test_register_duplicate_email(self, api_client, user_data, user):
        """Test registration with existing email."""
        url = reverse("auth:register")
        response = api_client.post(url, user_data)

        assert response.status_code == status.HTTP_400_BAD_REQUEST

    def test_register_weak_password(self, api_client, user_data, db):
        """Test registration with weak password."""
        user_data["password"] = "123"
        user_data["password_confirm"] = "123"
        url = reverse("auth:register")
        response = api_client.post(url, user_data)

        assert response.status_code == status.HTTP_400_BAD_REQUEST


class TestLogin:
    """Test user login."""

    def test_login_success(self, api_client, user, user_data):
        """Test successful login."""
        url = reverse("auth:login")
        response = api_client.post(url, {
            "email": user_data["email"],
            "password": user_data["password"],
        })

        assert response.status_code == status.HTTP_200_OK
{% if auth_type == 'jwt' %}
        assert "access" in response.data
        assert "refresh" in response.data
        assert "user" in response.data
{% endif %}

    def test_login_invalid_credentials(self, api_client, user):
        """Test login with invalid credentials."""
        url = reverse("auth:login")
        response = api_client.post(url, {
            "email": "test@example.com",
            "password": "WrongPassword123!",
        })

        assert response.status_code == status.HTTP_401_UNAUTHORIZED

    def test_login_nonexistent_user(self, api_client, db):
        """Test login with non-existent user."""
        url = reverse("auth:login")
        response = api_client.post(url, {
            "email": "nonexistent@example.com",
            "password": "SomePass123!",
        })

        assert response.status_code == status.HTTP_401_UNAUTHORIZED


class TestLogout:
    """Test user logout."""

    def test_logout_success(self, api_client, user):
        """Test successful logout."""
        api_client.force_authenticate(user=user)
        url = reverse("auth:logout")
        response = api_client.post(url, {})

        assert response.status_code == status.HTTP_200_OK

    def test_logout_unauthenticated(self, api_client):
        """Test logout without authentication."""
        url = reverse("auth:logout")
        response = api_client.post(url, {})

        assert response.status_code == status.HTTP_401_UNAUTHORIZED


class TestMe:
    """Test user profile endpoint."""

    def test_get_me(self, api_client, user):
        """Test getting current user."""
        api_client.force_authenticate(user=user)
        url = reverse("auth:me")
        response = api_client.get(url)

        assert response.status_code == status.HTTP_200_OK
        assert response.data["email"] == user.email

    def test_update_me(self, api_client, user):
        """Test updating current user."""
        api_client.force_authenticate(user=user)
        url = reverse("auth:me")
        response = api_client.patch(url, {"first_name": "Updated"})

        assert response.status_code == status.HTTP_200_OK
        assert response.data["first_name"] == "Updated"

    def test_get_me_unauthenticated(self, api_client):
        """Test getting current user without auth."""
        url = reverse("auth:me")
        response = api_client.get(url)

        assert response.status_code == status.HTTP_401_UNAUTHORIZED


class TestPasswordChange:
    """Test password change."""

    def test_change_password_success(self, api_client, user, user_data):
        """Test successful password change."""
        api_client.force_authenticate(user=user)
        url = reverse("auth:password_change")
        response = api_client.post(url, {
            "old_password": user_data["password"],
            "new_password": "NewTestPass123!",
            "new_password_confirm": "NewTestPass123!",
        })

        assert response.status_code == status.HTTP_200_OK

    def test_change_password_wrong_old(self, api_client, user):
        """Test password change with wrong old password."""
        api_client.force_authenticate(user=user)
        url = reverse("auth:password_change")
        response = api_client.post(url, {
            "old_password": "WrongOldPass123!",
            "new_password": "NewTestPass123!",
            "new_password_confirm": "NewTestPass123!",
        })

        assert response.status_code == status.HTTP_400_BAD_REQUEST


class TestPasswordReset:
    """Test password reset flow."""

    def test_request_reset(self, api_client, user):
        """Test password reset request."""
        url = reverse("auth:password_reset")
        response = api_client.post(url, {"email": user.email})

        # Always returns 200 to prevent email enumeration
        assert response.status_code == status.HTTP_200_OK

    def test_request_reset_nonexistent_email(self, api_client, db):
        """Test password reset for non-existent email."""
        url = reverse("auth:password_reset")
        response = api_client.post(url, {"email": "nonexistent@example.com"})

        # Always returns 200 to prevent email enumeration
        assert response.status_code == status.HTTP_200_OK
