"""
OAuth2 Social Authentication for {{ project_name }}.
Generated by dual-apps v{{ version }}

Supports: Google, GitHub, Facebook, Twitter
"""

from django.conf import settings
from django.shortcuts import redirect
from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from drf_spectacular.utils import extend_schema, OpenApiParameter
import requests
{% if auth_type == 'jwt' %}
from rest_framework_simplejwt.tokens import RefreshToken
{% endif %}

from django.contrib.auth import get_user_model

User = get_user_model()


class OAuthProvider:
    """Base OAuth provider class."""

    def __init__(self):
        self.client_id = None
        self.client_secret = None
        self.redirect_uri = None
        self.authorize_url = None
        self.token_url = None
        self.user_info_url = None
        self.scope = None

    def get_authorization_url(self, state: str) -> str:
        """Get OAuth authorization URL."""
        params = {
            "client_id": self.client_id,
            "redirect_uri": self.redirect_uri,
            "scope": self.scope,
            "response_type": "code",
            "state": state,
        }
        query = "&".join(f"{k}={v}" for k, v in params.items())
        return f"{self.authorize_url}?{query}"

    def exchange_code(self, code: str) -> dict:
        """Exchange authorization code for access token."""
        response = requests.post(
            self.token_url,
            data={
                "client_id": self.client_id,
                "client_secret": self.client_secret,
                "code": code,
                "redirect_uri": self.redirect_uri,
                "grant_type": "authorization_code",
            },
            headers={"Accept": "application/json"},
        )
        return response.json()

    def get_user_info(self, access_token: str) -> dict:
        """Get user info from provider."""
        response = requests.get(
            self.user_info_url,
            headers={"Authorization": f"Bearer {access_token}"},
        )
        return response.json()


class GoogleProvider(OAuthProvider):
    """Google OAuth2 provider."""

    def __init__(self):
        super().__init__()
        self.client_id = settings.GOOGLE_CLIENT_ID
        self.client_secret = settings.GOOGLE_CLIENT_SECRET
        self.redirect_uri = settings.GOOGLE_REDIRECT_URI
        self.authorize_url = "https://accounts.google.com/o/oauth2/v2/auth"
        self.token_url = "https://oauth2.googleapis.com/token"
        self.user_info_url = "https://www.googleapis.com/oauth2/v2/userinfo"
        self.scope = "email profile"


class GitHubProvider(OAuthProvider):
    """GitHub OAuth2 provider."""

    def __init__(self):
        super().__init__()
        self.client_id = settings.GITHUB_CLIENT_ID
        self.client_secret = settings.GITHUB_CLIENT_SECRET
        self.redirect_uri = settings.GITHUB_REDIRECT_URI
        self.authorize_url = "https://github.com/login/oauth/authorize"
        self.token_url = "https://github.com/login/oauth/access_token"
        self.user_info_url = "https://api.github.com/user"
        self.scope = "user:email"

    def get_user_info(self, access_token: str) -> dict:
        """Get user info including primary email."""
        user_info = super().get_user_info(access_token)

        # Get primary email
        emails_response = requests.get(
            "https://api.github.com/user/emails",
            headers={"Authorization": f"Bearer {access_token}"},
        )
        emails = emails_response.json()
        primary_email = next(
            (e["email"] for e in emails if e["primary"]),
            emails[0]["email"] if emails else None
        )
        user_info["email"] = primary_email

        return user_info


PROVIDERS = {
    "google": GoogleProvider,
    "github": GitHubProvider,
}


def get_or_create_user(provider: str, user_info: dict) -> User:
    """Get existing user or create new one from OAuth data."""
    email = user_info.get("email")

    if not email:
        raise ValueError("Email not provided by OAuth provider")

    user, created = User.objects.get_or_create(
        email=email,
        defaults={
            "username": email.split("@")[0],
            "first_name": user_info.get("given_name", user_info.get("name", "").split()[0] if user_info.get("name") else ""),
            "last_name": user_info.get("family_name", " ".join(user_info.get("name", "").split()[1:]) if user_info.get("name") else ""),
            "email_verified": True,
        }
    )

    return user


{% if auth_type == 'jwt' %}
def get_tokens_for_user(user: User) -> dict:
    """Generate JWT tokens for user."""
    refresh = RefreshToken.for_user(user)
    return {
        "access": str(refresh.access_token),
        "refresh": str(refresh),
    }
{% endif %}


@extend_schema(
    tags=["OAuth"],
    parameters=[
        OpenApiParameter(name="provider", description="OAuth provider (google, github)"),
    ],
)
@api_view(["GET"])
@permission_classes([AllowAny])
def oauth_authorize(request, provider: str):
    """
    Initiate OAuth flow.

    Redirects to OAuth provider's authorization page.
    """
    if provider not in PROVIDERS:
        return Response(
            {"error": f"Unknown provider: {provider}"},
            status=status.HTTP_400_BAD_REQUEST
        )

    oauth = PROVIDERS[provider]()

    # Generate state for CSRF protection
    import secrets
    state = secrets.token_urlsafe(32)
    request.session["oauth_state"] = state
    request.session["oauth_provider"] = provider

    return redirect(oauth.get_authorization_url(state))


@extend_schema(
    tags=["OAuth"],
    parameters=[
        OpenApiParameter(name="provider", description="OAuth provider"),
        OpenApiParameter(name="code", description="Authorization code"),
        OpenApiParameter(name="state", description="State parameter"),
    ],
)
@api_view(["GET"])
@permission_classes([AllowAny])
def oauth_callback(request, provider: str):
    """
    Handle OAuth callback.

    Exchanges code for token and creates/logs in user.
    """
    code = request.GET.get("code")
    state = request.GET.get("state")

    # Verify state
    if state != request.session.get("oauth_state"):
        return Response(
            {"error": "Invalid state parameter"},
            status=status.HTTP_400_BAD_REQUEST
        )

    if provider not in PROVIDERS:
        return Response(
            {"error": f"Unknown provider: {provider}"},
            status=status.HTTP_400_BAD_REQUEST
        )

    try:
        oauth = PROVIDERS[provider]()

        # Exchange code for token
        token_data = oauth.exchange_code(code)
        access_token = token_data.get("access_token")

        if not access_token:
            return Response(
                {"error": "Failed to get access token"},
                status=status.HTTP_400_BAD_REQUEST
            )

        # Get user info
        user_info = oauth.get_user_info(access_token)

        # Get or create user
        user = get_or_create_user(provider, user_info)

{% if auth_type == 'jwt' %}
        # Generate JWT tokens
        tokens = get_tokens_for_user(user)

        return Response({
            "message": "OAuth login successful",
            "user": {
                "id": str(user.id),
                "email": user.email,
                "username": user.username,
            },
            **tokens,
        })
{% else %}
        from django.contrib.auth import login
        login(request, user)

        return Response({
            "message": "OAuth login successful",
            "user": {
                "id": str(user.id),
                "email": user.email,
                "username": user.username,
            },
        })
{% endif %}

    except Exception as e:
        return Response(
            {"error": str(e)},
            status=status.HTTP_400_BAD_REQUEST
        )
