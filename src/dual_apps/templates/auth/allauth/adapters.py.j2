"""
Custom Allauth Adapters for {{ project_name }}.
Generated by dual-apps v{{ version }}

Customize allauth behavior by extending these adapters.
"""

from allauth.account.adapter import DefaultAccountAdapter
from allauth.socialaccount.adapter import DefaultSocialAccountAdapter
from django.conf import settings


class CustomAccountAdapter(DefaultAccountAdapter):
    """
    Custom account adapter for email/password authentication.

    Usage:
        Add to settings.py:
        ACCOUNT_ADAPTER = "{{ project_name }}.adapters.CustomAccountAdapter"
    """

    def is_open_for_signup(self, request):
        """
        Control whether the site is open for new signups.

        Override to implement invite-only registration, etc.
        """
        return getattr(settings, "ACCOUNT_ALLOW_REGISTRATION", True)

    def save_user(self, request, user, form, commit=True):
        """
        Customize user creation.

        Called when a new user registers.
        """
        user = super().save_user(request, user, form, commit=False)

        # Add custom fields here
        # user.profile_complete = False

        if commit:
            user.save()

        return user

    def get_login_redirect_url(self, request):
        """
        Return the URL to redirect to after successful login.
        """
        # Check if user has incomplete profile
        # if not request.user.profile_complete:
        #     return "/profile/setup/"

        return super().get_login_redirect_url(request)

    def send_mail(self, template_prefix, email, context):
        """
        Customize email sending.

        Override to use custom email templates or services.
        """
        # Add custom context
        context["site_name"] = "{{ project_name_display }}"

        super().send_mail(template_prefix, email, context)


class CustomSocialAccountAdapter(DefaultSocialAccountAdapter):
    """
    Custom social account adapter for OAuth providers.

    Usage:
        Add to settings.py:
        SOCIALACCOUNT_ADAPTER = "{{ project_name }}.adapters.CustomSocialAccountAdapter"
    """

    def is_open_for_signup(self, request, sociallogin):
        """
        Control whether social signup is allowed.
        """
        return getattr(settings, "SOCIALACCOUNT_ALLOW_REGISTRATION", True)

    def pre_social_login(self, request, sociallogin):
        """
        Called before social login completes.

        Use to link social account to existing user with same email.
        """
        # If user exists with this email, connect the account
        if sociallogin.is_existing:
            return

        email = sociallogin.account.extra_data.get("email")
        if email:
            from django.contrib.auth import get_user_model
            User = get_user_model()

            try:
                user = User.objects.get(email=email)
                sociallogin.connect(request, user)
            except User.DoesNotExist:
                pass

    def save_user(self, request, sociallogin, form=None):
        """
        Customize social user creation.
        """
        user = super().save_user(request, sociallogin, form)

        # Extract data from social account
        data = sociallogin.account.extra_data

        # Update user profile with social data
        if "picture" in data:
            # user.avatar_url = data["picture"]
            pass

        if "name" in data:
            names = data["name"].split(" ", 1)
            user.first_name = names[0]
            if len(names) > 1:
                user.last_name = names[1]

        user.save()
        return user

    def populate_user(self, request, sociallogin, data):
        """
        Populate user instance from social data.

        Called before save_user.
        """
        user = super().populate_user(request, sociallogin, data)

        # Set email as verified (from social provider)
        # user.email_verified = True

        return user
