/**
 * API Client for {{ project_name_display }}
 * Handles all communication with Django REST API
 */

const API_BASE = '/api/v1'

// Get CSRF token from cookie
function getCookie(name) {
  let cookieValue = null
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';')
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim()
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
        break
      }
    }
  }
  return cookieValue
}

// Base fetch wrapper
async function apiRequest(endpoint, options = {}) {
  const url = `${API_BASE}${endpoint}`

  const defaultOptions = {
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken'),
    },
  }

  const config = {
    ...defaultOptions,
    ...options,
    headers: {
      ...defaultOptions.headers,
      ...options.headers,
    },
  }

  const response = await fetch(url, config)

  if (!response.ok) {
    const error = await response.json().catch(() => ({}))
    throw new Error(error.detail || `API Error: ${response.status}`)
  }

  // Return empty for 204 No Content
  if (response.status === 204) {
    return null
  }

  return response.json()
}

// API methods
export const api = {
  // Generic CRUD
  list: (resource) => apiRequest(`/${resource}/`),
  get: (resource, id) => apiRequest(`/${resource}/${id}/`),
  create: (resource, data) => apiRequest(`/${resource}/`, {
    method: 'POST',
    body: JSON.stringify(data),
  }),
  update: (resource, id, data) => apiRequest(`/${resource}/${id}/`, {
    method: 'PUT',
    body: JSON.stringify(data),
  }),
  patch: (resource, id, data) => apiRequest(`/${resource}/${id}/`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  }),
  delete: (resource, id) => apiRequest(`/${resource}/${id}/`, {
    method: 'DELETE',
  }),
}

export default api
