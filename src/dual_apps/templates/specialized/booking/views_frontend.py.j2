"""
Booking frontend views for {{ app_name }} app.
Generated by dual-apps v{{ version }}
"""

from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import ListView, DetailView, CreateView
from django.contrib.auth.mixins import LoginRequiredMixin

from .models import ServiceCategory, Service, Staff, Booking
from .forms import BookingForm


class ServiceCategoryListView(ListView):
    """List all service categories."""
    model = ServiceCategory
    template_name = "{{ app_name }}/category_list.html"
    context_object_name = "categories"

    def get_queryset(self):
        return ServiceCategory.objects.filter(is_active=True)


class ServiceListView(ListView):
    """List all available services."""
    model = Service
    template_name = "{{ app_name }}/service_list.html"
    context_object_name = "services"

    def get_queryset(self):
        queryset = Service.objects.filter(is_active=True)
        category_slug = self.kwargs.get('category_slug')
        if category_slug:
            queryset = queryset.filter(category__slug=category_slug)
        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['categories'] = ServiceCategory.objects.filter(is_active=True)
        return context


class ServiceDetailView(DetailView):
    """Service detail with booking option."""
    model = Service
    template_name = "{{ app_name }}/service_detail.html"
    context_object_name = "service"
    slug_field = "slug"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['staff'] = self.object.staff.filter(is_active=True)
        return context


class BookingCreateView(LoginRequiredMixin, CreateView):
    """Create a new booking."""
    model = Booking
    form_class = BookingForm
    template_name = "{{ app_name }}/booking_form.html"

    def form_valid(self, form):
        form.instance.customer = self.request.user
        form.instance.customer_name = self.request.user.get_full_name() or self.request.user.username
        form.instance.customer_email = self.request.user.email
        return super().form_valid(form)


class BookingListView(LoginRequiredMixin, ListView):
    """List user's bookings."""
    model = Booking
    template_name = "{{ app_name }}/booking_list.html"
    context_object_name = "bookings"

    def get_queryset(self):
        return Booking.objects.filter(customer=self.request.user).order_by('-start_datetime')


class BookingDetailView(LoginRequiredMixin, DetailView):
    """Booking detail view."""
    model = Booking
    template_name = "{{ app_name }}/booking_detail.html"
    context_object_name = "booking"

    def get_queryset(self):
        return Booking.objects.filter(customer=self.request.user)


# URL name mappings
category_list = ServiceCategoryListView.as_view()
service_list = ServiceListView.as_view()
service_detail = ServiceDetailView.as_view()
booking_create = BookingCreateView.as_view()
booking_list = BookingListView.as_view()
booking_detail = BookingDetailView.as_view()
