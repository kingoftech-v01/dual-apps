"""
Booking Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - Booking Template

Shared pytest fixtures for booking tests.
"""

import pytest
from decimal import Decimal
from datetime import time, timedelta
from django.utils import timezone

from apps.services.models import ServiceCategory, Service, Staff, Resource, Availability, BlockedTime
from apps.appointments.models import Booking, BookingPayment, BookingReview


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def staff_user(db):
    """Create a staff user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="staffuser",
        first_name="Sarah",
        last_name="Smith",
        email="sarah@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        first_name="John",
        last_name="Doe",
        email="john@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, customer):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=customer)
    return api_client


@pytest.fixture
def staff_api_client(api_client, staff_user):
    """Create a staff-authenticated API client."""
    api_client.force_authenticate(user=staff_user)
    return api_client


# =============================================================================
# Service Category Fixtures
# =============================================================================

@pytest.fixture
def category(db):
    """Create a service category."""
    return ServiceCategory.objects.create(
        name="Hair Services",
        slug="hair-services",
        description="All hair services"
    )


@pytest.fixture
def multiple_categories(db):
    """Create multiple categories."""
    return [
        ServiceCategory.objects.create(name="Hair Services", slug="hair"),
        ServiceCategory.objects.create(name="Nail Services", slug="nails"),
        ServiceCategory.objects.create(name="Spa Services", slug="spa"),
    ]


# =============================================================================
# Service Fixtures
# =============================================================================

@pytest.fixture
def service(db, category):
    """Create a service."""
    return Service.objects.create(
        name="Haircut",
        slug="haircut",
        description="Standard haircut",
        category=category,
        duration_minutes=30,
        price=Decimal("35.00")
    )


@pytest.fixture
def service_with_deposit(db, category):
    """Create a service requiring deposit."""
    return Service.objects.create(
        name="Hair Coloring",
        slug="hair-coloring",
        description="Full hair coloring",
        category=category,
        duration_minutes=120,
        price=Decimal("150.00"),
        deposit_amount=Decimal("50.00"),
        deposit_required=True
    )


@pytest.fixture
def group_service(db, category):
    """Create a group service."""
    return Service.objects.create(
        name="Group Workshop",
        slug="workshop",
        description="Group styling workshop",
        category=category,
        duration_minutes=180,
        price=Decimal("50.00"),
        max_participants=10
    )


@pytest.fixture
def multiple_services(db, category):
    """Create multiple services."""
    return [
        Service.objects.create(
            name="Haircut", slug="haircut", description="Cut",
            category=category, duration_minutes=30, price=Decimal("35.00")
        ),
        Service.objects.create(
            name="Wash & Style", slug="wash-style", description="Wash and style",
            category=category, duration_minutes=45, price=Decimal("45.00")
        ),
        Service.objects.create(
            name="Color", slug="color", description="Hair coloring",
            category=category, duration_minutes=90, price=Decimal("100.00")
        ),
    ]


# =============================================================================
# Staff Fixtures
# =============================================================================

@pytest.fixture
def staff(db, staff_user, service):
    """Create a staff member."""
    staff = Staff.objects.create(
        user=staff_user,
        bio="Experienced stylist with 10 years experience"
    )
    staff.services.add(service)
    return staff


@pytest.fixture
def multiple_staff(db, service):
    """Create multiple staff members."""
    from django.contrib.auth import get_user_model
    User = get_user_model()

    staff_list = []
    for i in range(3):
        user = User.objects.create_user(
            username=f"staff{i}",
            email=f"staff{i}@example.com",
            password="testpass123"
        )
        staff = Staff.objects.create(user=user)
        staff.services.add(service)
        staff_list.append(staff)
    return staff_list


# =============================================================================
# Resource Fixtures
# =============================================================================

@pytest.fixture
def resource(db):
    """Create a resource."""
    return Resource.objects.create(
        name="Room 1",
        description="Main treatment room",
        capacity=2
    )


# =============================================================================
# Availability Fixtures
# =============================================================================

@pytest.fixture
def availability(db, staff):
    """Create staff availability."""
    availabilities = []
    for day in range(5):  # Monday to Friday
        availabilities.append(Availability.objects.create(
            staff=staff,
            day_of_week=day,
            start_time=time(9, 0),
            end_time=time(17, 0)
        ))
    return availabilities


@pytest.fixture
def blocked_time(db, staff):
    """Create blocked time."""
    return BlockedTime.objects.create(
        staff=staff,
        title="Lunch Break",
        start_datetime=timezone.now().replace(hour=12, minute=0),
        end_datetime=timezone.now().replace(hour=13, minute=0)
    )


# =============================================================================
# Booking Fixtures
# =============================================================================

@pytest.fixture
def booking(db, service, staff, customer):
    """Create a pending booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        customer_phone="555-1234",
        service=service,
        staff=staff,
        start_datetime=timezone.now() + timedelta(days=1, hours=10),
        status="pending",
        price=service.price
    )


@pytest.fixture
def confirmed_booking(db, service, staff, customer):
    """Create a confirmed booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() + timedelta(days=1, hours=10),
        status="confirmed",
        price=service.price,
        confirmation_sent=True
    )


@pytest.fixture
def completed_booking(db, service, staff, customer):
    """Create a completed booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() - timedelta(days=1),
        status="completed",
        price=service.price,
        total_paid=service.price
    )


@pytest.fixture
def cancelled_booking(db, service, staff, customer):
    """Create a cancelled booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="Jane Doe",
        customer_email="jane@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() + timedelta(days=2),
        status="cancelled",
        price=service.price,
        cancelled_at=timezone.now(),
        cancellation_reason="Changed plans"
    )


# =============================================================================
# Payment Fixtures
# =============================================================================

@pytest.fixture
def booking_payment(db, booking):
    """Create a booking payment."""
    return BookingPayment.objects.create(
        booking=booking,
        payment_type="full",
        amount=booking.price,
        method="card",
        status="completed"
    )


# =============================================================================
# Review Fixtures
# =============================================================================

@pytest.fixture
def booking_review(db, completed_booking):
    """Create a booking review."""
    return BookingReview.objects.create(
        booking=completed_booking,
        rating=5,
        comment="Excellent service!"
    )
