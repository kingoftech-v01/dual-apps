"""
Booking Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Booking Template

Tests for booking models: Service, Staff, Availability, Booking.
"""

import pytest
from decimal import Decimal
from datetime import time, timedelta
from django.utils import timezone
from django.db import IntegrityError

from apps.services.models import ServiceCategory, Service, Staff, Resource, Availability, BlockedTime
from apps.appointments.models import Booking, BookingPayment, BookingReview, NotificationTemplate


# =============================================================================
# ServiceCategory Tests
# =============================================================================

class TestServiceCategory:
    """Tests for ServiceCategory model."""

    def test_create_category(self, db):
        """Test creating a service category."""
        category = ServiceCategory.objects.create(
            name="Hair Services",
            slug="hair-services",
            description="All hair-related services"
        )
        assert category.id is not None
        assert category.is_active is True


# =============================================================================
# Service Tests
# =============================================================================

class TestService:
    """Tests for Service model."""

    def test_create_service(self, db, category):
        """Test creating a service."""
        service = Service.objects.create(
            name="Haircut",
            slug="haircut",
            description="Standard haircut",
            category=category,
            duration_minutes=30,
            price=Decimal("35.00")
        )
        assert service.id is not None
        assert service.is_active is True

    def test_service_total_duration(self, db, category):
        """Test total_duration property with buffers."""
        service = Service.objects.create(
            name="Massage",
            slug="massage",
            description="Full body massage",
            category=category,
            duration_minutes=60,
            price=Decimal("80.00"),
            buffer_before=10,
            buffer_after=15
        )
        assert service.total_duration == 85  # 10 + 60 + 15


# =============================================================================
# Staff Tests
# =============================================================================

class TestStaff:
    """Tests for Staff model."""

    def test_create_staff(self, db, staff_user):
        """Test creating a staff member."""
        staff = Staff.objects.create(
            user=staff_user,
            bio="Experienced stylist"
        )
        assert staff.is_active is True
        assert str(staff) == staff_user.get_full_name() or staff_user.username

    def test_staff_services(self, db, staff, service):
        """Test assigning services to staff."""
        staff.services.add(service)
        assert service in staff.services.all()


# =============================================================================
# Availability Tests
# =============================================================================

class TestAvailability:
    """Tests for Availability model."""

    def test_create_availability(self, db, staff):
        """Test creating availability."""
        availability = Availability.objects.create(
            staff=staff,
            day_of_week=0,  # Monday
            start_time=time(9, 0),
            end_time=time(17, 0)
        )
        assert availability.is_available is True

    def test_unique_availability(self, db, staff):
        """Test unique constraint on availability."""
        Availability.objects.create(
            staff=staff,
            day_of_week=0,
            start_time=time(9, 0),
            end_time=time(17, 0)
        )
        with pytest.raises(IntegrityError):
            Availability.objects.create(
                staff=staff,
                day_of_week=0,
                start_time=time(9, 0),
                end_time=time(12, 0)
            )


# =============================================================================
# BlockedTime Tests
# =============================================================================

class TestBlockedTime:
    """Tests for BlockedTime model."""

    def test_create_blocked_time(self, db, staff):
        """Test creating blocked time."""
        now = timezone.now()
        blocked = BlockedTime.objects.create(
            staff=staff,
            title="Vacation",
            start_datetime=now,
            end_datetime=now + timedelta(days=7),
            is_all_day=True
        )
        assert blocked.id is not None


# =============================================================================
# Booking Tests
# =============================================================================

class TestBooking:
    """Tests for Booking model."""

    def test_create_booking(self, db, service, staff, customer):
        """Test creating a booking."""
        start = timezone.now() + timedelta(days=1)
        booking = Booking.objects.create(
            customer=customer,
            customer_name="John Doe",
            customer_email="john@example.com",
            service=service,
            staff=staff,
            start_datetime=start,
            price=service.price
        )
        assert booking.status == "pending"
        assert booking.end_datetime is not None
        assert booking.duration_minutes == service.duration_minutes

    def test_booking_is_past(self, db, service, staff, customer):
        """Test is_past property."""
        # Future booking
        future_booking = Booking.objects.create(
            customer=customer,
            customer_name="John",
            customer_email="john@example.com",
            service=service,
            staff=staff,
            start_datetime=timezone.now() + timedelta(days=1),
            price=service.price
        )
        assert future_booking.is_past is False

    def test_booking_can_cancel(self, db, service, staff, customer):
        """Test can_cancel property."""
        # Booking 48 hours from now - can cancel
        booking = Booking.objects.create(
            customer=customer,
            customer_name="John",
            customer_email="john@example.com",
            service=service,
            staff=staff,
            start_datetime=timezone.now() + timedelta(hours=48),
            status="confirmed",
            price=service.price
        )
        assert booking.can_cancel is True

        # Booking 12 hours from now - cannot cancel
        soon_booking = Booking.objects.create(
            customer=customer,
            customer_name="Jane",
            customer_email="jane@example.com",
            service=service,
            staff=staff,
            start_datetime=timezone.now() + timedelta(hours=12),
            status="confirmed",
            price=service.price
        )
        assert soon_booking.can_cancel is False


# =============================================================================
# BookingPayment Tests
# =============================================================================

class TestBookingPayment:
    """Tests for BookingPayment model."""

    def test_create_payment(self, db, booking):
        """Test creating a booking payment."""
        payment = BookingPayment.objects.create(
            booking=booking,
            payment_type="full",
            amount=booking.price,
            method="card"
        )
        assert payment.status == "completed"


# =============================================================================
# BookingReview Tests
# =============================================================================

class TestBookingReview:
    """Tests for BookingReview model."""

    def test_create_review(self, db, completed_booking):
        """Test creating a booking review."""
        review = BookingReview.objects.create(
            booking=completed_booking,
            rating=5,
            comment="Excellent service!"
        )
        assert review.is_approved is True


# =============================================================================
# Resource Tests
# =============================================================================

class TestResource:
    """Tests for Resource model."""

    def test_create_resource(self, db):
        """Test creating a resource."""
        resource = Resource.objects.create(
            name="Room 1",
            description="Treatment room",
            capacity=2
        )
        assert resource.is_active is True


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def staff_user(db):
    """Create a staff user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="staffuser",
        first_name="Staff",
        last_name="Member",
        email="staff@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        email="customer@example.com",
        password="testpass123"
    )


@pytest.fixture
def category(db):
    """Create a service category."""
    return ServiceCategory.objects.create(
        name="Hair Services",
        slug="hair-services"
    )


@pytest.fixture
def service(db, category):
    """Create a service."""
    return Service.objects.create(
        name="Haircut",
        slug="haircut",
        description="Standard haircut",
        category=category,
        duration_minutes=30,
        price=Decimal("35.00")
    )


@pytest.fixture
def staff(db, staff_user, service):
    """Create a staff member."""
    staff = Staff.objects.create(user=staff_user)
    staff.services.add(service)
    return staff


@pytest.fixture
def booking(db, service, staff, customer):
    """Create a booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() + timedelta(days=1),
        price=service.price
    )


@pytest.fixture
def completed_booking(db, service, staff, customer):
    """Create a completed booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() - timedelta(days=1),
        status="completed",
        price=service.price
    )
