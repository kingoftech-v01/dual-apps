"""
Booking API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Booking Template

Tests for booking API endpoints.
"""

import pytest
from decimal import Decimal
from datetime import timedelta
from rest_framework import status
from django.utils import timezone

from apps.services.models import ServiceCategory, Service, Staff
from apps.appointments.models import Booking


# =============================================================================
# Service API Tests
# =============================================================================

class TestServiceAPI:
    """Tests for Service API endpoints."""

    def test_list_services(self, api_client, service):
        """Test listing services."""
        response = api_client.get("/api/v1/services/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_service(self, api_client, service):
        """Test retrieving a service."""
        response = api_client.get(f"/api/v1/services/{service.slug}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["name"] == service.name

    def test_filter_services_by_category(self, api_client, service, category):
        """Test filtering services by category."""
        response = api_client.get(f"/api/v1/services/?category={category.slug}")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Staff API Tests
# =============================================================================

class TestStaffAPI:
    """Tests for Staff API endpoints."""

    def test_list_staff(self, api_client, staff):
        """Test listing staff members."""
        response = api_client.get("/api/v1/staff/")
        assert response.status_code == status.HTTP_200_OK

    def test_staff_services(self, api_client, staff):
        """Test getting staff's services."""
        response = api_client.get(f"/api/v1/staff/{staff.id}/services/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Availability API Tests
# =============================================================================

class TestAvailabilityAPI:
    """Tests for Availability API endpoints."""

    def test_get_available_slots(self, api_client, service, staff, availability):
        """Test getting available time slots."""
        date = (timezone.now() + timedelta(days=1)).strftime("%Y-%m-%d")
        response = api_client.get(
            f"/api/v1/services/{service.slug}/available-slots/",
            {"date": date, "staff": str(staff.id)}
        )
        assert response.status_code == status.HTTP_200_OK

    def test_check_availability(self, api_client, service, staff):
        """Test checking specific slot availability."""
        start = timezone.now() + timedelta(days=1, hours=10)
        response = api_client.get(
            f"/api/v1/services/{service.slug}/check-availability/",
            {"start": start.isoformat(), "staff": str(staff.id)}
        )
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Booking API Tests
# =============================================================================

class TestBookingAPI:
    """Tests for Booking API endpoints."""

    def test_create_booking_authenticated(self, auth_api_client, service, staff, customer):
        """Test creating a booking as authenticated user."""
        start = timezone.now() + timedelta(days=1, hours=10)
        response = auth_api_client.post("/api/v1/bookings/", {
            "service": str(service.id),
            "staff": str(staff.id),
            "start_datetime": start.isoformat(),
            "customer_name": "John Doe",
            "customer_email": "john@example.com"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_400_BAD_REQUEST]

    def test_create_booking_guest(self, api_client, service, staff):
        """Test creating a booking as guest."""
        start = timezone.now() + timedelta(days=1, hours=10)
        response = api_client.post("/api/v1/bookings/", {
            "service": str(service.id),
            "staff": str(staff.id),
            "start_datetime": start.isoformat(),
            "customer_name": "Guest User",
            "customer_email": "guest@example.com",
            "customer_phone": "555-1234"
        })
        # Guest bookings may or may not be allowed
        assert response.status_code in [
            status.HTTP_201_CREATED,
            status.HTTP_401_UNAUTHORIZED,
            status.HTTP_400_BAD_REQUEST
        ]

    def test_list_my_bookings(self, auth_api_client, booking, customer):
        """Test listing user's bookings."""
        response = auth_api_client.get("/api/v1/bookings/my-bookings/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_booking(self, auth_api_client, booking, customer):
        """Test retrieving a booking."""
        response = auth_api_client.get(f"/api/v1/bookings/{booking.id}/")
        assert response.status_code == status.HTTP_200_OK

    def test_cancel_booking(self, auth_api_client, booking, customer):
        """Test canceling a booking."""
        response = auth_api_client.post(f"/api/v1/bookings/{booking.id}/cancel/", {
            "reason": "Changed my mind"
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]

    def test_reschedule_booking(self, auth_api_client, booking, customer):
        """Test rescheduling a booking."""
        new_start = timezone.now() + timedelta(days=2, hours=14)
        response = auth_api_client.post(f"/api/v1/bookings/{booking.id}/reschedule/", {
            "start_datetime": new_start.isoformat()
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Review API Tests
# =============================================================================

class TestBookingReviewAPI:
    """Tests for BookingReview API endpoints."""

    def test_create_review(self, auth_api_client, completed_booking, customer):
        """Test creating a review for completed booking."""
        response = auth_api_client.post(
            f"/api/v1/bookings/{completed_booking.id}/review/",
            {"rating": 5, "comment": "Great service!"}
        )
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_cannot_review_pending_booking(self, auth_api_client, booking, customer):
        """Test cannot review pending booking."""
        response = auth_api_client.post(
            f"/api/v1/bookings/{booking.id}/review/",
            {"rating": 5}
        )
        assert response.status_code == status.HTTP_400_BAD_REQUEST


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, customer):
    """Create authenticated API client."""
    api_client.force_authenticate(user=customer)
    return api_client


@pytest.fixture
def staff_user(db):
    """Create a staff user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="staffuser",
        email="staff@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        email="customer@example.com",
        password="testpass123"
    )


@pytest.fixture
def category(db):
    """Create a service category."""
    return ServiceCategory.objects.create(
        name="Hair Services",
        slug="hair-services"
    )


@pytest.fixture
def service(db, category):
    """Create a service."""
    return Service.objects.create(
        name="Haircut",
        slug="haircut",
        description="Standard haircut",
        category=category,
        duration_minutes=30,
        price=Decimal("35.00")
    )


@pytest.fixture
def staff(db, staff_user, service):
    """Create a staff member."""
    from apps.services.models import Staff
    staff = Staff.objects.create(user=staff_user)
    staff.services.add(service)
    return staff


@pytest.fixture
def availability(db, staff):
    """Create staff availability."""
    from datetime import time
    from apps.services.models import Availability
    return Availability.objects.create(
        staff=staff,
        day_of_week=(timezone.now() + timedelta(days=1)).weekday(),
        start_time=time(9, 0),
        end_time=time(17, 0)
    )


@pytest.fixture
def booking(db, service, staff, customer):
    """Create a booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() + timedelta(days=1, hours=10),
        status="confirmed",
        price=service.price
    )


@pytest.fixture
def completed_booking(db, service, staff, customer):
    """Create a completed booking."""
    return Booking.objects.create(
        customer=customer,
        customer_name="John Doe",
        customer_email="john@example.com",
        service=service,
        staff=staff,
        start_datetime=timezone.now() - timedelta(days=1),
        status="completed",
        price=service.price
    )
