import { createContext, useContext, useState, useCallback } from 'react';
import api from '../utils/api';

const BookingContext = createContext(null);

export function BookingProvider({ children }) {
  const [currentBooking, setCurrentBooking] = useState(null);
  const [selectedService, setSelectedService] = useState(null);
  const [selectedDate, setSelectedDate] = useState(null);
  const [selectedTimeSlot, setSelectedTimeSlot] = useState(null);
  const [selectedStaff, setSelectedStaff] = useState(null);

  const resetBooking = useCallback(() => {
    setCurrentBooking(null);
    setSelectedService(null);
    setSelectedDate(null);
    setSelectedTimeSlot(null);
    setSelectedStaff(null);
  }, []);

  const createBooking = useCallback(async (bookingData) => {
    try {
      const response = await api.post('/api/booking/bookings/', bookingData);
      setCurrentBooking(response.data);
      return response.data;
    } catch (error) {
      throw error;
    }
  }, []);

  const cancelBooking = useCallback(async (reference) => {
    try {
      await api.post(`/api/booking/bookings/${reference}/cancel/`);
      setCurrentBooking(null);
    } catch (error) {
      throw error;
    }
  }, []);

  const rescheduleBooking = useCallback(async (reference, newDate, newTimeSlot) => {
    try {
      const response = await api.post(`/api/booking/bookings/${reference}/reschedule/`, {
        date: newDate,
        time_slot: newTimeSlot
      });
      setCurrentBooking(response.data);
      return response.data;
    } catch (error) {
      throw error;
    }
  }, []);

  const value = {
    currentBooking,
    setCurrentBooking,
    selectedService,
    setSelectedService,
    selectedDate,
    setSelectedDate,
    selectedTimeSlot,
    setSelectedTimeSlot,
    selectedStaff,
    setSelectedStaff,
    resetBooking,
    createBooking,
    cancelBooking,
    rescheduleBooking
  };

  return (
    <BookingContext.Provider value={value}>
      {children}
    </BookingContext.Provider>
  );
}

export function useBooking() {
  const context = useContext(BookingContext);
  if (!context) {
    throw new Error('useBooking must be used within a BookingProvider');
  }
  return context;
}

export default BookingContext;
