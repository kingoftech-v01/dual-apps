"""
Booking Models for {{ project_name }}.
Generated by dual-apps v{{ version }} - Booking Template

Appointment/service booking system with calendar, availability, and notifications.
"""

import uuid
from decimal import Decimal
from django.db import models
from django.conf import settings
from django.utils import timezone
from datetime import timedelta


class BaseModel(models.Model):
    """Abstract base model."""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


# =============================================================================
# Services & Categories
# =============================================================================

class ServiceCategory(BaseModel):
    """Service category."""
    name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    image = models.ImageField(upload_to="booking/categories/", blank=True, null=True)
    order = models.PositiveIntegerField(default=0)
    is_active = models.BooleanField(default=True)

    class Meta:
        verbose_name_plural = "service categories"
        ordering = ["order", "name"]

    def __str__(self):
        return self.name


class Service(BaseModel):
    """Bookable service."""
    name = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200, unique=True)
    description = models.TextField()
    short_description = models.CharField(max_length=500, blank=True)
    image = models.ImageField(upload_to="booking/services/", blank=True, null=True)

    # Category
    category = models.ForeignKey(
        ServiceCategory, on_delete=models.SET_NULL,
        null=True, related_name="services"
    )

    # Duration & Pricing
    duration_minutes = models.PositiveIntegerField(default=60)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    deposit_amount = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    deposit_required = models.BooleanField(default=False)

    # Capacity
    max_participants = models.PositiveIntegerField(default=1)  # For group bookings

    # Buffer time
    buffer_before = models.PositiveIntegerField(default=0)  # minutes
    buffer_after = models.PositiveIntegerField(default=0)   # minutes

    # Settings
    is_active = models.BooleanField(default=True)
    is_featured = models.BooleanField(default=False)
    requires_approval = models.BooleanField(default=False)

    class Meta:
        ordering = ["category", "name"]

    def __str__(self):
        return self.name

    @property
    def total_duration(self):
        """Total time including buffers."""
        return self.buffer_before + self.duration_minutes + self.buffer_after


# =============================================================================
# Staff / Resources
# =============================================================================

class Staff(BaseModel):
    """Staff member who provides services."""
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="staff_profile"
    )
    bio = models.TextField(blank=True)
    photo = models.ImageField(upload_to="booking/staff/", blank=True, null=True)
    services = models.ManyToManyField(Service, related_name="staff")

    # Contact
    phone = models.CharField(max_length=20, blank=True)
    email = models.EmailField(blank=True)

    # Settings
    is_active = models.BooleanField(default=True)
    order = models.PositiveIntegerField(default=0)

    class Meta:
        verbose_name_plural = "staff"
        ordering = ["order", "user__first_name"]

    def __str__(self):
        return self.user.get_full_name() or self.user.username


class Resource(BaseModel):
    """Bookable resource (room, equipment, etc.)."""
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    capacity = models.PositiveIntegerField(default=1)
    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ["name"]

    def __str__(self):
        return self.name


# =============================================================================
# Availability
# =============================================================================

class Availability(BaseModel):
    """Weekly availability schedule."""
    DAYS_OF_WEEK = [
        (0, "Monday"),
        (1, "Tuesday"),
        (2, "Wednesday"),
        (3, "Thursday"),
        (4, "Friday"),
        (5, "Saturday"),
        (6, "Sunday"),
    ]

    staff = models.ForeignKey(
        Staff, on_delete=models.CASCADE,
        related_name="availabilities"
    )
    day_of_week = models.PositiveIntegerField(choices=DAYS_OF_WEEK)
    start_time = models.TimeField()
    end_time = models.TimeField()
    is_available = models.BooleanField(default=True)

    class Meta:
        unique_together = ["staff", "day_of_week", "start_time"]
        ordering = ["day_of_week", "start_time"]

    def __str__(self):
        return f"{self.staff} - {self.get_day_of_week_display()}: {self.start_time}-{self.end_time}"


class BlockedTime(BaseModel):
    """Blocked time slots (holidays, breaks, etc.)."""
    staff = models.ForeignKey(
        Staff, on_delete=models.CASCADE,
        null=True, blank=True, related_name="blocked_times"
    )
    title = models.CharField(max_length=100)
    start_datetime = models.DateTimeField()
    end_datetime = models.DateTimeField()
    is_all_day = models.BooleanField(default=False)
    repeat = models.CharField(max_length=20, blank=True)  # daily, weekly, monthly, yearly

    class Meta:
        ordering = ["start_datetime"]

    def __str__(self):
        return f"{self.title}: {self.start_datetime}"


# =============================================================================
# Bookings
# =============================================================================

class Booking(BaseModel):
    """Service booking."""
    STATUS_CHOICES = [
        ("pending", "Pending"),
        ("confirmed", "Confirmed"),
        ("cancelled", "Cancelled"),
        ("completed", "Completed"),
        ("no_show", "No Show"),
    ]

    # Customer
    customer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, related_name="bookings"
    )
    customer_name = models.CharField(max_length=100)
    customer_email = models.EmailField()
    customer_phone = models.CharField(max_length=20, blank=True)

    # Service
    service = models.ForeignKey(
        Service, on_delete=models.PROTECT,
        related_name="bookings"
    )
    staff = models.ForeignKey(
        Staff, on_delete=models.SET_NULL,
        null=True, related_name="bookings"
    )
    resource = models.ForeignKey(
        Resource, on_delete=models.SET_NULL,
        null=True, blank=True, related_name="bookings"
    )

    # Timing
    start_datetime = models.DateTimeField()
    end_datetime = models.DateTimeField()
    duration_minutes = models.PositiveIntegerField()

    # Participants
    participants = models.PositiveIntegerField(default=1)

    # Status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="pending")

    # Pricing
    price = models.DecimalField(max_digits=10, decimal_places=2)
    deposit_paid = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    total_paid = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))

    # Notes
    customer_notes = models.TextField(blank=True)
    staff_notes = models.TextField(blank=True)

    # Reminders
    reminder_sent = models.BooleanField(default=False)
    confirmation_sent = models.BooleanField(default=False)

    # Cancellation
    cancelled_at = models.DateTimeField(null=True, blank=True)
    cancellation_reason = models.TextField(blank=True)

    class Meta:
        ordering = ["-start_datetime"]
        indexes = [
            models.Index(fields=["start_datetime", "status"]),
            models.Index(fields=["staff", "start_datetime"]),
        ]

    def __str__(self):
        return f"{self.service.name} - {self.customer_name} ({self.start_datetime})"

    def save(self, *args, **kwargs):
        if not self.end_datetime:
            self.end_datetime = self.start_datetime + timedelta(minutes=self.service.total_duration)
        if not self.duration_minutes:
            self.duration_minutes = self.service.duration_minutes
        if not self.price:
            self.price = self.service.price
        super().save(*args, **kwargs)

    @property
    def is_past(self):
        return self.end_datetime < timezone.now()

    @property
    def can_cancel(self):
        """Check if booking can be cancelled (e.g., 24 hours before)."""
        return self.status in ["pending", "confirmed"] and \
               self.start_datetime > timezone.now() + timedelta(hours=24)


# =============================================================================
# Payments
# =============================================================================

class BookingPayment(BaseModel):
    """Payment for booking."""
    PAYMENT_TYPES = [
        ("deposit", "Deposit"),
        ("full", "Full Payment"),
        ("balance", "Balance"),
        ("refund", "Refund"),
    ]

    booking = models.ForeignKey(
        Booking, on_delete=models.CASCADE,
        related_name="payments"
    )
    payment_type = models.CharField(max_length=20, choices=PAYMENT_TYPES)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    method = models.CharField(max_length=50)  # card, cash, etc.
    transaction_id = models.CharField(max_length=100, blank=True)
    status = models.CharField(max_length=20, default="completed")

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.payment_type} - ${self.amount}"


# =============================================================================
# Reviews
# =============================================================================

class BookingReview(BaseModel):
    """Review for completed booking."""
    booking = models.OneToOneField(
        Booking, on_delete=models.CASCADE,
        related_name="review"
    )
    rating = models.PositiveIntegerField()  # 1-5
    comment = models.TextField(blank=True)
    is_approved = models.BooleanField(default=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"Review for {self.booking}"


# =============================================================================
# Notifications
# =============================================================================

class NotificationTemplate(BaseModel):
    """Email/SMS notification templates."""
    TRIGGER_CHOICES = [
        ("booking_created", "Booking Created"),
        ("booking_confirmed", "Booking Confirmed"),
        ("booking_cancelled", "Booking Cancelled"),
        ("booking_reminder", "Booking Reminder"),
        ("booking_completed", "Booking Completed"),
        ("review_request", "Review Request"),
    ]

    trigger = models.CharField(max_length=50, choices=TRIGGER_CHOICES, unique=True)
    subject = models.CharField(max_length=200)
    body = models.TextField()
    is_active = models.BooleanField(default=True)

    def __str__(self):
        return f"{self.trigger} template"
