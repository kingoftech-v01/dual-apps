"""
Booking API views for {{ app_name }} app.
Generated by dual-apps v{{ version }}
"""

from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticatedOrReadOnly, IsAuthenticated

from .models import (
    ServiceCategory, Service, Staff, Resource,
    Availability, BlockedTime, Booking, BookingPayment, BookingReview
)
from .serializers import (
    ServiceCategorySerializer, ServiceSerializer, StaffSerializer, ResourceSerializer,
    AvailabilitySerializer, BookingSerializer, BookingReviewSerializer
)
from .permissions import IsOwnerOrReadOnly


class ServiceCategoryViewSet(viewsets.ReadOnlyModelViewSet):
    """Service category API."""
    queryset = ServiceCategory.objects.filter(is_active=True)
    serializer_class = ServiceCategorySerializer
    lookup_field = 'slug'


class ServiceViewSet(viewsets.ReadOnlyModelViewSet):
    """Service API."""
    queryset = Service.objects.filter(is_active=True)
    serializer_class = ServiceSerializer
    lookup_field = 'slug'


class StaffViewSet(viewsets.ReadOnlyModelViewSet):
    """Staff API."""
    queryset = Staff.objects.filter(is_active=True)
    serializer_class = StaffSerializer

    @action(detail=True, methods=['get'])
    def availability(self, request, pk=None):
        """Get staff availability."""
        staff = self.get_object()
        availabilities = Availability.objects.filter(staff=staff, is_available=True)
        serializer = AvailabilitySerializer(availabilities, many=True)
        return Response(serializer.data)


class ResourceViewSet(viewsets.ReadOnlyModelViewSet):
    """Resource API."""
    queryset = Resource.objects.filter(is_active=True)
    serializer_class = ResourceSerializer


class BookingViewSet(viewsets.ModelViewSet):
    """Booking API."""
    queryset = Booking.objects.all()
    serializer_class = BookingSerializer
    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]

    def get_queryset(self):
        if self.request.user.is_authenticated:
            return Booking.objects.filter(customer=self.request.user)
        return Booking.objects.none()

    def perform_create(self, serializer):
        serializer.save(customer=self.request.user)

    @action(detail=True, methods=['post'])
    def cancel(self, request, pk=None):
        """Cancel a booking."""
        booking = self.get_object()
        if not booking.can_cancel:
            return Response(
                {"error": "Cannot cancel this booking"},
                status=status.HTTP_400_BAD_REQUEST
            )
        booking.status = 'cancelled'
        booking.cancellation_reason = request.data.get('reason', '')
        booking.save()
        return Response({"status": "cancelled"})


class BookingReviewViewSet(viewsets.ModelViewSet):
    """Booking review API."""
    queryset = BookingReview.objects.filter(is_approved=True)
    serializer_class = BookingReviewSerializer
    permission_classes = [IsAuthenticatedOrReadOnly]

    def perform_create(self, serializer):
        serializer.save()


# Compatibility alias
{{ app_name_pascal }}ViewSet = ServiceViewSet
