"""
Blog frontend views for {{ app_name }} app.

HTMX-powered blog with posts, categories, and comments.

Generated by dual-apps v{{ version }}
"""

from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import ListView, DetailView, CreateView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.http import HttpResponse
from django.db.models import Count

from .models import Post, Category, Tag, Comment
from .forms import CommentForm


class PostListView(ListView):
    """List all published blog posts."""
    model = Post
    template_name = "{{ app_name }}/post_list.html"
    context_object_name = "posts"
    paginate_by = 10

    def get_queryset(self):
        queryset = Post.objects.filter(status='published').select_related('author', 'category')

        # Filter by category
        category_slug = self.request.GET.get('category')
        if category_slug:
            queryset = queryset.filter(category__slug=category_slug)

        # Filter by tag
        tag_slug = self.request.GET.get('tag')
        if tag_slug:
            queryset = queryset.filter(tags__slug=tag_slug)

        # Search
        search = self.request.GET.get('q')
        if search:
            queryset = queryset.filter(title__icontains=search) | queryset.filter(content__icontains=search)

        return queryset.order_by('-published_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['categories'] = Category.objects.annotate(post_count=Count('posts')).filter(post_count__gt=0)
        context['tags'] = Tag.objects.annotate(post_count=Count('posts')).filter(post_count__gt=0)[:20]
        return context


class PostDetailView(DetailView):
    """View single blog post."""
    model = Post
    template_name = "{{ app_name }}/post_detail.html"
    context_object_name = "post"
    slug_field = "slug"

    def get_queryset(self):
        return Post.objects.filter(status='published').select_related('author', 'category')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['comments'] = self.object.comments.filter(is_approved=True).select_related('author')
        context['comment_form'] = CommentForm()
        context['related_posts'] = Post.objects.filter(
            category=self.object.category,
            status='published'
        ).exclude(id=self.object.id)[:4]
        return context


class CategoryListView(ListView):
    """List posts in a category."""
    model = Post
    template_name = "{{ app_name }}/category_list.html"
    context_object_name = "posts"
    paginate_by = 10

    def get_queryset(self):
        self.category = get_object_or_404(Category, slug=self.kwargs['slug'])
        return Post.objects.filter(category=self.category, status='published').order_by('-published_at')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['category'] = self.category
        return context


def add_comment(request, slug):
    """Add comment to a post (HTMX)."""
    post = get_object_or_404(Post, slug=slug, status='published')

    if request.method == 'POST':
        form = CommentForm(request.POST)
        if form.is_valid():
            comment = form.save(commit=False)
            comment.post = post
            if request.user.is_authenticated:
                comment.author = request.user
            comment.save()

            if request.headers.get('HX-Request'):
                return render(request, "{{ app_name }}/partials/comment.html", {'comment': comment})
            return redirect('{{ app_name }}:post_detail', slug=slug)

    return HttpResponse(status=400)


def like_post(request, slug):
    """Like/unlike a post (HTMX)."""
    post = get_object_or_404(Post, slug=slug, status='published')

    if request.user.is_authenticated:
        from .models import PostLike
        like, created = PostLike.objects.get_or_create(post=post, user=request.user)
        if not created:
            like.delete()
            liked = False
        else:
            liked = True

        if request.headers.get('HX-Request'):
            return render(request, "{{ app_name }}/partials/like_button.html", {
                'post': post,
                'liked': liked,
                'like_count': post.likes.count()
            })

    return redirect('{{ app_name }}:post_detail', slug=slug)


# URL name mappings for compatibility
post_list = PostListView.as_view()
post_detail = PostDetailView.as_view()
category_list = CategoryListView.as_view()
