"""
Blog Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - Blog Template

Shared pytest fixtures for blog tests.
"""

import pytest
from django.utils import timezone

from apps.blog.models import Category, Tag, Post, Comment, NewsletterSubscriber, PostLike


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def author(db):
    """Create a blog author."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="blogger",
        email="blogger@example.com",
        password="testpass123"
    )


@pytest.fixture
def other_author(db):
    """Create another author for multi-author tests."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="other_blogger",
        email="other@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, author):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=author)
    return api_client


# =============================================================================
# Category Fixtures
# =============================================================================

@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(
        name="Technology",
        description="Tech articles and tutorials"
    )


@pytest.fixture
def multiple_categories(db):
    """Create multiple categories."""
    return [
        Category.objects.create(name="Technology"),
        Category.objects.create(name="Lifestyle"),
        Category.objects.create(name="Travel"),
    ]


# =============================================================================
# Tag Fixtures
# =============================================================================

@pytest.fixture
def tag(db):
    """Create a test tag."""
    return Tag.objects.create(name="python")


@pytest.fixture
def multiple_tags(db):
    """Create multiple tags."""
    return [
        Tag.objects.create(name="python"),
        Tag.objects.create(name="django"),
        Tag.objects.create(name="web"),
    ]


# =============================================================================
# Post Fixtures
# =============================================================================

@pytest.fixture
def post(db, author, category):
    """Create a published post."""
    return Post.objects.create(
        title="Test Post",
        content="This is a test blog post with enough content to be meaningful.",
        author=author,
        category=category,
        status="published",
        published_at=timezone.now()
    )


@pytest.fixture
def draft_post(db, author, category):
    """Create a draft post."""
    return Post.objects.create(
        title="Draft Post",
        content="This is a draft post.",
        author=author,
        category=category,
        status="draft"
    )


@pytest.fixture
def featured_post(db, author, category):
    """Create a featured post."""
    return Post.objects.create(
        title="Featured Post",
        content="This is a featured post.",
        author=author,
        category=category,
        status="published",
        published_at=timezone.now(),
        is_featured=True
    )


@pytest.fixture
def multiple_posts(db, author, category):
    """Create multiple posts."""
    posts = []
    for i in range(5):
        posts.append(Post.objects.create(
            title=f"Post {i+1}",
            content=f"Content for post {i+1}",
            author=author,
            category=category,
            status="published",
            published_at=timezone.now()
        ))
    return posts


# =============================================================================
# Comment Fixtures
# =============================================================================

@pytest.fixture
def comment(db, post, author):
    """Create an approved comment."""
    return Comment.objects.create(
        post=post,
        author=author,
        content="Great article!",
        is_approved=True
    )


@pytest.fixture
def guest_comment(db, post):
    """Create a guest comment."""
    return Comment.objects.create(
        post=post,
        author_name="John Doe",
        author_email="john@example.com",
        content="Nice post!",
        is_approved=True
    )


@pytest.fixture
def comment_with_replies(db, post, author, other_author):
    """Create a comment with replies."""
    parent = Comment.objects.create(
        post=post,
        author=author,
        content="Parent comment",
        is_approved=True
    )
    reply = Comment.objects.create(
        post=post,
        author=other_author,
        content="Reply to parent",
        parent=parent,
        is_approved=True
    )
    return parent, reply


# =============================================================================
# Newsletter Fixtures
# =============================================================================

@pytest.fixture
def subscriber(db):
    """Create a newsletter subscriber."""
    return NewsletterSubscriber.objects.create(
        email="subscriber@example.com",
        confirmed_at=timezone.now()
    )


# =============================================================================
# Post Like Fixtures
# =============================================================================

@pytest.fixture
def post_like(db, post, author):
    """Create a post like."""
    return PostLike.objects.create(post=post, user=author)
