"""
Blog Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Blog Template

Tests for blog models: Category, Tag, Post, Comment, PostLike, NewsletterSubscriber.
"""

import pytest
from django.utils import timezone
from django.db import IntegrityError

from apps.blog.models import (
    Category, Tag, Post, Comment, NewsletterSubscriber, PostLike
)


# =============================================================================
# Category Tests
# =============================================================================

class TestCategory:
    """Tests for Category model."""

    def test_create_category(self, db):
        """Test creating a category."""
        category = Category.objects.create(
            name="Technology",
            description="Tech articles"
        )
        assert category.id is not None
        assert category.slug == "technology"
        assert category.is_active is True

    def test_category_hierarchy(self, db):
        """Test parent-child category relationship."""
        parent = Category.objects.create(name="Programming")
        child = Category.objects.create(name="Python", parent=parent)

        assert child.parent == parent
        assert child in parent.children.all()

    def test_category_post_count(self, db, author):
        """Test post_count property."""
        category = Category.objects.create(name="News")
        Post.objects.create(
            title="Post 1",
            content="Content",
            author=author,
            category=category,
            status="published",
            published_at=timezone.now()
        )
        Post.objects.create(
            title="Draft Post",
            content="Content",
            author=author,
            category=category,
            status="draft"
        )
        assert category.post_count == 1  # Only published


# =============================================================================
# Tag Tests
# =============================================================================

class TestTag:
    """Tests for Tag model."""

    def test_create_tag(self, db):
        """Test creating a tag."""
        tag = Tag.objects.create(name="Django")
        assert tag.slug == "django"

    def test_tag_unique(self, db):
        """Test tag name uniqueness."""
        Tag.objects.create(name="Python")
        with pytest.raises(IntegrityError):
            Tag.objects.create(name="Python")


# =============================================================================
# Post Tests
# =============================================================================

class TestPost:
    """Tests for Post model."""

    def test_create_post(self, db, author, category):
        """Test creating a post."""
        post = Post.objects.create(
            title="My First Post",
            content="This is my first blog post.",
            author=author,
            category=category
        )
        assert post.id is not None
        assert post.slug == "my-first-post"
        assert post.status == "draft"
        assert post.reading_time >= 1

    def test_post_auto_publish_date(self, db, author):
        """Test auto-setting published_at when publishing."""
        post = Post.objects.create(
            title="Test Post",
            content="Content",
            author=author,
            status="published"
        )
        assert post.published_at is not None

    def test_post_reading_time(self, db, author):
        """Test reading time calculation."""
        # 400 words = ~2 minutes
        content = " ".join(["word"] * 400)
        post = Post.objects.create(
            title="Long Post",
            content=content,
            author=author
        )
        assert post.reading_time == 2

    def test_post_is_published(self, db, author):
        """Test is_published property."""
        post = Post.objects.create(
            title="Published Post",
            content="Content",
            author=author,
            status="published",
            published_at=timezone.now()
        )
        assert post.is_published is True

        draft = Post.objects.create(
            title="Draft Post",
            content="Content",
            author=author,
            status="draft"
        )
        assert draft.is_published is False

    def test_post_comment_count(self, db, post, author):
        """Test comment_count property."""
        Comment.objects.create(
            post=post, content="Great!", author=author, is_approved=True
        )
        Comment.objects.create(
            post=post, content="Spam", author=author, is_approved=False
        )
        assert post.comment_count == 1  # Only approved

    def test_post_tags(self, db, post):
        """Test adding tags to post."""
        tag1 = Tag.objects.create(name="Python")
        tag2 = Tag.objects.create(name="Django")
        post.tags.add(tag1, tag2)

        assert post.tags.count() == 2


# =============================================================================
# Comment Tests
# =============================================================================

class TestComment:
    """Tests for Comment model."""

    def test_create_authenticated_comment(self, db, post, author):
        """Test creating a comment as authenticated user."""
        comment = Comment.objects.create(
            post=post,
            author=author,
            content="Great article!"
        )
        assert comment.get_author_name() == author.username

    def test_create_guest_comment(self, db, post):
        """Test creating a guest comment."""
        comment = Comment.objects.create(
            post=post,
            author_name="John Doe",
            author_email="john@example.com",
            content="Nice post!"
        )
        assert comment.get_author_name() == "John Doe"

    def test_nested_comments(self, db, post, author):
        """Test comment replies."""
        parent = Comment.objects.create(
            post=post, author=author, content="Parent comment"
        )
        reply = Comment.objects.create(
            post=post, author=author, content="Reply", parent=parent
        )
        assert reply.parent == parent
        assert reply in parent.replies.all()


# =============================================================================
# Newsletter Tests
# =============================================================================

class TestNewsletterSubscriber:
    """Tests for NewsletterSubscriber model."""

    def test_subscribe(self, db):
        """Test newsletter subscription."""
        subscriber = NewsletterSubscriber.objects.create(
            email="subscriber@example.com"
        )
        assert subscriber.is_active is True
        assert subscriber.confirmed_at is None

    def test_unique_email(self, db):
        """Test email uniqueness."""
        NewsletterSubscriber.objects.create(email="test@example.com")
        with pytest.raises(IntegrityError):
            NewsletterSubscriber.objects.create(email="test@example.com")


# =============================================================================
# PostLike Tests
# =============================================================================

class TestPostLike:
    """Tests for PostLike model."""

    def test_like_post(self, db, post, author):
        """Test liking a post."""
        like = PostLike.objects.create(post=post, user=author)
        assert like.post == post
        assert like.user == author

    def test_unique_like(self, db, post, author):
        """Test user can only like once."""
        PostLike.objects.create(post=post, user=author)
        with pytest.raises(IntegrityError):
            PostLike.objects.create(post=post, user=author)


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def author(db):
    """Create an author user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="blogger",
        email="blogger@example.com",
        password="testpass123"
    )


@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(name="Technology")


@pytest.fixture
def post(db, author, category):
    """Create a test post."""
    return Post.objects.create(
        title="Test Post",
        content="This is a test blog post with some content.",
        author=author,
        category=category,
        status="published",
        published_at=timezone.now()
    )
