"""
Blog API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Blog Template

Tests for blog API endpoints.
"""

import pytest
from rest_framework import status
from django.utils import timezone

from apps.blog.models import Category, Tag, Post, Comment


# =============================================================================
# Category API Tests
# =============================================================================

class TestCategoryAPI:
    """Tests for Category API endpoints."""

    def test_list_categories(self, api_client, category):
        """Test listing categories."""
        response = api_client.get("/api/v1/blog/categories/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_category(self, api_client, category):
        """Test retrieving a category by slug."""
        response = api_client.get(f"/api/v1/blog/categories/{category.slug}/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Post API Tests
# =============================================================================

class TestPostAPI:
    """Tests for Post API endpoints."""

    def test_list_posts(self, api_client, post):
        """Test listing published posts."""
        response = api_client.get("/api/v1/blog/posts/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_post(self, api_client, post):
        """Test retrieving a post by slug."""
        response = api_client.get(f"/api/v1/blog/posts/{post.slug}/")
        assert response.status_code == status.HTTP_200_OK

    def test_filter_posts_by_category(self, api_client, post, category):
        """Test filtering posts by category."""
        response = api_client.get(f"/api/v1/blog/posts/?category={category.slug}")
        assert response.status_code == status.HTTP_200_OK

    def test_filter_posts_by_tag(self, api_client, post):
        """Test filtering posts by tag."""
        tag = Tag.objects.create(name="python")
        post.tags.add(tag)
        response = api_client.get(f"/api/v1/blog/posts/?tag={tag.slug}")
        assert response.status_code == status.HTTP_200_OK

    def test_search_posts(self, api_client, post):
        """Test searching posts."""
        response = api_client.get(f"/api/v1/blog/posts/?search={post.title[:4]}")
        assert response.status_code == status.HTTP_200_OK

    def test_create_post_authenticated(self, auth_api_client, category, author):
        """Test creating a post as authenticated author."""
        response = auth_api_client.post("/api/v1/blog/posts/", {
            "title": "New Post",
            "content": "This is the content of my new post.",
            "category": str(category.id)
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_403_FORBIDDEN]

    def test_create_post_unauthenticated(self, api_client, category):
        """Test creating a post requires authentication."""
        response = api_client.post("/api/v1/blog/posts/", {
            "title": "New Post",
            "content": "Content"
        })
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]

    def test_update_own_post(self, auth_api_client, post, author):
        """Test author can update own post."""
        response = auth_api_client.patch(f"/api/v1/blog/posts/{post.slug}/", {
            "title": "Updated Title"
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_403_FORBIDDEN]


# =============================================================================
# Comment API Tests
# =============================================================================

class TestCommentAPI:
    """Tests for Comment API endpoints."""

    def test_list_post_comments(self, api_client, post, comment):
        """Test listing comments on a post."""
        response = api_client.get(f"/api/v1/blog/posts/{post.slug}/comments/")
        assert response.status_code == status.HTTP_200_OK

    def test_create_comment_authenticated(self, auth_api_client, post, author):
        """Test creating a comment as authenticated user."""
        response = auth_api_client.post(f"/api/v1/blog/posts/{post.slug}/comments/", {
            "content": "Great article!"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_create_guest_comment(self, api_client, post):
        """Test creating a guest comment."""
        response = api_client.post(f"/api/v1/blog/posts/{post.slug}/comments/", {
            "author_name": "John",
            "author_email": "john@example.com",
            "content": "Nice post!"
        })
        # Guest comments may be allowed or require approval
        assert response.status_code in [
            status.HTTP_201_CREATED,
            status.HTTP_200_OK,
            status.HTTP_401_UNAUTHORIZED,
            status.HTTP_403_FORBIDDEN
        ]

    def test_reply_to_comment(self, auth_api_client, post, comment, author):
        """Test replying to a comment."""
        response = auth_api_client.post(f"/api/v1/blog/posts/{post.slug}/comments/", {
            "content": "Thanks for your feedback!",
            "parent": str(comment.id)
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]


# =============================================================================
# Tag API Tests
# =============================================================================

class TestTagAPI:
    """Tests for Tag API endpoints."""

    def test_list_tags(self, api_client, db):
        """Test listing tags."""
        Tag.objects.create(name="python")
        Tag.objects.create(name="django")
        response = api_client.get("/api/v1/blog/tags/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Post Like API Tests
# =============================================================================

class TestPostLikeAPI:
    """Tests for Post Like API endpoints."""

    def test_like_post(self, auth_api_client, post, author):
        """Test liking a post."""
        response = auth_api_client.post(f"/api/v1/blog/posts/{post.slug}/like/")
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_unlike_post(self, auth_api_client, post, author):
        """Test unliking a post."""
        # First like
        auth_api_client.post(f"/api/v1/blog/posts/{post.slug}/like/")
        # Then unlike
        response = auth_api_client.delete(f"/api/v1/blog/posts/{post.slug}/like/")
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_204_NO_CONTENT]


# =============================================================================
# Newsletter API Tests
# =============================================================================

class TestNewsletterAPI:
    """Tests for Newsletter API endpoints."""

    def test_subscribe(self, api_client):
        """Test subscribing to newsletter."""
        response = api_client.post("/api/v1/blog/newsletter/subscribe/", {
            "email": "subscriber@example.com"
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_subscribe_duplicate(self, api_client, db):
        """Test duplicate subscription handling."""
        from apps.blog.models import NewsletterSubscriber
        NewsletterSubscriber.objects.create(email="existing@example.com")
        response = api_client.post("/api/v1/blog/newsletter/subscribe/", {
            "email": "existing@example.com"
        })
        # Should either accept (idempotent) or reject
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, author):
    """Create authenticated API client."""
    api_client.force_authenticate(user=author)
    return api_client


@pytest.fixture
def author(db):
    """Create an author user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="blogger",
        email="blogger@example.com",
        password="testpass123"
    )


@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(name="Technology")


@pytest.fixture
def post(db, author, category):
    """Create a test post."""
    return Post.objects.create(
        title="Test Post",
        content="This is a test blog post.",
        author=author,
        category=category,
        status="published",
        published_at=timezone.now()
    )


@pytest.fixture
def comment(db, post, author):
    """Create a test comment."""
    return Comment.objects.create(
        post=post,
        author=author,
        content="Great article!",
        is_approved=True
    )
