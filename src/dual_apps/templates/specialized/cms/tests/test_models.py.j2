"""
CMS Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - CMS Template

Tests for CMS models: Page, PageBlock, Menu, MenuItem, MediaFile, Form.
"""

import pytest
from django.db import IntegrityError

from apps.pages.models import Page, PageBlock, Menu, MenuItem, Redirect
from apps.media.models import MediaFolder, MediaFile, Form, FormField, FormSubmission


# =============================================================================
# Page Tests
# =============================================================================

class TestPage:
    """Tests for Page model."""

    def test_create_page(self, db, author):
        """Test creating a page."""
        page = Page.objects.create(
            title="About Us",
            content="About us content",
            author=author
        )
        assert page.id is not None
        assert page.slug == "about-us"
        assert page.status == "draft"

    def test_page_hierarchy(self, db, author):
        """Test page hierarchy."""
        parent = Page.objects.create(title="Services", author=author)
        child = Page.objects.create(title="Web Development", parent=parent, author=author)

        assert child.parent == parent
        assert child in parent.children.all()

    def test_page_full_path(self, db, author):
        """Test full_path property."""
        parent = Page.objects.create(title="Services", author=author)
        child = Page.objects.create(title="Web Dev", parent=parent, author=author)

        assert child.full_path == "/services/web-dev"

    def test_unique_homepage(self, db, author):
        """Test only one homepage allowed."""
        Page.objects.create(title="Home 1", is_homepage=True, author=author)
        Page.objects.create(title="Home 2", is_homepage=True, author=author)

        # Only one should be homepage
        assert Page.objects.filter(is_homepage=True).count() == 1


# =============================================================================
# PageBlock Tests
# =============================================================================

class TestPageBlock:
    """Tests for PageBlock model."""

    def test_create_block(self, db, page):
        """Test creating a page block."""
        block = PageBlock.objects.create(
            page=page,
            block_type="text",
            title="Introduction",
            content="Welcome to our site!"
        )
        assert block.is_active is True
        assert block.order == 0

    def test_block_ordering(self, db, page):
        """Test block ordering."""
        block1 = PageBlock.objects.create(page=page, block_type="text", order=1)
        block2 = PageBlock.objects.create(page=page, block_type="image", order=0)

        blocks = list(page.blocks.all())
        assert blocks[0] == block2
        assert blocks[1] == block1


# =============================================================================
# Menu Tests
# =============================================================================

class TestMenu:
    """Tests for Menu model."""

    def test_create_menu(self, db):
        """Test creating a menu."""
        menu = Menu.objects.create(
            name="Main Navigation",
            slug="main-nav",
            location="header"
        )
        assert menu.id is not None

    def test_menu_items(self, db, menu, page):
        """Test adding items to menu."""
        item = MenuItem.objects.create(
            menu=menu,
            title="Home",
            page=page
        )
        assert item.link == page.full_path

    def test_menu_item_external_url(self, db, menu):
        """Test menu item with external URL."""
        item = MenuItem.objects.create(
            menu=menu,
            title="External",
            url="https://example.com"
        )
        assert item.link == "https://example.com"

    def test_nested_menu_items(self, db, menu, page):
        """Test nested menu items."""
        parent = MenuItem.objects.create(menu=menu, title="Parent", page=page)
        child = MenuItem.objects.create(menu=menu, title="Child", parent=parent)

        assert child.parent == parent
        assert child in parent.children.all()


# =============================================================================
# Media Tests
# =============================================================================

class TestMediaFolder:
    """Tests for MediaFolder model."""

    def test_create_folder(self, db):
        """Test creating a folder."""
        folder = MediaFolder.objects.create(name="Images")
        assert folder.id is not None

    def test_nested_folders(self, db):
        """Test nested folders."""
        parent = MediaFolder.objects.create(name="Media")
        child = MediaFolder.objects.create(name="2024", parent=parent)

        assert child.parent == parent


class TestMediaFile:
    """Tests for MediaFile model."""

    def test_create_media_file(self, db, author):
        """Test creating a media file."""
        # Note: In real tests, you'd use SimpleUploadedFile
        file = MediaFile.objects.create(
            name="test-image.jpg",
            file="test/path/image.jpg",
            file_type="image",
            uploaded_by=author
        )
        assert file.id is not None


# =============================================================================
# Form Tests
# =============================================================================

class TestForm:
    """Tests for Form model."""

    def test_create_form(self, db):
        """Test creating a form."""
        form = Form.objects.create(
            name="Contact Form",
            slug="contact",
            success_message="Thank you for contacting us!"
        )
        assert form.is_active is True

    def test_form_fields(self, db, form):
        """Test adding fields to form."""
        field = FormField.objects.create(
            form=form,
            field_type="email",
            name="email",
            label="Email Address",
            is_required=True
        )
        assert field.form == form


class TestFormSubmission:
    """Tests for FormSubmission model."""

    def test_create_submission(self, db, form):
        """Test creating a form submission."""
        submission = FormSubmission.objects.create(
            form=form,
            data={"name": "John", "email": "john@example.com"},
            ip_address="127.0.0.1"
        )
        assert submission.is_read is False
        assert submission.is_spam is False


# =============================================================================
# Redirect Tests
# =============================================================================

class TestRedirect:
    """Tests for Redirect model."""

    def test_create_redirect(self, db):
        """Test creating a redirect."""
        redirect = Redirect.objects.create(
            from_path="/old-page",
            to_path="/new-page",
            redirect_type="301"
        )
        assert redirect.is_active is True

    def test_unique_from_path(self, db):
        """Test from_path uniqueness."""
        Redirect.objects.create(from_path="/page", to_path="/new-page")
        with pytest.raises(IntegrityError):
            Redirect.objects.create(from_path="/page", to_path="/other-page")


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def author(db):
    """Create an author user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="editor",
        email="editor@example.com",
        password="testpass123"
    )


@pytest.fixture
def page(db, author):
    """Create a test page."""
    return Page.objects.create(
        title="Test Page",
        content="Test content",
        author=author,
        status="published"
    )


@pytest.fixture
def menu(db):
    """Create a test menu."""
    return Menu.objects.create(
        name="Main Menu",
        slug="main-menu",
        location="header"
    )


@pytest.fixture
def form(db):
    """Create a test form."""
    return Form.objects.create(
        name="Contact Form",
        slug="contact"
    )
