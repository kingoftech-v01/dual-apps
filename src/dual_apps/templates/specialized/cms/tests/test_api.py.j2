"""
CMS API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - CMS Template

Tests for CMS API endpoints.
"""

import pytest
from rest_framework import status

from apps.pages.models import Page, PageBlock, Menu, MenuItem
from apps.media.models import MediaFile, Form, FormSubmission


# =============================================================================
# Page API Tests
# =============================================================================

class TestPageAPI:
    """Tests for Page API endpoints."""

    def test_list_pages(self, api_client, page):
        """Test listing published pages."""
        response = api_client.get("/api/v1/pages/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_page_by_slug(self, api_client, page):
        """Test retrieving a page by slug."""
        response = api_client.get(f"/api/v1/pages/{page.slug}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["title"] == page.title

    def test_create_page_admin(self, admin_api_client, author):
        """Test creating a page as admin."""
        response = admin_api_client.post("/api/v1/pages/", {
            "title": "New Page",
            "content": "New content"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_update_page_admin(self, admin_api_client, page):
        """Test updating a page as admin."""
        response = admin_api_client.patch(f"/api/v1/pages/{page.slug}/", {
            "title": "Updated Title"
        })
        assert response.status_code == status.HTTP_200_OK

    def test_create_page_unauthenticated(self, api_client):
        """Test creating page requires authentication."""
        response = api_client.post("/api/v1/pages/", {"title": "Test"})
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]


# =============================================================================
# Page Block API Tests
# =============================================================================

class TestPageBlockAPI:
    """Tests for PageBlock API endpoints."""

    def test_list_page_blocks(self, api_client, page, block):
        """Test listing page blocks."""
        response = api_client.get(f"/api/v1/pages/{page.slug}/blocks/")
        assert response.status_code == status.HTTP_200_OK

    def test_create_block_admin(self, admin_api_client, page):
        """Test creating a block as admin."""
        response = admin_api_client.post(f"/api/v1/pages/{page.slug}/blocks/", {
            "block_type": "text",
            "content": "New block content"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_reorder_blocks(self, admin_api_client, page, block):
        """Test reordering blocks."""
        response = admin_api_client.post(f"/api/v1/pages/{page.slug}/blocks/reorder/", {
            "order": [str(block.id)]
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Menu API Tests
# =============================================================================

class TestMenuAPI:
    """Tests for Menu API endpoints."""

    def test_list_menus(self, api_client, menu):
        """Test listing menus."""
        response = api_client.get("/api/v1/menus/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_menu_by_slug(self, api_client, menu):
        """Test retrieving menu by slug."""
        response = api_client.get(f"/api/v1/menus/{menu.slug}/")
        assert response.status_code == status.HTTP_200_OK

    def test_menu_with_items(self, api_client, menu, menu_item):
        """Test menu includes items."""
        response = api_client.get(f"/api/v1/menus/{menu.slug}/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Media API Tests
# =============================================================================

class TestMediaAPI:
    """Tests for Media API endpoints."""

    def test_list_media(self, admin_api_client):
        """Test listing media files."""
        response = admin_api_client.get("/api/v1/media/")
        assert response.status_code == status.HTTP_200_OK

    def test_upload_media(self, admin_api_client):
        """Test uploading media file."""
        # Note: In real tests, use SimpleUploadedFile
        response = admin_api_client.post("/api/v1/media/upload/", {
            "name": "test.jpg"
        }, format="multipart")
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_201_CREATED,
            status.HTTP_400_BAD_REQUEST  # If file required
        ]

    def test_media_requires_auth(self, api_client):
        """Test media requires authentication."""
        response = api_client.get("/api/v1/media/")
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]


# =============================================================================
# Form API Tests
# =============================================================================

class TestFormAPI:
    """Tests for Form API endpoints."""

    def test_retrieve_form(self, api_client, form):
        """Test retrieving a form."""
        response = api_client.get(f"/api/v1/forms/{form.slug}/")
        assert response.status_code == status.HTTP_200_OK

    def test_submit_form(self, api_client, form_with_fields):
        """Test submitting a form."""
        form = form_with_fields
        response = api_client.post(f"/api/v1/forms/{form.slug}/submit/", {
            "email": "test@example.com",
            "message": "Hello"
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_list_submissions_admin(self, admin_api_client, form, submission):
        """Test listing form submissions as admin."""
        response = admin_api_client.get(f"/api/v1/forms/{form.slug}/submissions/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def admin_api_client(api_client, admin_user):
    """Create admin-authenticated API client."""
    api_client.force_authenticate(user=admin_user)
    return api_client


@pytest.fixture
def author(db):
    """Create an author user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="editor",
        email="editor@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


@pytest.fixture
def page(db, author):
    """Create a test page."""
    return Page.objects.create(
        title="Test Page",
        content="Test content",
        author=author,
        status="published"
    )


@pytest.fixture
def block(db, page):
    """Create a test block."""
    return PageBlock.objects.create(
        page=page,
        block_type="text",
        content="Block content"
    )


@pytest.fixture
def menu(db):
    """Create a test menu."""
    return Menu.objects.create(
        name="Main Menu",
        slug="main-menu",
        location="header"
    )


@pytest.fixture
def menu_item(db, menu, page):
    """Create a test menu item."""
    return MenuItem.objects.create(
        menu=menu,
        title="Home",
        page=page
    )


@pytest.fixture
def form(db):
    """Create a test form."""
    return Form.objects.create(
        name="Contact Form",
        slug="contact"
    )


@pytest.fixture
def form_with_fields(db, form):
    """Create a form with fields."""
    from apps.media.models import FormField
    FormField.objects.create(
        form=form,
        field_type="email",
        name="email",
        label="Email",
        is_required=True
    )
    FormField.objects.create(
        form=form,
        field_type="textarea",
        name="message",
        label="Message"
    )
    return form


@pytest.fixture
def submission(db, form):
    """Create a test submission."""
    return FormSubmission.objects.create(
        form=form,
        data={"email": "test@example.com"}
    )
