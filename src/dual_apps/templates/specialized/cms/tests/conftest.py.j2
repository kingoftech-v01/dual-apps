"""
CMS Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - CMS Template

Shared pytest fixtures for CMS tests.
"""

import pytest

from apps.pages.models import Page, PageBlock, Menu, MenuItem, Redirect
from apps.media.models import MediaFolder, MediaFile, Form, FormField, FormSubmission


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def author(db):
    """Create a content editor."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="editor",
        email="editor@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, author):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=author)
    return api_client


@pytest.fixture
def admin_api_client(api_client, admin_user):
    """Create an admin-authenticated API client."""
    api_client.force_authenticate(user=admin_user)
    return api_client


# =============================================================================
# Page Fixtures
# =============================================================================

@pytest.fixture
def page(db, author):
    """Create a published page."""
    return Page.objects.create(
        title="Test Page",
        slug="test-page",
        content="Test page content",
        author=author,
        status="published"
    )


@pytest.fixture
def draft_page(db, author):
    """Create a draft page."""
    return Page.objects.create(
        title="Draft Page",
        slug="draft-page",
        content="Draft content",
        author=author,
        status="draft"
    )


@pytest.fixture
def homepage(db, author):
    """Create a homepage."""
    return Page.objects.create(
        title="Home",
        slug="home",
        content="Welcome!",
        author=author,
        status="published",
        is_homepage=True
    )


@pytest.fixture
def page_hierarchy(db, author):
    """Create page hierarchy."""
    parent = Page.objects.create(
        title="Services",
        content="Services page",
        author=author,
        status="published"
    )
    child1 = Page.objects.create(
        title="Web Development",
        content="Web dev services",
        author=author,
        parent=parent,
        status="published"
    )
    child2 = Page.objects.create(
        title="Mobile Apps",
        content="Mobile services",
        author=author,
        parent=parent,
        status="published"
    )
    return parent, [child1, child2]


# =============================================================================
# Page Block Fixtures
# =============================================================================

@pytest.fixture
def block(db, page):
    """Create a text block."""
    return PageBlock.objects.create(
        page=page,
        block_type="text",
        title="Introduction",
        content="Welcome to our site!"
    )


@pytest.fixture
def multiple_blocks(db, page):
    """Create multiple blocks."""
    return [
        PageBlock.objects.create(
            page=page, block_type="text", content="Text block", order=0
        ),
        PageBlock.objects.create(
            page=page, block_type="image", settings={"url": "/img.jpg"}, order=1
        ),
        PageBlock.objects.create(
            page=page, block_type="cta", content="Call to action", order=2
        ),
    ]


# =============================================================================
# Menu Fixtures
# =============================================================================

@pytest.fixture
def menu(db):
    """Create a navigation menu."""
    return Menu.objects.create(
        name="Main Navigation",
        slug="main-nav",
        location="header"
    )


@pytest.fixture
def footer_menu(db):
    """Create a footer menu."""
    return Menu.objects.create(
        name="Footer Menu",
        slug="footer",
        location="footer"
    )


@pytest.fixture
def menu_item(db, menu, page):
    """Create a menu item."""
    return MenuItem.objects.create(
        menu=menu,
        title="Test Link",
        page=page,
        order=0
    )


@pytest.fixture
def menu_with_items(db, menu, page):
    """Create menu with multiple items."""
    items = [
        MenuItem.objects.create(menu=menu, title="Home", page=page, order=0),
        MenuItem.objects.create(menu=menu, title="About", url="/about", order=1),
        MenuItem.objects.create(menu=menu, title="Contact", url="/contact", order=2),
    ]
    return menu, items


# =============================================================================
# Media Fixtures
# =============================================================================

@pytest.fixture
def media_folder(db):
    """Create a media folder."""
    return MediaFolder.objects.create(name="Images")


@pytest.fixture
def media_file(db, author, media_folder):
    """Create a media file."""
    return MediaFile.objects.create(
        name="test-image.jpg",
        file="cms/media/test-image.jpg",
        file_type="image",
        folder=media_folder,
        uploaded_by=author
    )


# =============================================================================
# Form Fixtures
# =============================================================================

@pytest.fixture
def form(db):
    """Create a contact form."""
    return Form.objects.create(
        name="Contact Form",
        slug="contact",
        success_message="Thank you!"
    )


@pytest.fixture
def form_with_fields(db, form):
    """Create a form with fields."""
    FormField.objects.create(
        form=form, field_type="text", name="name", label="Name", is_required=True, order=0
    )
    FormField.objects.create(
        form=form, field_type="email", name="email", label="Email", is_required=True, order=1
    )
    FormField.objects.create(
        form=form, field_type="textarea", name="message", label="Message", order=2
    )
    return form


@pytest.fixture
def submission(db, form):
    """Create a form submission."""
    return FormSubmission.objects.create(
        form=form,
        data={"name": "John", "email": "john@example.com", "message": "Hello!"}
    )


# =============================================================================
# Redirect Fixtures
# =============================================================================

@pytest.fixture
def redirect(db):
    """Create a redirect."""
    return Redirect.objects.create(
        from_path="/old-page",
        to_path="/new-page",
        redirect_type="301"
    )
