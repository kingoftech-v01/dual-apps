"""
CMS Models for {{ project_name }}.
Generated by dual-apps v{{ version }} - CMS Template

Content Management System with pages, blocks, menus, and media.
"""

import uuid
from django.db import models
from django.conf import settings
from django.utils.text import slugify


class BaseModel(models.Model):
    """Abstract base model."""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


# =============================================================================
# Pages
# =============================================================================

class Page(BaseModel):
    """CMS Page."""
    STATUS_CHOICES = [
        ("draft", "Draft"),
        ("published", "Published"),
        ("archived", "Archived"),
    ]

    title = models.CharField(max_length=200)
    slug = models.SlugField(max_length=200, unique=True)
    content = models.TextField(blank=True)

    # Hierarchy
    parent = models.ForeignKey(
        "self", on_delete=models.SET_NULL,
        null=True, blank=True, related_name="children"
    )

    # Template
    template = models.CharField(max_length=100, default="cms/page.html")

    # SEO
    meta_title = models.CharField(max_length=70, blank=True)
    meta_description = models.CharField(max_length=160, blank=True)
    meta_keywords = models.CharField(max_length=255, blank=True)
    og_image = models.ImageField(upload_to="cms/og/", blank=True, null=True)

    # Status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="draft")
    published_at = models.DateTimeField(null=True, blank=True)

    # Options
    show_in_nav = models.BooleanField(default=True)
    is_homepage = models.BooleanField(default=False)
    order = models.PositiveIntegerField(default=0)

    # Author
    author = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL, null=True
    )

    class Meta:
        ordering = ["order", "title"]

    def __str__(self):
        return self.title

    def save(self, *args, **kwargs):
        if not self.slug:
            self.slug = slugify(self.title)
        # Only one homepage
        if self.is_homepage:
            Page.objects.filter(is_homepage=True).update(is_homepage=False)
        super().save(*args, **kwargs)

    @property
    def full_path(self):
        """Get full URL path."""
        if self.parent:
            return f"{self.parent.full_path}/{self.slug}"
        return f"/{self.slug}"


class PageBlock(BaseModel):
    """Content block within a page."""
    BLOCK_TYPES = [
        ("text", "Text"),
        ("html", "HTML"),
        ("image", "Image"),
        ("video", "Video"),
        ("gallery", "Gallery"),
        ("form", "Form"),
        ("map", "Map"),
        ("embed", "Embed"),
        ("code", "Code"),
        ("faq", "FAQ"),
        ("testimonial", "Testimonial"),
        ("cta", "Call to Action"),
        ("features", "Features"),
        ("pricing", "Pricing"),
        ("team", "Team"),
        ("contact", "Contact"),
    ]

    page = models.ForeignKey(Page, on_delete=models.CASCADE, related_name="blocks")
    block_type = models.CharField(max_length=20, choices=BLOCK_TYPES)
    title = models.CharField(max_length=200, blank=True)
    content = models.TextField(blank=True)
    settings = models.JSONField(default=dict, blank=True)
    order = models.PositiveIntegerField(default=0)
    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ["order"]

    def __str__(self):
        return f"{self.block_type} block on {self.page.title}"


# =============================================================================
# Menus
# =============================================================================

class Menu(BaseModel):
    """Navigation menu."""
    name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=100, unique=True)
    location = models.CharField(max_length=50, blank=True)  # header, footer, sidebar

    class Meta:
        ordering = ["name"]

    def __str__(self):
        return self.name


class MenuItem(BaseModel):
    """Menu item."""
    menu = models.ForeignKey(Menu, on_delete=models.CASCADE, related_name="items")
    parent = models.ForeignKey(
        "self", on_delete=models.CASCADE,
        null=True, blank=True, related_name="children"
    )
    title = models.CharField(max_length=100)

    # Link
    page = models.ForeignKey(Page, on_delete=models.SET_NULL, null=True, blank=True)
    url = models.CharField(max_length=255, blank=True)  # External or custom URL
    target = models.CharField(max_length=20, default="_self")  # _self, _blank

    # Display
    icon = models.CharField(max_length=50, blank=True)
    css_class = models.CharField(max_length=100, blank=True)
    order = models.PositiveIntegerField(default=0)
    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ["order"]

    def __str__(self):
        return self.title

    @property
    def link(self):
        if self.page:
            return self.page.full_path
        return self.url or "#"


# =============================================================================
# Media Library
# =============================================================================

class MediaFolder(BaseModel):
    """Folder for organizing media."""
    name = models.CharField(max_length=100)
    parent = models.ForeignKey(
        "self", on_delete=models.CASCADE,
        null=True, blank=True, related_name="children"
    )

    class Meta:
        ordering = ["name"]

    def __str__(self):
        return self.name


class MediaFile(BaseModel):
    """Media file."""
    FILE_TYPES = [
        ("image", "Image"),
        ("video", "Video"),
        ("audio", "Audio"),
        ("document", "Document"),
        ("other", "Other"),
    ]

    name = models.CharField(max_length=200)
    file = models.FileField(upload_to="cms/media/%Y/%m/")
    file_type = models.CharField(max_length=20, choices=FILE_TYPES, default="other")
    folder = models.ForeignKey(
        MediaFolder, on_delete=models.SET_NULL,
        null=True, blank=True, related_name="files"
    )

    # Metadata
    alt_text = models.CharField(max_length=200, blank=True)
    caption = models.TextField(blank=True)
    mime_type = models.CharField(max_length=100, blank=True)
    file_size = models.BigIntegerField(default=0)

    # Image dimensions
    width = models.PositiveIntegerField(null=True, blank=True)
    height = models.PositiveIntegerField(null=True, blank=True)

    # Uploader
    uploaded_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL, null=True
    )

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return self.name


# =============================================================================
# Forms
# =============================================================================

class Form(BaseModel):
    """Dynamic form builder."""
    name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=100, unique=True)
    description = models.TextField(blank=True)

    # Settings
    success_message = models.TextField(default="Thank you for your submission!")
    redirect_url = models.URLField(blank=True)
    email_notifications = models.EmailField(blank=True)

    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ["name"]

    def __str__(self):
        return self.name


class FormField(BaseModel):
    """Form field."""
    FIELD_TYPES = [
        ("text", "Text"),
        ("email", "Email"),
        ("number", "Number"),
        ("phone", "Phone"),
        ("textarea", "Textarea"),
        ("select", "Select"),
        ("radio", "Radio"),
        ("checkbox", "Checkbox"),
        ("file", "File"),
        ("date", "Date"),
        ("time", "Time"),
        ("datetime", "DateTime"),
        ("hidden", "Hidden"),
    ]

    form = models.ForeignKey(Form, on_delete=models.CASCADE, related_name="fields")
    field_type = models.CharField(max_length=20, choices=FIELD_TYPES)
    name = models.CharField(max_length=100)
    label = models.CharField(max_length=200)
    placeholder = models.CharField(max_length=200, blank=True)
    help_text = models.CharField(max_length=500, blank=True)
    default_value = models.CharField(max_length=500, blank=True)
    choices = models.TextField(blank=True)  # One per line for select/radio/checkbox
    is_required = models.BooleanField(default=False)
    order = models.PositiveIntegerField(default=0)

    class Meta:
        ordering = ["order"]

    def __str__(self):
        return f"{self.label} ({self.field_type})"


class FormSubmission(BaseModel):
    """Form submission."""
    form = models.ForeignKey(Form, on_delete=models.CASCADE, related_name="submissions")
    data = models.JSONField()
    ip_address = models.GenericIPAddressField(blank=True, null=True)
    user_agent = models.CharField(max_length=500, blank=True)
    is_read = models.BooleanField(default=False)
    is_spam = models.BooleanField(default=False)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"Submission to {self.form.name}"


# =============================================================================
# Redirects
# =============================================================================

class Redirect(BaseModel):
    """URL redirects."""
    REDIRECT_TYPES = [
        ("301", "Permanent (301)"),
        ("302", "Temporary (302)"),
    ]

    from_path = models.CharField(max_length=500, unique=True)
    to_path = models.CharField(max_length=500)
    redirect_type = models.CharField(max_length=3, choices=REDIRECT_TYPES, default="301")
    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ["from_path"]

    def __str__(self):
        return f"{self.from_path} â†’ {self.to_path}"
