"""
Marketplace Models for {{ project_name }}.
Generated by dual-apps v{{ version }} - Marketplace Template

Multi-vendor marketplace with vendors, products, commissions, and payouts.
"""

import uuid
from decimal import Decimal
from django.db import models
from django.conf import settings
from django.utils import timezone


class BaseModel(models.Model):
    """Abstract base model."""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


# =============================================================================
# Vendor / Seller
# =============================================================================

class Vendor(BaseModel):
    """Marketplace vendor/seller."""
    STATUS_CHOICES = [
        ("pending", "Pending Approval"),
        ("active", "Active"),
        ("suspended", "Suspended"),
        ("closed", "Closed"),
    ]

    # Owner
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="vendor"
    )

    # Store Info
    store_name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    logo = models.ImageField(upload_to="marketplace/vendors/logos/", blank=True, null=True)
    banner = models.ImageField(upload_to="marketplace/vendors/banners/", blank=True, null=True)

    # Contact
    email = models.EmailField()
    phone = models.CharField(max_length=20, blank=True)
    website = models.URLField(blank=True)

    # Address
    address_line1 = models.CharField(max_length=255, blank=True)
    address_line2 = models.CharField(max_length=255, blank=True)
    city = models.CharField(max_length=100, blank=True)
    state = models.CharField(max_length=100, blank=True)
    postal_code = models.CharField(max_length=20, blank=True)
    country = models.CharField(max_length=100, blank=True)

    # Status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="pending")
    is_featured = models.BooleanField(default=False)
    is_verified = models.BooleanField(default=False)

    # Commission rate (override default)
    commission_rate = models.DecimalField(
        max_digits=5, decimal_places=2,
        null=True, blank=True,
        help_text="Leave empty to use default platform rate"
    )

    # Stats
    total_sales = models.DecimalField(max_digits=12, decimal_places=2, default=Decimal("0.00"))
    total_orders = models.PositiveIntegerField(default=0)
    rating = models.DecimalField(max_digits=3, decimal_places=2, default=Decimal("0.00"))
    rating_count = models.PositiveIntegerField(default=0)

    # Settings
    settings = models.JSONField(default=dict, blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return self.store_name

    @property
    def effective_commission_rate(self):
        """Get commission rate (vendor-specific or default)."""
        if self.commission_rate is not None:
            return self.commission_rate
        return Decimal("10.00")  # Default 10%


class VendorDocument(BaseModel):
    """Vendor verification documents."""
    DOCUMENT_TYPES = [
        ("id", "ID Document"),
        ("business_license", "Business License"),
        ("tax_document", "Tax Document"),
        ("bank_statement", "Bank Statement"),
        ("other", "Other"),
    ]

    vendor = models.ForeignKey(
        Vendor, on_delete=models.CASCADE,
        related_name="documents"
    )
    document_type = models.CharField(max_length=20, choices=DOCUMENT_TYPES)
    file = models.FileField(upload_to="marketplace/vendors/documents/")
    is_verified = models.BooleanField(default=False)
    verified_at = models.DateTimeField(null=True, blank=True)
    notes = models.TextField(blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.vendor.store_name} - {self.document_type}"


# =============================================================================
# Products (Vendor Products)
# =============================================================================

class VendorProduct(BaseModel):
    """Product listed by a vendor."""
    STATUS_CHOICES = [
        ("draft", "Draft"),
        ("pending", "Pending Review"),
        ("active", "Active"),
        ("rejected", "Rejected"),
        ("out_of_stock", "Out of Stock"),
    ]

    vendor = models.ForeignKey(
        Vendor, on_delete=models.CASCADE,
        related_name="products"
    )

    # Basic
    name = models.CharField(max_length=255)
    slug = models.SlugField(max_length=255)
    description = models.TextField()
    short_description = models.CharField(max_length=500, blank=True)

    # Pricing
    price = models.DecimalField(max_digits=10, decimal_places=2)
    compare_at_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)

    # Inventory
    sku = models.CharField(max_length=50, blank=True)
    stock_quantity = models.PositiveIntegerField(default=0)
    track_inventory = models.BooleanField(default=True)

    # Status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="draft")
    rejection_reason = models.TextField(blank=True)

    # Stats
    view_count = models.PositiveIntegerField(default=0)
    sold_count = models.PositiveIntegerField(default=0)

    class Meta:
        unique_together = ["vendor", "slug"]
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.name} by {self.vendor.store_name}"


# =============================================================================
# Orders & Commissions
# =============================================================================

class VendorOrder(BaseModel):
    """Order items for a specific vendor (sub-order)."""
    STATUS_CHOICES = [
        ("pending", "Pending"),
        ("processing", "Processing"),
        ("shipped", "Shipped"),
        ("delivered", "Delivered"),
        ("cancelled", "Cancelled"),
        ("refunded", "Refunded"),
    ]

    # Link to main order (from e-commerce)
    order_number = models.CharField(max_length=50)

    vendor = models.ForeignKey(
        Vendor, on_delete=models.PROTECT,
        related_name="orders"
    )
    customer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL, null=True
    )

    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="pending")

    # Amounts
    subtotal = models.DecimalField(max_digits=10, decimal_places=2)
    commission_rate = models.DecimalField(max_digits=5, decimal_places=2)
    commission_amount = models.DecimalField(max_digits=10, decimal_places=2)
    vendor_earnings = models.DecimalField(max_digits=10, decimal_places=2)

    # Shipping
    shipping_cost = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    tracking_number = models.CharField(max_length=100, blank=True)
    carrier = models.CharField(max_length=50, blank=True)

    # Timestamps
    shipped_at = models.DateTimeField(null=True, blank=True)
    delivered_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"Vendor Order {self.order_number} - {self.vendor.store_name}"

    def save(self, *args, **kwargs):
        if not self.commission_rate:
            self.commission_rate = self.vendor.effective_commission_rate
        if not self.commission_amount:
            self.commission_amount = self.subtotal * (self.commission_rate / 100)
        if not self.vendor_earnings:
            self.vendor_earnings = self.subtotal - self.commission_amount
        super().save(*args, **kwargs)


class VendorOrderItem(BaseModel):
    """Items in a vendor order."""
    vendor_order = models.ForeignKey(
        VendorOrder, on_delete=models.CASCADE,
        related_name="items"
    )
    product = models.ForeignKey(
        VendorProduct, on_delete=models.SET_NULL, null=True
    )
    product_name = models.CharField(max_length=255)
    quantity = models.PositiveIntegerField(default=1)
    unit_price = models.DecimalField(max_digits=10, decimal_places=2)
    total = models.DecimalField(max_digits=10, decimal_places=2)

    def __str__(self):
        return f"{self.quantity}x {self.product_name}"


# =============================================================================
# Payouts
# =============================================================================

class Payout(BaseModel):
    """Vendor payout."""
    STATUS_CHOICES = [
        ("pending", "Pending"),
        ("processing", "Processing"),
        ("completed", "Completed"),
        ("failed", "Failed"),
    ]

    vendor = models.ForeignKey(
        Vendor, on_delete=models.CASCADE,
        related_name="payouts"
    )
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=3, default="USD")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="pending")

    # Payment details
    payment_method = models.CharField(max_length=50)  # bank_transfer, paypal, stripe
    payment_reference = models.CharField(max_length=100, blank=True)

    # Period
    period_start = models.DateField()
    period_end = models.DateField()

    # Breakdown
    gross_amount = models.DecimalField(max_digits=10, decimal_places=2)
    fees = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    net_amount = models.DecimalField(max_digits=10, decimal_places=2)

    # Timestamps
    processed_at = models.DateTimeField(null=True, blank=True)
    failed_reason = models.TextField(blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"Payout ${self.amount} to {self.vendor.store_name}"


class PayoutItem(BaseModel):
    """Individual earnings included in a payout."""
    payout = models.ForeignKey(
        Payout, on_delete=models.CASCADE,
        related_name="items"
    )
    vendor_order = models.ForeignKey(
        VendorOrder, on_delete=models.SET_NULL, null=True
    )
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    description = models.CharField(max_length=255)

    def __str__(self):
        return f"${self.amount} - {self.description}"


# =============================================================================
# Vendor Bank Account
# =============================================================================

class VendorBankAccount(BaseModel):
    """Vendor payout bank account."""
    vendor = models.ForeignKey(
        Vendor, on_delete=models.CASCADE,
        related_name="bank_accounts"
    )
    account_holder_name = models.CharField(max_length=100)
    account_number_last4 = models.CharField(max_length=4)
    bank_name = models.CharField(max_length=100)
    routing_number = models.CharField(max_length=20, blank=True)

    # Stripe Connect
    stripe_account_id = models.CharField(max_length=100, blank=True)

    is_default = models.BooleanField(default=False)
    is_verified = models.BooleanField(default=False)

    class Meta:
        ordering = ["-is_default", "-created_at"]

    def __str__(self):
        return f"{self.bank_name} ****{self.account_number_last4}"


# =============================================================================
# Vendor Reviews
# =============================================================================

class VendorReview(BaseModel):
    """Review for vendor."""
    vendor = models.ForeignKey(
        Vendor, on_delete=models.CASCADE,
        related_name="reviews"
    )
    customer = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="vendor_reviews"
    )
    order = models.ForeignKey(
        VendorOrder, on_delete=models.SET_NULL,
        null=True, related_name="reviews"
    )
    rating = models.PositiveIntegerField()  # 1-5
    title = models.CharField(max_length=100, blank=True)
    comment = models.TextField(blank=True)
    is_approved = models.BooleanField(default=True)

    class Meta:
        unique_together = ["vendor", "customer", "order"]
        ordering = ["-created_at"]

    def __str__(self):
        return f"Review for {self.vendor.store_name}"


# =============================================================================
# Platform Settings
# =============================================================================

class MarketplaceSettings(BaseModel):
    """Global marketplace settings (singleton)."""
    default_commission_rate = models.DecimalField(
        max_digits=5, decimal_places=2,
        default=Decimal("10.00")
    )
    min_payout_amount = models.DecimalField(
        max_digits=10, decimal_places=2,
        default=Decimal("50.00")
    )
    payout_frequency = models.CharField(
        max_length=20,
        choices=[
            ("weekly", "Weekly"),
            ("biweekly", "Bi-weekly"),
            ("monthly", "Monthly"),
        ],
        default="monthly"
    )

    # Vendor settings
    auto_approve_vendors = models.BooleanField(default=False)
    auto_approve_products = models.BooleanField(default=False)

    # Fees
    payment_processing_fee_percent = models.DecimalField(
        max_digits=5, decimal_places=2,
        default=Decimal("2.9")
    )
    payment_processing_fee_fixed = models.DecimalField(
        max_digits=5, decimal_places=2,
        default=Decimal("0.30")
    )

    def __str__(self):
        return "Marketplace Settings"

    def save(self, *args, **kwargs):
        # Ensure only one instance
        self.pk = 1
        super().save(*args, **kwargs)

    @classmethod
    def get_settings(cls):
        obj, _ = cls.objects.get_or_create(pk=1)
        return obj
