import { useState, useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';
import { marketplaceAPI } from '../utils/api';
import ListingCard from '../components/listings/ListingCard';

export default function ListingsPage() {
  const [searchParams, setSearchParams] = useSearchParams();
  const [listings, setListings] = useState([]);
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({});
  
  const [filters, setFilters] = useState({
    q: searchParams.get('q') || '',
    category: searchParams.get('category') || '',
    min_price: searchParams.get('min_price') || '',
    max_price: searchParams.get('max_price') || '',
    condition: searchParams.getAll('condition') || [],
    sort: searchParams.get('sort') || '-created_at'
  });

  useEffect(() => {
    fetchCategories();
  }, []);

  useEffect(() => {
    fetchListings();
  }, [searchParams]);

  const fetchCategories = async () => {
    try {
      const response = await marketplaceAPI.getCategories();
      setCategories(response.data);
    } catch (error) {
      console.error('Failed to fetch categories:', error);
    }
  };

  const fetchListings = async () => {
    setLoading(true);
    try {
      const params = Object.fromEntries(searchParams.entries());
      const response = await marketplaceAPI.getListings(params);
      setListings(response.data.results);
      setPagination({
        count: response.data.count,
        next: response.data.next,
        previous: response.data.previous
      });
    } catch (error) {
      console.error('Failed to fetch listings:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleFilterChange = (name, value) => {
    setFilters(prev => ({ ...prev, [name]: value }));
  };

  const applyFilters = () => {
    const params = new URLSearchParams();
    Object.entries(filters).forEach(([key, value]) => {
      if (value && (typeof value !== 'object' || value.length > 0)) {
        if (Array.isArray(value)) {
          value.forEach(v => params.append(key, v));
        } else {
          params.set(key, value);
        }
      }
    });
    setSearchParams(params);
  };

  const loadMore = async () => {
    if (!pagination.next) return;
    try {
      const response = await marketplaceAPI.getListings({ page: new URL(pagination.next).searchParams.get('page') });
      setListings(prev => [...prev, ...response.data.results]);
      setPagination({
        count: response.data.count,
        next: response.data.next,
        previous: response.data.previous
      });
    } catch (error) {
      console.error('Failed to load more:', error);
    }
  };

  return (
    <div className="container-fluid py-4">
      <div className="row">
        {/* Filters Sidebar */}
        <div className="col-lg-3 mb-4">
          <div className="card sticky-top" style={{ top: '1rem' }}>
            <div className="card-header">
              <h6 className="mb-0">Filters</h6>
            </div>
            <div className="card-body">
              <div className="mb-3">
                <label className="form-label">Search</label>
                <input
                  type="text"
                  className="form-control"
                  placeholder="What are you looking for?"
                  value={filters.q}
                  onChange={(e) => handleFilterChange('q', e.target.value)}
                />
              </div>

              <div className="mb-3">
                <label className="form-label">Category</label>
                <select
                  className="form-select"
                  value={filters.category}
                  onChange={(e) => handleFilterChange('category', e.target.value)}
                >
                  <option value="">All Categories</option>
                  {categories.map(cat => (
                    <option key={cat.slug} value={cat.slug}>{cat.name}</option>
                  ))}
                </select>
              </div>

              <div className="mb-3">
                <label className="form-label">Price Range</label>
                <div className="row g-2">
                  <div className="col-6">
                    <input
                      type="number"
                      className="form-control"
                      placeholder="Min"
                      value={filters.min_price}
                      onChange={(e) => handleFilterChange('min_price', e.target.value)}
                    />
                  </div>
                  <div className="col-6">
                    <input
                      type="number"
                      className="form-control"
                      placeholder="Max"
                      value={filters.max_price}
                      onChange={(e) => handleFilterChange('max_price', e.target.value)}
                    />
                  </div>
                </div>
              </div>

              <div className="mb-3">
                <label className="form-label">Sort By</label>
                <select
                  className="form-select"
                  value={filters.sort}
                  onChange={(e) => handleFilterChange('sort', e.target.value)}
                >
                  <option value="-created_at">Newest First</option>
                  <option value="price">Price: Low to High</option>
                  <option value="-price">Price: High to Low</option>
                  <option value="-views">Most Viewed</option>
                </select>
              </div>

              <button className="btn btn-primary w-100" onClick={applyFilters}>
                Apply Filters
              </button>
            </div>
          </div>
        </div>

        {/* Listings Grid */}
        <div className="col-lg-9">
          <div className="d-flex justify-content-between align-items-center mb-3">
            <p className="mb-0 text-muted">{pagination.count || 0} listings found</p>
          </div>

          {loading ? (
            <div className="text-center py-5">
              <div className="spinner-border text-primary" role="status">
                <span className="visually-hidden">Loading...</span>
              </div>
            </div>
          ) : (
            <>
              <div className="row">
                {listings.map(listing => (
                  <div key={listing.id} className="col-md-6 col-lg-4 mb-4">
                    <ListingCard listing={listing} />
                  </div>
                ))}
                {listings.length === 0 && (
                  <div className="col-12 text-center py-5">
                    <div style={{ fontSize: '5rem' }}>ðŸ›’</div>
                    <h3>No listings found</h3>
                    <p className="text-muted">Try adjusting your filters</p>
                  </div>
                )}
              </div>

              {pagination.next && (
                <div className="text-center mt-4">
                  <button className="btn btn-outline-primary" onClick={loadMore}>
                    Load More
                  </button>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}
