"""
Marketplace Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - Marketplace Template

Shared pytest fixtures for marketplace tests.
"""

import pytest
from decimal import Decimal
from django.utils import timezone

from apps.vendors.models import Vendor, VendorDocument, VendorBankAccount, VendorReview
from apps.products.models import VendorProduct, VendorOrder, VendorOrderItem, Payout


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def vendor_user(db):
    """Create a vendor user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="vendoruser",
        email="vendor@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        email="customer@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, customer):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=customer)
    return api_client


@pytest.fixture
def vendor_api_client(api_client, vendor_user):
    """Create a vendor-authenticated API client."""
    api_client.force_authenticate(user=vendor_user)
    return api_client


@pytest.fixture
def admin_api_client(api_client, admin_user):
    """Create an admin-authenticated API client."""
    api_client.force_authenticate(user=admin_user)
    return api_client


# =============================================================================
# Vendor Fixtures
# =============================================================================

@pytest.fixture
def vendor(db, vendor_user):
    """Create an active vendor."""
    return Vendor.objects.create(
        user=vendor_user,
        store_name="Test Store",
        slug="test-store",
        description="A test store",
        email="store@example.com",
        status="active",
        is_verified=True
    )


@pytest.fixture
def pending_vendor(db):
    """Create a pending vendor."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    user = User.objects.create_user(
        username="pendingvendor",
        email="pending@example.com",
        password="testpass123"
    )
    return Vendor.objects.create(
        user=user,
        store_name="Pending Store",
        slug="pending-store",
        email="pending@example.com",
        status="pending"
    )


@pytest.fixture
def multiple_vendors(db):
    """Create multiple vendors."""
    from django.contrib.auth import get_user_model
    User = get_user_model()

    vendors = []
    for i in range(3):
        user = User.objects.create_user(
            username=f"vendor{i}",
            email=f"vendor{i}@example.com",
            password="testpass123"
        )
        vendors.append(Vendor.objects.create(
            user=user,
            store_name=f"Store {i}",
            slug=f"store-{i}",
            email=f"store{i}@example.com",
            status="active"
        ))
    return vendors


# =============================================================================
# Vendor Document Fixtures
# =============================================================================

@pytest.fixture
def vendor_document(db, vendor):
    """Create a vendor document."""
    return VendorDocument.objects.create(
        vendor=vendor,
        document_type="id",
        file="documents/id.pdf"
    )


# =============================================================================
# Product Fixtures
# =============================================================================

@pytest.fixture
def product(db, vendor):
    """Create an active product."""
    return VendorProduct.objects.create(
        vendor=vendor,
        name="Test Product",
        slug="test-product",
        description="A test product",
        price=Decimal("29.99"),
        stock_quantity=100,
        status="active"
    )


@pytest.fixture
def draft_product(db, vendor):
    """Create a draft product."""
    return VendorProduct.objects.create(
        vendor=vendor,
        name="Draft Product",
        slug="draft-product",
        description="A draft product",
        price=Decimal("19.99"),
        stock_quantity=50,
        status="draft"
    )


@pytest.fixture
def multiple_products(db, vendor):
    """Create multiple products."""
    products = []
    for i in range(5):
        products.append(VendorProduct.objects.create(
            vendor=vendor,
            name=f"Product {i}",
            slug=f"product-{i}",
            description=f"Description {i}",
            price=Decimal(f"{10 + i * 5}.99"),
            stock_quantity=10 * (i + 1),
            status="active"
        ))
    return products


# =============================================================================
# Order Fixtures
# =============================================================================

@pytest.fixture
def vendor_order(db, vendor, customer):
    """Create a vendor order."""
    return VendorOrder.objects.create(
        order_number="ORD-001",
        vendor=vendor,
        customer=customer,
        subtotal=Decimal("59.98"),
        status="pending"
    )


@pytest.fixture
def order_with_items(db, vendor_order, product):
    """Create an order with items."""
    item = VendorOrderItem.objects.create(
        vendor_order=vendor_order,
        product=product,
        product_name=product.name,
        quantity=2,
        unit_price=product.price,
        total=product.price * 2
    )
    return vendor_order, [item]


@pytest.fixture
def shipped_order(db, vendor, customer):
    """Create a shipped order."""
    return VendorOrder.objects.create(
        order_number="ORD-002",
        vendor=vendor,
        customer=customer,
        subtotal=Decimal("100.00"),
        status="shipped",
        tracking_number="TRACK123",
        carrier="UPS",
        shipped_at=timezone.now()
    )


@pytest.fixture
def delivered_order(db, vendor, customer):
    """Create a delivered order."""
    return VendorOrder.objects.create(
        order_number="ORD-003",
        vendor=vendor,
        customer=customer,
        subtotal=Decimal("75.00"),
        status="delivered",
        shipped_at=timezone.now() - timezone.timedelta(days=3),
        delivered_at=timezone.now()
    )


# =============================================================================
# Payout Fixtures
# =============================================================================

@pytest.fixture
def payout(db, vendor):
    """Create a payout."""
    today = timezone.now().date()
    return Payout.objects.create(
        vendor=vendor,
        amount=Decimal("500.00"),
        period_start=today - timezone.timedelta(days=30),
        period_end=today,
        gross_amount=Decimal("520.00"),
        fees=Decimal("20.00"),
        net_amount=Decimal("500.00"),
        payment_method="bank_transfer",
        status="completed",
        processed_at=timezone.now()
    )


@pytest.fixture
def pending_payout(db, vendor):
    """Create a pending payout."""
    today = timezone.now().date()
    return Payout.objects.create(
        vendor=vendor,
        amount=Decimal("300.00"),
        period_start=today - timezone.timedelta(days=30),
        period_end=today,
        gross_amount=Decimal("310.00"),
        fees=Decimal("10.00"),
        net_amount=Decimal("300.00"),
        payment_method="bank_transfer",
        status="pending"
    )


# =============================================================================
# Bank Account Fixtures
# =============================================================================

@pytest.fixture
def bank_account(db, vendor):
    """Create a bank account."""
    return VendorBankAccount.objects.create(
        vendor=vendor,
        account_holder_name="John Doe",
        account_number_last4="4242",
        bank_name="Test Bank",
        is_default=True,
        is_verified=True
    )


# =============================================================================
# Review Fixtures
# =============================================================================

@pytest.fixture
def review(db, vendor, customer, vendor_order):
    """Create a vendor review."""
    return VendorReview.objects.create(
        vendor=vendor,
        customer=customer,
        order=vendor_order,
        rating=5,
        title="Great seller!",
        comment="Fast shipping and quality products."
    )
