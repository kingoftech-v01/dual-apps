"""
Marketplace API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Marketplace Template

Tests for marketplace API endpoints.
"""

import pytest
from decimal import Decimal
from rest_framework import status
from django.utils import timezone

from apps.vendors.models import Vendor, VendorReview
from apps.products.models import VendorProduct, VendorOrder


# =============================================================================
# Vendor API Tests
# =============================================================================

class TestVendorAPI:
    """Tests for Vendor API endpoints."""

    def test_list_vendors(self, api_client, vendor):
        """Test listing active vendors."""
        response = api_client.get("/api/v1/vendors/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_vendor(self, api_client, vendor):
        """Test retrieving a vendor."""
        response = api_client.get(f"/api/v1/vendors/{vendor.slug}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["store_name"] == vendor.store_name

    def test_register_as_vendor(self, auth_api_client, customer):
        """Test registering as a vendor."""
        response = auth_api_client.post("/api/v1/vendors/register/", {
            "store_name": "My Store",
            "slug": "my-store",
            "email": "mystore@example.com",
            "description": "My awesome store"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_update_own_vendor(self, vendor_api_client, vendor):
        """Test vendor can update own store."""
        response = vendor_api_client.patch(f"/api/v1/vendors/{vendor.slug}/", {
            "description": "Updated description"
        })
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Vendor Product API Tests
# =============================================================================

class TestVendorProductAPI:
    """Tests for VendorProduct API endpoints."""

    def test_list_products(self, api_client, product):
        """Test listing active products."""
        response = api_client.get("/api/v1/products/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_product(self, api_client, product):
        """Test retrieving a product."""
        response = api_client.get(f"/api/v1/products/{product.vendor.slug}/{product.slug}/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_list_own_products(self, vendor_api_client, vendor, product):
        """Test vendor can list own products."""
        response = vendor_api_client.get("/api/v1/vendors/me/products/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_create_product(self, vendor_api_client, vendor):
        """Test vendor can create product."""
        response = vendor_api_client.post("/api/v1/vendors/me/products/", {
            "name": "New Product",
            "slug": "new-product",
            "description": "A new product",
            "price": "49.99",
            "stock_quantity": 50
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_vendor_update_product(self, vendor_api_client, vendor, product):
        """Test vendor can update own product."""
        response = vendor_api_client.patch(
            f"/api/v1/vendors/me/products/{product.slug}/",
            {"price": "39.99"}
        )
        assert response.status_code == status.HTTP_200_OK

    def test_filter_products_by_vendor(self, api_client, vendor, product):
        """Test filtering products by vendor."""
        response = api_client.get(f"/api/v1/products/?vendor={vendor.slug}")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Vendor Order API Tests
# =============================================================================

class TestVendorOrderAPI:
    """Tests for VendorOrder API endpoints."""

    def test_vendor_list_orders(self, vendor_api_client, vendor, vendor_order):
        """Test vendor can list orders."""
        response = vendor_api_client.get("/api/v1/vendors/me/orders/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_retrieve_order(self, vendor_api_client, vendor, vendor_order):
        """Test vendor can retrieve order."""
        response = vendor_api_client.get(f"/api/v1/vendors/me/orders/{vendor_order.id}/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_update_order_status(self, vendor_api_client, vendor, vendor_order):
        """Test vendor can update order status."""
        response = vendor_api_client.patch(
            f"/api/v1/vendors/me/orders/{vendor_order.id}/",
            {"status": "processing"}
        )
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_ship_order(self, vendor_api_client, vendor, vendor_order):
        """Test vendor can mark order as shipped."""
        response = vendor_api_client.post(
            f"/api/v1/vendors/me/orders/{vendor_order.id}/ship/",
            {"tracking_number": "TRACK123", "carrier": "UPS"}
        )
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]

    def test_customer_view_orders(self, auth_api_client, customer, vendor_order):
        """Test customer can view their orders."""
        response = auth_api_client.get("/api/v1/orders/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Payout API Tests
# =============================================================================

class TestPayoutAPI:
    """Tests for Payout API endpoints."""

    def test_vendor_list_payouts(self, vendor_api_client, vendor):
        """Test vendor can list payouts."""
        response = vendor_api_client.get("/api/v1/vendors/me/payouts/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_view_earnings(self, vendor_api_client, vendor):
        """Test vendor can view earnings summary."""
        response = vendor_api_client.get("/api/v1/vendors/me/earnings/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Vendor Review API Tests
# =============================================================================

class TestVendorReviewAPI:
    """Tests for VendorReview API endpoints."""

    def test_list_vendor_reviews(self, api_client, vendor, review):
        """Test listing vendor reviews."""
        response = api_client.get(f"/api/v1/vendors/{vendor.slug}/reviews/")
        assert response.status_code == status.HTTP_200_OK

    def test_create_review(self, auth_api_client, vendor, customer, vendor_order):
        """Test creating a vendor review."""
        response = auth_api_client.post(f"/api/v1/vendors/{vendor.slug}/reviews/", {
            "order": str(vendor_order.id),
            "rating": 5,
            "title": "Great seller",
            "comment": "Fast shipping!"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Bank Account API Tests
# =============================================================================

class TestBankAccountAPI:
    """Tests for VendorBankAccount API endpoints."""

    def test_vendor_list_bank_accounts(self, vendor_api_client, vendor):
        """Test vendor can list bank accounts."""
        response = vendor_api_client.get("/api/v1/vendors/me/bank-accounts/")
        assert response.status_code == status.HTTP_200_OK

    def test_vendor_add_bank_account(self, vendor_api_client, vendor):
        """Test vendor can add bank account."""
        response = vendor_api_client.post("/api/v1/vendors/me/bank-accounts/", {
            "account_holder_name": "John Doe",
            "account_number_last4": "4242",
            "bank_name": "Test Bank"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, customer):
    """Create authenticated API client."""
    api_client.force_authenticate(user=customer)
    return api_client


@pytest.fixture
def vendor_api_client(api_client, vendor_user):
    """Create vendor-authenticated API client."""
    api_client.force_authenticate(user=vendor_user)
    return api_client


@pytest.fixture
def vendor_user(db):
    """Create a vendor user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="vendoruser",
        email="vendor@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        email="customer@example.com",
        password="testpass123"
    )


@pytest.fixture
def vendor(db, vendor_user):
    """Create a vendor."""
    return Vendor.objects.create(
        user=vendor_user,
        store_name="Test Store",
        slug="test-store",
        email="store@example.com",
        status="active"
    )


@pytest.fixture
def product(db, vendor):
    """Create a vendor product."""
    return VendorProduct.objects.create(
        vendor=vendor,
        name="Test Product",
        slug="test-product",
        description="A test product",
        price=Decimal("29.99"),
        stock_quantity=100,
        status="active"
    )


@pytest.fixture
def vendor_order(db, vendor, customer):
    """Create a vendor order."""
    return VendorOrder.objects.create(
        order_number="ORD-001",
        vendor=vendor,
        customer=customer,
        subtotal=Decimal("59.98"),
        status="pending"
    )


@pytest.fixture
def review(db, vendor, customer, vendor_order):
    """Create a vendor review."""
    return VendorReview.objects.create(
        vendor=vendor,
        customer=customer,
        order=vendor_order,
        rating=5,
        title="Great!",
        comment="Excellent service"
    )
