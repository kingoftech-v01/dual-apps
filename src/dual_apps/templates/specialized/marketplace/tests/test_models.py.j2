"""
Marketplace Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - Marketplace Template

Tests for marketplace models: Vendor, VendorProduct, VendorOrder, Payout.
"""

import pytest
from decimal import Decimal
from django.utils import timezone
from django.db import IntegrityError

from apps.vendors.models import (
    Vendor, VendorDocument, VendorBankAccount, VendorReview, MarketplaceSettings
)
from apps.products.models import VendorProduct, VendorOrder, VendorOrderItem, Payout, PayoutItem


# =============================================================================
# Vendor Tests
# =============================================================================

class TestVendor:
    """Tests for Vendor model."""

    def test_create_vendor(self, db, vendor_user):
        """Test creating a vendor."""
        vendor = Vendor.objects.create(
            user=vendor_user,
            store_name="Test Store",
            slug="test-store",
            email="store@example.com"
        )
        assert vendor.id is not None
        assert vendor.status == "pending"
        assert vendor.total_sales == Decimal("0.00")

    def test_vendor_effective_commission_rate(self, db, vendor_user):
        """Test effective_commission_rate property."""
        # Without custom rate - uses default
        vendor = Vendor.objects.create(
            user=vendor_user,
            store_name="Store 1",
            slug="store-1",
            email="store1@example.com"
        )
        assert vendor.effective_commission_rate == Decimal("10.00")

        # With custom rate
        vendor.commission_rate = Decimal("15.00")
        vendor.save()
        assert vendor.effective_commission_rate == Decimal("15.00")


# =============================================================================
# VendorDocument Tests
# =============================================================================

class TestVendorDocument:
    """Tests for VendorDocument model."""

    def test_create_document(self, db, vendor):
        """Test creating a vendor document."""
        doc = VendorDocument.objects.create(
            vendor=vendor,
            document_type="id",
            file="test/doc.pdf"
        )
        assert doc.is_verified is False


# =============================================================================
# VendorProduct Tests
# =============================================================================

class TestVendorProduct:
    """Tests for VendorProduct model."""

    def test_create_product(self, db, vendor):
        """Test creating a vendor product."""
        product = VendorProduct.objects.create(
            vendor=vendor,
            name="Test Product",
            slug="test-product",
            description="A test product",
            price=Decimal("29.99"),
            stock_quantity=100
        )
        assert product.status == "draft"
        assert product.view_count == 0

    def test_product_unique_slug_per_vendor(self, db, vendor):
        """Test product slug is unique per vendor."""
        VendorProduct.objects.create(
            vendor=vendor,
            name="Product 1",
            slug="product",
            description="Test",
            price=Decimal("10.00")
        )
        with pytest.raises(IntegrityError):
            VendorProduct.objects.create(
                vendor=vendor,
                name="Product 2",
                slug="product",
                description="Test",
                price=Decimal("20.00")
            )


# =============================================================================
# VendorOrder Tests
# =============================================================================

class TestVendorOrder:
    """Tests for VendorOrder model."""

    def test_create_order(self, db, vendor, customer):
        """Test creating a vendor order."""
        order = VendorOrder.objects.create(
            order_number="ORD-001",
            vendor=vendor,
            customer=customer,
            subtotal=Decimal("100.00")
        )
        assert order.status == "pending"
        # Commission should be auto-calculated
        assert order.commission_rate == vendor.effective_commission_rate
        assert order.commission_amount == Decimal("10.00")  # 10%
        assert order.vendor_earnings == Decimal("90.00")

    def test_order_commission_calculation(self, db, vendor, customer):
        """Test order commission calculation."""
        vendor.commission_rate = Decimal("15.00")
        vendor.save()

        order = VendorOrder.objects.create(
            order_number="ORD-002",
            vendor=vendor,
            customer=customer,
            subtotal=Decimal("200.00")
        )
        assert order.commission_amount == Decimal("30.00")
        assert order.vendor_earnings == Decimal("170.00")


# =============================================================================
# VendorOrderItem Tests
# =============================================================================

class TestVendorOrderItem:
    """Tests for VendorOrderItem model."""

    def test_create_order_item(self, db, vendor_order, product):
        """Test creating an order item."""
        item = VendorOrderItem.objects.create(
            vendor_order=vendor_order,
            product=product,
            product_name=product.name,
            quantity=2,
            unit_price=product.price,
            total=product.price * 2
        )
        assert item.quantity == 2


# =============================================================================
# Payout Tests
# =============================================================================

class TestPayout:
    """Tests for Payout model."""

    def test_create_payout(self, db, vendor):
        """Test creating a payout."""
        today = timezone.now().date()
        payout = Payout.objects.create(
            vendor=vendor,
            amount=Decimal("500.00"),
            period_start=today - timezone.timedelta(days=30),
            period_end=today,
            gross_amount=Decimal("520.00"),
            fees=Decimal("20.00"),
            net_amount=Decimal("500.00"),
            payment_method="bank_transfer"
        )
        assert payout.status == "pending"


# =============================================================================
# VendorBankAccount Tests
# =============================================================================

class TestVendorBankAccount:
    """Tests for VendorBankAccount model."""

    def test_create_bank_account(self, db, vendor):
        """Test creating a bank account."""
        account = VendorBankAccount.objects.create(
            vendor=vendor,
            account_holder_name="John Doe",
            account_number_last4="4242",
            bank_name="Test Bank"
        )
        assert str(account) == "Test Bank ****4242"


# =============================================================================
# VendorReview Tests
# =============================================================================

class TestVendorReview:
    """Tests for VendorReview model."""

    def test_create_review(self, db, vendor, customer, vendor_order):
        """Test creating a vendor review."""
        review = VendorReview.objects.create(
            vendor=vendor,
            customer=customer,
            order=vendor_order,
            rating=5,
            title="Great seller!",
            comment="Fast shipping and quality products."
        )
        assert review.is_approved is True


# =============================================================================
# MarketplaceSettings Tests
# =============================================================================

class TestMarketplaceSettings:
    """Tests for MarketplaceSettings model."""

    def test_get_settings_singleton(self, db):
        """Test settings is a singleton."""
        settings1 = MarketplaceSettings.get_settings()
        settings2 = MarketplaceSettings.get_settings()
        assert settings1.pk == settings2.pk == 1

    def test_default_values(self, db):
        """Test default values."""
        settings = MarketplaceSettings.get_settings()
        assert settings.default_commission_rate == Decimal("10.00")
        assert settings.min_payout_amount == Decimal("50.00")


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def vendor_user(db):
    """Create a vendor user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="vendoruser",
        email="vendor@example.com",
        password="testpass123"
    )


@pytest.fixture
def customer(db):
    """Create a customer user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="customer",
        email="customer@example.com",
        password="testpass123"
    )


@pytest.fixture
def vendor(db, vendor_user):
    """Create a vendor."""
    return Vendor.objects.create(
        user=vendor_user,
        store_name="Test Store",
        slug="test-store",
        email="store@example.com",
        status="active"
    )


@pytest.fixture
def product(db, vendor):
    """Create a vendor product."""
    return VendorProduct.objects.create(
        vendor=vendor,
        name="Test Product",
        slug="test-product",
        description="A test product",
        price=Decimal("29.99"),
        stock_quantity=100,
        status="active"
    )


@pytest.fixture
def vendor_order(db, vendor, customer):
    """Create a vendor order."""
    return VendorOrder.objects.create(
        order_number="ORD-001",
        vendor=vendor,
        customer=customer,
        subtotal=Decimal("59.98")
    )
