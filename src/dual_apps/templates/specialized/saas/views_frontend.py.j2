"""
SaaS frontend views for {{ app_name }} app.
Generated by dual-apps v{{ version }}
"""

from django.shortcuts import render, get_object_or_404, redirect
from django.views.generic import ListView, DetailView, CreateView, UpdateView, TemplateView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.http import HttpResponse

from .models import Organization, OrganizationMember, OrganizationInvite, Plan, Subscription
from .forms import OrganizationForm, OrganizationInviteForm


class OrganizationListView(LoginRequiredMixin, ListView):
    """List user's organizations."""
    model = Organization
    template_name = "{{ app_name }}/organization_list.html"
    context_object_name = "organizations"

    def get_queryset(self):
        return Organization.objects.filter(members__user=self.request.user)


class OrganizationDetailView(LoginRequiredMixin, DetailView):
    """Organization detail view."""
    model = Organization
    template_name = "{{ app_name }}/organization_detail.html"
    context_object_name = "organization"
    slug_field = "slug"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['members'] = self.object.members.select_related('user')
        context['invites'] = self.object.invites.all()
        return context


class OrganizationCreateView(LoginRequiredMixin, CreateView):
    """Create new organization."""
    model = Organization
    form_class = OrganizationForm
    template_name = "{{ app_name }}/organization_form.html"

    def form_valid(self, form):
        form.instance.owner = self.request.user
        response = super().form_valid(form)
        OrganizationMember.objects.create(
            organization=self.object,
            user=self.request.user,
            role='owner'
        )
        return response


class OrganizationMembersView(LoginRequiredMixin, DetailView):
    """List members of an organization."""
    model = Organization
    template_name = "{{ app_name }}/organization_members.html"
    context_object_name = "organization"
    slug_field = "slug"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['members'] = self.object.members.select_related('user')
        context['invites'] = self.object.invites.filter(accepted_at__isnull=True)
        return context


class OrganizationBillingView(LoginRequiredMixin, DetailView):
    """Organization billing view."""
    model = Organization
    template_name = "{{ app_name }}/organization_billing.html"
    context_object_name = "organization"
    slug_field = "slug"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['subscription'] = getattr(self.object, 'subscription', None)
        context['invoices'] = self.object.invoices.all()[:10]
        context['payment_methods'] = self.object.payment_methods.all()
        return context


class PricingView(TemplateView):
    """Pricing page."""
    template_name = "{{ app_name }}/pricing.html"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['plans'] = Plan.objects.filter(is_active=True).order_by('order', 'price')
        return context


# URL name mappings
organization_list = OrganizationListView.as_view()
organization_detail = OrganizationDetailView.as_view()
organization_create = OrganizationCreateView.as_view()
organization_members = OrganizationMembersView.as_view()
organization_billing = OrganizationBillingView.as_view()
pricing = PricingView.as_view()
