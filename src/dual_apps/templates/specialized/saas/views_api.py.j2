"""
SaaS API views for {{ app_name }} app.
Generated by dual-apps v{{ version }}
"""

from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from .models import (
    Organization, OrganizationMember, OrganizationInvite,
    Plan, Subscription, Invoice, PaymentMethod, UsageRecord, APIKey
)
from .serializers import (
    OrganizationSerializer, OrganizationMemberSerializer, OrganizationInviteSerializer,
    PlanSerializer, SubscriptionSerializer, InvoiceSerializer
)
from .permissions import IsOwnerOrReadOnly


class OrganizationViewSet(viewsets.ModelViewSet):
    """Organization API."""
    queryset = Organization.objects.all()
    serializer_class = OrganizationSerializer
    permission_classes = [IsAuthenticated, IsOwnerOrReadOnly]
    lookup_field = 'slug'

    def get_queryset(self):
        return Organization.objects.filter(members__user=self.request.user)

    def perform_create(self, serializer):
        org = serializer.save(owner=self.request.user)
        OrganizationMember.objects.create(
            organization=org, user=self.request.user, role='owner'
        )


class OrganizationMemberViewSet(viewsets.ModelViewSet):
    """Organization member API."""
    queryset = OrganizationMember.objects.all()
    serializer_class = OrganizationMemberSerializer
    permission_classes = [IsAuthenticated]


class OrganizationInviteViewSet(viewsets.ModelViewSet):
    """Organization invite API."""
    queryset = OrganizationInvite.objects.all()
    serializer_class = OrganizationInviteSerializer
    permission_classes = [IsAuthenticated]

    @action(detail=True, methods=['post'])
    def accept(self, request, pk=None):
        """Accept an invitation."""
        invite = self.get_object()
        if invite.is_expired:
            return Response(
                {"error": "Invitation has expired"},
                status=status.HTTP_400_BAD_REQUEST
            )
        OrganizationMember.objects.create(
            organization=invite.organization,
            user=request.user,
            role=invite.role,
            invited_by=invite.invited_by
        )
        invite.delete()
        return Response({"status": "accepted"})


class PlanViewSet(viewsets.ReadOnlyModelViewSet):
    """Plan API (read-only)."""
    queryset = Plan.objects.filter(is_active=True)
    serializer_class = PlanSerializer
    lookup_field = 'slug'


class SubscriptionViewSet(viewsets.ModelViewSet):
    """Subscription API."""
    queryset = Subscription.objects.all()
    serializer_class = SubscriptionSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Subscription.objects.filter(
            organization__members__user=self.request.user
        )


class InvoiceViewSet(viewsets.ReadOnlyModelViewSet):
    """Invoice API (read-only)."""
    queryset = Invoice.objects.all()
    serializer_class = InvoiceSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Invoice.objects.filter(
            organization__members__user=self.request.user
        )


# Compatibility alias
{{ app_name_pascal }}ViewSet = OrganizationViewSet
