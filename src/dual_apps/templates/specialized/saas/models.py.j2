"""
SaaS Models for {{ project_name }}.
Generated by dual-apps v{{ version }} - SaaS Template

Multi-tenant SaaS with subscriptions, billing, and team management.
"""

import uuid
from decimal import Decimal
from django.db import models
from django.conf import settings
from django.utils import timezone


class BaseModel(models.Model):
    """Abstract base model."""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


# =============================================================================
# Organization / Tenant
# =============================================================================

class Organization(BaseModel):
    """
    Organization (tenant) in multi-tenant SaaS.

    Each organization has its own data isolation.
    """
    name = models.CharField(max_length=100)
    slug = models.SlugField(max_length=100, unique=True)
    logo = models.ImageField(upload_to="organizations/logos/", blank=True, null=True)

    # Owner
    owner = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.PROTECT,
        related_name="owned_organizations"
    )

    # Settings
    settings = models.JSONField(default=dict, blank=True)

    # Status
    is_active = models.BooleanField(default=True)
    is_verified = models.BooleanField(default=False)

    # Limits (from subscription plan)
    max_users = models.PositiveIntegerField(default=5)
    max_storage_gb = models.PositiveIntegerField(default=5)

    # Usage tracking
    current_users = models.PositiveIntegerField(default=1)
    current_storage_bytes = models.BigIntegerField(default=0)

    class Meta:
        ordering = ["name"]

    def __str__(self):
        return self.name

    @property
    def storage_used_percent(self):
        max_bytes = self.max_storage_gb * 1024 * 1024 * 1024
        return (self.current_storage_bytes / max_bytes) * 100 if max_bytes > 0 else 0


class OrganizationMember(BaseModel):
    """Organization membership."""
    ROLE_CHOICES = [
        ("owner", "Owner"),
        ("admin", "Admin"),
        ("member", "Member"),
        ("viewer", "Viewer"),
    ]

    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="members"
    )
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="organization_memberships"
    )
    role = models.CharField(max_length=20, choices=ROLE_CHOICES, default="member")
    invited_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, related_name="+"
    )
    joined_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        unique_together = ["organization", "user"]

    def __str__(self):
        return f"{self.user} in {self.organization}"


class OrganizationInvite(BaseModel):
    """Pending organization invites."""
    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="invites"
    )
    email = models.EmailField()
    role = models.CharField(max_length=20, default="member")
    token = models.CharField(max_length=100, unique=True)
    invited_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL, null=True
    )
    expires_at = models.DateTimeField()
    accepted_at = models.DateTimeField(null=True, blank=True)

    def __str__(self):
        return f"Invite for {self.email} to {self.organization}"

    @property
    def is_expired(self):
        return timezone.now() > self.expires_at


# =============================================================================
# Subscription & Plans
# =============================================================================

class Plan(BaseModel):
    """Subscription plan."""
    INTERVAL_CHOICES = [
        ("monthly", "Monthly"),
        ("yearly", "Yearly"),
        ("lifetime", "Lifetime"),
    ]

    name = models.CharField(max_length=50)
    slug = models.SlugField(max_length=50, unique=True)
    description = models.TextField(blank=True)

    # Pricing
    price = models.DecimalField(max_digits=10, decimal_places=2)
    interval = models.CharField(max_length=20, choices=INTERVAL_CHOICES, default="monthly")
    currency = models.CharField(max_length=3, default="USD")

    # Stripe
    stripe_price_id = models.CharField(max_length=100, blank=True)
    stripe_product_id = models.CharField(max_length=100, blank=True)

    # Limits
    max_users = models.PositiveIntegerField(default=5)
    max_storage_gb = models.PositiveIntegerField(default=5)
    max_projects = models.PositiveIntegerField(default=10)

    # Features
    features = models.JSONField(default=list)

    # Status
    is_active = models.BooleanField(default=True)
    is_featured = models.BooleanField(default=False)
    order = models.PositiveIntegerField(default=0)

    class Meta:
        ordering = ["order", "price"]

    def __str__(self):
        return f"{self.name} (${self.price}/{self.interval})"


class Subscription(BaseModel):
    """Organization subscription."""
    STATUS_CHOICES = [
        ("trialing", "Trialing"),
        ("active", "Active"),
        ("past_due", "Past Due"),
        ("canceled", "Canceled"),
        ("unpaid", "Unpaid"),
    ]

    organization = models.OneToOneField(
        Organization, on_delete=models.CASCADE,
        related_name="subscription"
    )
    plan = models.ForeignKey(Plan, on_delete=models.PROTECT, related_name="subscriptions")
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="trialing")

    # Stripe
    stripe_subscription_id = models.CharField(max_length=100, blank=True)
    stripe_customer_id = models.CharField(max_length=100, blank=True)

    # Dates
    trial_ends_at = models.DateTimeField(null=True, blank=True)
    current_period_start = models.DateTimeField(null=True, blank=True)
    current_period_end = models.DateTimeField(null=True, blank=True)
    canceled_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.organization} - {self.plan}"

    @property
    def is_active(self):
        return self.status in ["active", "trialing"]

    @property
    def is_trialing(self):
        return self.status == "trialing" and self.trial_ends_at > timezone.now()

    @property
    def days_until_renewal(self):
        if self.current_period_end:
            delta = self.current_period_end - timezone.now()
            return max(0, delta.days)
        return None


# =============================================================================
# Billing
# =============================================================================

class Invoice(BaseModel):
    """Billing invoice."""
    STATUS_CHOICES = [
        ("draft", "Draft"),
        ("open", "Open"),
        ("paid", "Paid"),
        ("void", "Void"),
        ("uncollectible", "Uncollectible"),
    ]

    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="invoices"
    )
    subscription = models.ForeignKey(
        Subscription, on_delete=models.SET_NULL,
        null=True, related_name="invoices"
    )

    # Stripe
    stripe_invoice_id = models.CharField(max_length=100, blank=True)

    # Details
    invoice_number = models.CharField(max_length=50, unique=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="draft")
    currency = models.CharField(max_length=3, default="USD")

    # Amounts
    subtotal = models.DecimalField(max_digits=10, decimal_places=2)
    tax = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    total = models.DecimalField(max_digits=10, decimal_places=2)
    amount_paid = models.DecimalField(max_digits=10, decimal_places=2, default=Decimal("0.00"))
    amount_due = models.DecimalField(max_digits=10, decimal_places=2)

    # Dates
    invoice_date = models.DateField()
    due_date = models.DateField()
    paid_at = models.DateTimeField(null=True, blank=True)

    # PDF
    pdf_url = models.URLField(blank=True)

    class Meta:
        ordering = ["-invoice_date"]

    def __str__(self):
        return f"Invoice {self.invoice_number}"


class PaymentMethod(BaseModel):
    """Saved payment methods."""
    TYPE_CHOICES = [
        ("card", "Credit Card"),
        ("bank_account", "Bank Account"),
    ]

    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="payment_methods"
    )

    # Stripe
    stripe_payment_method_id = models.CharField(max_length=100)

    # Details
    type = models.CharField(max_length=20, choices=TYPE_CHOICES)
    last_four = models.CharField(max_length=4)
    brand = models.CharField(max_length=20, blank=True)  # visa, mastercard, etc.
    exp_month = models.PositiveIntegerField(null=True, blank=True)
    exp_year = models.PositiveIntegerField(null=True, blank=True)

    is_default = models.BooleanField(default=False)

    class Meta:
        ordering = ["-is_default", "-created_at"]

    def __str__(self):
        return f"{self.brand} ****{self.last_four}"


# =============================================================================
# Usage Tracking
# =============================================================================

class UsageRecord(BaseModel):
    """Track feature usage for metered billing."""
    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="usage_records"
    )
    feature = models.CharField(max_length=50)  # api_calls, storage, users, etc.
    quantity = models.BigIntegerField(default=1)
    timestamp = models.DateTimeField(default=timezone.now)

    class Meta:
        indexes = [
            models.Index(fields=["organization", "feature", "timestamp"]),
        ]

    def __str__(self):
        return f"{self.organization}: {self.quantity} {self.feature}"


# =============================================================================
# API Keys
# =============================================================================

class APIKey(BaseModel):
    """API keys for organization."""
    organization = models.ForeignKey(
        Organization, on_delete=models.CASCADE,
        related_name="api_keys"
    )
    name = models.CharField(max_length=100)
    key_prefix = models.CharField(max_length=8)  # Visible prefix
    key_hash = models.CharField(max_length=128)  # Hashed full key
    scopes = models.JSONField(default=list)  # ["read", "write", "admin"]

    is_active = models.BooleanField(default=True)
    last_used_at = models.DateTimeField(null=True, blank=True)
    expires_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self):
        return f"{self.name} ({self.key_prefix}...)"
