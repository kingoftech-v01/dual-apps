import { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import api from '../utils/api';
import { useAuth } from '../context/AuthContext';
import {
  LineChart, Line, AreaChart, Area, BarChart, Bar,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend
} from 'recharts';

const StatCard = ({ title, value, change, icon, color }) => (
  <div className="card">
    <div className="card-body">
      <div className="d-flex align-items-center">
        <div className={`flex-shrink-0 bg-${color} bg-opacity-10 rounded p-3`}>
          <i className={`bi bi-${icon} text-${color}`} style={% raw %}{{ fontSize: '1.5rem' }}{% endraw %}></i>
        </div>
        <div className="flex-grow-1 ms-3">
          <h6 className="text-muted mb-1">{title}</h6>
          <h3 className="mb-0">{value?.toLocaleString()}</h3>
          {change !== undefined && (
            <small className={change >= 0 ? 'text-success' : 'text-danger'}>
              <i className={`bi bi-arrow-${change >= 0 ? 'up' : 'down'}`}></i>
              {Math.abs(change)}%
            </small>
          )}
        </div>
      </div>
    </div>
  </div>
);

const ActivityItem = ({ activity }) => (
  <div className="list-group-item d-flex align-items-start">
    <div className="flex-shrink-0 me-3">
      {activity.user?.avatar ? (
        <img src={activity.user.avatar} className="rounded-circle" style={% raw %}{{ width: 40, height: 40, objectFit: 'cover' }}{% endraw %} alt="" />
      ) : (
        <div className={`rounded-circle bg-${activity.color || 'primary'} text-white d-flex align-items-center justify-content-center`}
             style={% raw %}{{ width: 40, height: 40 }}{% endraw %}>
          {activity.user?.first_name?.[0]}{activity.user?.last_name?.[0]}
        </div>
      )}
    </div>
    <div className="flex-grow-1">
      <div className="d-flex justify-content-between">
        <strong>{activity.user?.first_name} {activity.user?.last_name}</strong>
        <small className="text-muted">{activity.time_ago}</small>
      </div>
      <p className="mb-0 text-muted">{activity.description}</p>
    </div>
  </div>
);

export default function Dashboard() {
  const { user } = useAuth();
  const [stats, setStats] = useState(null);
  const [chartData, setChartData] = useState([]);
  const [activities, setActivities] = useState([]);
  const [loading, setLoading] = useState(true);
  const [period, setPeriod] = useState('7d');

  useEffect(() => {
    fetchDashboardData();
  }, [period]);

  const fetchDashboardData = async () => {
    try {
      const [statsRes, chartRes, activityRes] = await Promise.all([
        api.get('/api/dashboard/stats/'),
        api.get(`/api/dashboard/chart/?period=${period}`),
        api.get('/api/dashboard/activity/')
      ]);
      setStats(statsRes.data);
      setChartData(chartRes.data);
      setActivities(activityRes.data);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="d-flex justify-content-center align-items-center" style={% raw %}{{ minHeight: '400px' }}{% endraw %}>
        <div className="spinner-border text-primary" role="status">
          <span className="visually-hidden">Loading...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="container-fluid py-4">
      <div className="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 className="h3 mb-1">Welcome back, {user?.first_name || 'User'}!</h1>
          <p className="text-muted mb-0">Here's what's happening with your projects.</p>
        </div>
        <div className="btn-group">
          {['7d', '30d', '90d'].map(p => (
            <button
              key={p}
              className={`btn btn-${period === p ? 'primary' : 'outline-primary'}`}
              onClick={() => setPeriod(p)}
            >
              {p === '7d' ? '7 Days' : p === '30d' ? '30 Days' : '90 Days'}
            </button>
          ))}
        </div>
      </div>

      {/* Stats Cards */}
      <div className="row g-4 mb-4">
        <div className="col-sm-6 col-xl-3">
          <StatCard
            title="API Calls"
            value={stats?.api_calls}
            change={stats?.api_calls_change}
            icon="graph-up"
            color="primary"
          />
        </div>
        <div className="col-sm-6 col-xl-3">
          <StatCard
            title="Active Users"
            value={stats?.active_users}
            change={stats?.users_change}
            icon="people"
            color="success"
          />
        </div>
        <div className="col-sm-6 col-xl-3">
          <StatCard
            title="Storage Used"
            value={`${stats?.storage_gb} GB`}
            icon="hdd"
            color="warning"
          />
        </div>
        <div className="col-sm-6 col-xl-3">
          <StatCard
            title="Avg Response"
            value={`${stats?.avg_response_ms}ms`}
            change={stats?.response_change ? -stats.response_change : undefined}
            icon="clock-history"
            color="info"
          />
        </div>
      </div>

      <div className="row">
        {/* Usage Chart */}
        <div className="col-lg-8 mb-4">
          <div className="card h-100">
            <div className="card-header d-flex justify-content-between align-items-center">
              <h5 className="mb-0">Usage Overview</h5>
              <div className="btn-group btn-group-sm">
                <button className="btn btn-outline-secondary active">API Calls</button>
                <button className="btn btn-outline-secondary">Bandwidth</button>
              </div>
            </div>
            <div className="card-body">
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={chartData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="date" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Area
                    type="monotone"
                    dataKey="api_calls"
                    name="API Calls"
                    stroke="#0d6efd"
                    fill="#0d6efd"
                    fillOpacity={0.2}
                  />
                  <Area
                    type="monotone"
                    dataKey="errors"
                    name="Errors"
                    stroke="#dc3545"
                    fill="#dc3545"
                    fillOpacity={0.2}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>

        {/* Recent Activity */}
        <div className="col-lg-4 mb-4">
          <div className="card h-100">
            <div className="card-header d-flex justify-content-between align-items-center">
              <h5 className="mb-0">Recent Activity</h5>
              <Link to="/activity" className="btn btn-sm btn-outline-primary">View All</Link>
            </div>
            <div className="card-body p-0">
              <div className="list-group list-group-flush">
                {activities.slice(0, 5).map((activity, index) => (
                  <ActivityItem key={index} activity={activity} />
                ))}
                {activities.length === 0 && (
                  <div className="list-group-item text-center text-muted py-4">
                    No recent activity
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Quick Actions */}
      <div className="row">
        <div className="col-12">
          <div className="card">
            <div className="card-header">
              <h5 className="mb-0">Quick Actions</h5>
            </div>
            <div className="card-body">
              <div className="row g-3">
                <div className="col-md-3">
                  <Link to="/projects/new" className="btn btn-outline-primary w-100 py-3">
                    <i className="bi bi-plus-circle d-block mb-2" style={% raw %}{{ fontSize: '1.5rem' }}{% endraw %}></i>
                    New Project
                  </Link>
                </div>
                <div className="col-md-3">
                  <Link to="/team/invite" className="btn btn-outline-primary w-100 py-3">
                    <i className="bi bi-person-plus d-block mb-2" style={% raw %}{{ fontSize: '1.5rem' }}{% endraw %}></i>
                    Invite Team Member
                  </Link>
                </div>
                <div className="col-md-3">
                  <Link to="/settings/api" className="btn btn-outline-primary w-100 py-3">
                    <i className="bi bi-key d-block mb-2" style={% raw %}{{ fontSize: '1.5rem' }}{% endraw %}></i>
                    Generate API Key
                  </Link>
                </div>
                <div className="col-md-3">
                  <Link to="/docs" className="btn btn-outline-primary w-100 py-3">
                    <i className="bi bi-book d-block mb-2" style={% raw %}{{ fontSize: '1.5rem' }}{% endraw %}></i>
                    View Documentation
                  </Link>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
