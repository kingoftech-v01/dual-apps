"""
SaaS Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - SaaS Template

Tests for multi-tenant SaaS models: Organization, Plan, Subscription, Billing.
"""

import pytest
from decimal import Decimal
from django.utils import timezone
from django.db import IntegrityError

from apps.organizations.models import (
    Organization, OrganizationMember, OrganizationInvite
)
from apps.subscriptions.models import (
    Plan, Subscription, Invoice, PaymentMethod, UsageRecord, APIKey
)


# =============================================================================
# Organization Tests
# =============================================================================

class TestOrganization:
    """Tests for Organization model."""

    def test_create_organization(self, db, owner):
        """Test creating an organization."""
        org = Organization.objects.create(
            name="Acme Inc",
            slug="acme-inc",
            owner=owner
        )
        assert org.id is not None
        assert org.is_active is True
        assert org.max_users == 5
        assert org.current_users == 1

    def test_organization_storage_percent(self, db, owner):
        """Test storage_used_percent property."""
        org = Organization.objects.create(
            name="Test Org",
            slug="test-org",
            owner=owner,
            max_storage_gb=10,
            current_storage_bytes=5 * 1024 * 1024 * 1024  # 5 GB
        )
        assert org.storage_used_percent == 50.0


# =============================================================================
# OrganizationMember Tests
# =============================================================================

class TestOrganizationMember:
    """Tests for OrganizationMember model."""

    def test_add_member(self, db, organization, member_user, owner):
        """Test adding a member to organization."""
        membership = OrganizationMember.objects.create(
            organization=organization,
            user=member_user,
            role="member",
            invited_by=owner
        )
        assert membership.role == "member"

    def test_unique_membership(self, db, organization, member_user, owner):
        """Test user can only be member once per org."""
        OrganizationMember.objects.create(
            organization=organization,
            user=member_user,
            role="member"
        )
        with pytest.raises(IntegrityError):
            OrganizationMember.objects.create(
                organization=organization,
                user=member_user,
                role="admin"
            )

    def test_member_roles(self, db, organization, member_user):
        """Test different member roles."""
        for role in ["owner", "admin", "member", "viewer"]:
            OrganizationMember.objects.filter(
                organization=organization, user=member_user
            ).delete()
            membership = OrganizationMember.objects.create(
                organization=organization,
                user=member_user,
                role=role
            )
            assert membership.role == role


# =============================================================================
# OrganizationInvite Tests
# =============================================================================

class TestOrganizationInvite:
    """Tests for OrganizationInvite model."""

    def test_create_invite(self, db, organization, owner):
        """Test creating an invite."""
        invite = OrganizationInvite.objects.create(
            organization=organization,
            email="newuser@example.com",
            role="member",
            token="test-token-123",
            invited_by=owner,
            expires_at=timezone.now() + timezone.timedelta(days=7)
        )
        assert invite.is_expired is False

    def test_expired_invite(self, db, organization, owner):
        """Test expired invite detection."""
        invite = OrganizationInvite.objects.create(
            organization=organization,
            email="expired@example.com",
            token="expired-token",
            invited_by=owner,
            expires_at=timezone.now() - timezone.timedelta(days=1)
        )
        assert invite.is_expired is True


# =============================================================================
# Plan Tests
# =============================================================================

class TestPlan:
    """Tests for Plan model."""

    def test_create_plan(self, db):
        """Test creating a subscription plan."""
        plan = Plan.objects.create(
            name="Pro",
            slug="pro",
            price=Decimal("29.99"),
            interval="monthly",
            max_users=10,
            max_storage_gb=50
        )
        assert plan.id is not None
        assert plan.is_active is True

    def test_plan_features(self, db):
        """Test plan with features."""
        plan = Plan.objects.create(
            name="Enterprise",
            slug="enterprise",
            price=Decimal("99.99"),
            interval="monthly",
            features=["SSO", "Priority Support", "Custom Integrations"]
        )
        assert len(plan.features) == 3


# =============================================================================
# Subscription Tests
# =============================================================================

class TestSubscription:
    """Tests for Subscription model."""

    def test_create_subscription(self, db, organization, plan):
        """Test creating a subscription."""
        subscription = Subscription.objects.create(
            organization=organization,
            plan=plan,
            status="active",
            current_period_start=timezone.now(),
            current_period_end=timezone.now() + timezone.timedelta(days=30)
        )
        assert subscription.is_active is True

    def test_subscription_is_trialing(self, db, organization, plan):
        """Test trial subscription."""
        subscription = Subscription.objects.create(
            organization=organization,
            plan=plan,
            status="trialing",
            trial_ends_at=timezone.now() + timezone.timedelta(days=14)
        )
        assert subscription.is_trialing is True
        assert subscription.is_active is True

    def test_days_until_renewal(self, db, organization, plan):
        """Test days_until_renewal property."""
        subscription = Subscription.objects.create(
            organization=organization,
            plan=plan,
            status="active",
            current_period_end=timezone.now() + timezone.timedelta(days=15)
        )
        assert subscription.days_until_renewal == 15


# =============================================================================
# Invoice Tests
# =============================================================================

class TestInvoice:
    """Tests for Invoice model."""

    def test_create_invoice(self, db, organization):
        """Test creating an invoice."""
        invoice = Invoice.objects.create(
            organization=organization,
            invoice_number="INV-001",
            subtotal=Decimal("29.99"),
            tax=Decimal("0.00"),
            total=Decimal("29.99"),
            amount_due=Decimal("29.99"),
            invoice_date=timezone.now().date(),
            due_date=timezone.now().date() + timezone.timedelta(days=30)
        )
        assert invoice.status == "draft"


# =============================================================================
# PaymentMethod Tests
# =============================================================================

class TestPaymentMethod:
    """Tests for PaymentMethod model."""

    def test_create_payment_method(self, db, organization):
        """Test creating a payment method."""
        pm = PaymentMethod.objects.create(
            organization=organization,
            stripe_payment_method_id="pm_test_123",
            type="card",
            last_four="4242",
            brand="visa",
            exp_month=12,
            exp_year=2025
        )
        assert str(pm) == "visa ****4242"


# =============================================================================
# APIKey Tests
# =============================================================================

class TestAPIKey:
    """Tests for APIKey model."""

    def test_create_api_key(self, db, organization):
        """Test creating an API key."""
        api_key = APIKey.objects.create(
            organization=organization,
            name="Production API Key",
            key_prefix="sk_prod_",
            key_hash="hashed_key_value",
            scopes=["read", "write"]
        )
        assert api_key.is_active is True
        assert len(api_key.scopes) == 2


# =============================================================================
# UsageRecord Tests
# =============================================================================

class TestUsageRecord:
    """Tests for UsageRecord model."""

    def test_track_usage(self, db, organization):
        """Test tracking usage."""
        record = UsageRecord.objects.create(
            organization=organization,
            feature="api_calls",
            quantity=100
        )
        assert record.quantity == 100


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def owner(db):
    """Create an organization owner."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="owner",
        email="owner@example.com",
        password="ownerpass123"
    )


@pytest.fixture
def member_user(db):
    """Create a member user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="member",
        email="member@example.com",
        password="memberpass123"
    )


@pytest.fixture
def organization(db, owner):
    """Create a test organization."""
    return Organization.objects.create(
        name="Test Organization",
        slug="test-org",
        owner=owner
    )


@pytest.fixture
def plan(db):
    """Create a test plan."""
    return Plan.objects.create(
        name="Pro",
        slug="pro",
        price=Decimal("29.99"),
        interval="monthly",
        max_users=10
    )
