"""
SaaS Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - SaaS Template

Shared pytest fixtures for SaaS tests.
"""

import pytest
from decimal import Decimal
from django.utils import timezone

from apps.organizations.models import Organization, OrganizationMember, OrganizationInvite
from apps.subscriptions.models import Plan, Subscription, Invoice, PaymentMethod, APIKey


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def owner(db):
    """Create an organization owner."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="owner",
        email="owner@example.com",
        password="ownerpass123"
    )


@pytest.fixture
def member_user(db):
    """Create a member user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="member",
        email="member@example.com",
        password="memberpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="admin",
        email="admin@example.com",
        password="adminpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, owner):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=owner)
    return api_client


# =============================================================================
# Organization Fixtures
# =============================================================================

@pytest.fixture
def organization(db, owner):
    """Create a test organization."""
    return Organization.objects.create(
        name="Test Organization",
        slug="test-org",
        owner=owner
    )


@pytest.fixture
def organization_with_members(db, organization, owner, member_user):
    """Create organization with members."""
    OrganizationMember.objects.create(
        organization=organization,
        user=owner,
        role="owner",
        joined_at=timezone.now()
    )
    OrganizationMember.objects.create(
        organization=organization,
        user=member_user,
        role="member",
        invited_by=owner,
        joined_at=timezone.now()
    )
    return organization


@pytest.fixture
def invite(db, organization, owner):
    """Create a pending invite."""
    import secrets
    return OrganizationInvite.objects.create(
        organization=organization,
        email="invited@example.com",
        role="member",
        token=secrets.token_urlsafe(32),
        invited_by=owner,
        expires_at=timezone.now() + timezone.timedelta(days=7)
    )


# =============================================================================
# Plan Fixtures
# =============================================================================

@pytest.fixture
def free_plan(db):
    """Create a free plan."""
    return Plan.objects.create(
        name="Free",
        slug="free",
        price=Decimal("0.00"),
        interval="monthly",
        max_users=3,
        max_storage_gb=1,
        features=["Basic features"]
    )


@pytest.fixture
def plan(db):
    """Create a pro plan."""
    return Plan.objects.create(
        name="Pro",
        slug="pro",
        price=Decimal("29.99"),
        interval="monthly",
        max_users=10,
        max_storage_gb=50,
        features=["All features", "Priority support"]
    )


@pytest.fixture
def enterprise_plan(db):
    """Create an enterprise plan."""
    return Plan.objects.create(
        name="Enterprise",
        slug="enterprise",
        price=Decimal("99.99"),
        interval="monthly",
        max_users=100,
        max_storage_gb=500,
        features=["All features", "SSO", "Dedicated support"],
        is_featured=True
    )


# =============================================================================
# Subscription Fixtures
# =============================================================================

@pytest.fixture
def subscription(db, organization, plan):
    """Create an active subscription."""
    return Subscription.objects.create(
        organization=organization,
        plan=plan,
        status="active",
        current_period_start=timezone.now(),
        current_period_end=timezone.now() + timezone.timedelta(days=30)
    )


@pytest.fixture
def trial_subscription(db, organization, plan):
    """Create a trial subscription."""
    return Subscription.objects.create(
        organization=organization,
        plan=plan,
        status="trialing",
        trial_ends_at=timezone.now() + timezone.timedelta(days=14)
    )


# =============================================================================
# Billing Fixtures
# =============================================================================

@pytest.fixture
def invoice(db, organization, subscription):
    """Create an invoice."""
    return Invoice.objects.create(
        organization=organization,
        subscription=subscription,
        invoice_number="INV-001",
        status="paid",
        subtotal=Decimal("29.99"),
        tax=Decimal("0.00"),
        total=Decimal("29.99"),
        amount_paid=Decimal("29.99"),
        amount_due=Decimal("0.00"),
        invoice_date=timezone.now().date(),
        due_date=timezone.now().date() + timezone.timedelta(days=30),
        paid_at=timezone.now()
    )


@pytest.fixture
def payment_method(db, organization):
    """Create a payment method."""
    return PaymentMethod.objects.create(
        organization=organization,
        stripe_payment_method_id="pm_test_123",
        type="card",
        last_four="4242",
        brand="visa",
        exp_month=12,
        exp_year=2025,
        is_default=True
    )


# =============================================================================
# API Key Fixtures
# =============================================================================

@pytest.fixture
def api_key(db, organization):
    """Create an API key."""
    return APIKey.objects.create(
        organization=organization,
        name="Test API Key",
        key_prefix="sk_test_",
        key_hash="hashed_key_value",
        scopes=["read", "write"]
    )
