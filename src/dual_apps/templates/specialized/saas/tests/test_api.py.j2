"""
SaaS API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - SaaS Template

Tests for SaaS API endpoints.
"""

import pytest
from decimal import Decimal
from rest_framework import status
from django.utils import timezone

from apps.organizations.models import Organization, OrganizationMember
from apps.subscriptions.models import Plan, Subscription


# =============================================================================
# Organization API Tests
# =============================================================================

class TestOrganizationAPI:
    """Tests for Organization API endpoints."""

    def test_list_organizations(self, auth_api_client, organization, owner):
        """Test listing user's organizations."""
        response = auth_api_client.get("/api/v1/organizations/")
        assert response.status_code == status.HTTP_200_OK

    def test_create_organization(self, auth_api_client, owner):
        """Test creating an organization."""
        response = auth_api_client.post("/api/v1/organizations/", {
            "name": "New Org",
            "slug": "new-org"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_retrieve_organization(self, auth_api_client, organization, owner):
        """Test retrieving an organization."""
        response = auth_api_client.get(f"/api/v1/organizations/{organization.slug}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["name"] == organization.name

    def test_update_organization(self, auth_api_client, organization, owner):
        """Test updating organization as owner."""
        response = auth_api_client.patch(f"/api/v1/organizations/{organization.slug}/", {
            "name": "Updated Org Name"
        })
        assert response.status_code == status.HTTP_200_OK

    def test_non_member_cannot_access(self, api_client, organization, db):
        """Test non-member cannot access organization."""
        from django.contrib.auth import get_user_model
        User = get_user_model()
        other = User.objects.create_user(username="other", password="pass123")
        api_client.force_authenticate(user=other)

        response = api_client.get(f"/api/v1/organizations/{organization.slug}/")
        assert response.status_code in [status.HTTP_403_FORBIDDEN, status.HTTP_404_NOT_FOUND]


# =============================================================================
# Organization Members API Tests
# =============================================================================

class TestOrganizationMembersAPI:
    """Tests for Organization Members API endpoints."""

    def test_list_members(self, auth_api_client, organization, owner):
        """Test listing organization members."""
        response = auth_api_client.get(f"/api/v1/organizations/{organization.slug}/members/")
        assert response.status_code == status.HTTP_200_OK

    def test_invite_member(self, auth_api_client, organization, owner):
        """Test inviting a member."""
        response = auth_api_client.post(
            f"/api/v1/organizations/{organization.slug}/members/invite/",
            {"email": "newmember@example.com", "role": "member"}
        )
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_remove_member(self, auth_api_client, organization, owner, member_user):
        """Test removing a member."""
        membership = OrganizationMember.objects.create(
            organization=organization,
            user=member_user,
            role="member"
        )
        response = auth_api_client.delete(
            f"/api/v1/organizations/{organization.slug}/members/{membership.id}/"
        )
        assert response.status_code == status.HTTP_204_NO_CONTENT


# =============================================================================
# Plan API Tests
# =============================================================================

class TestPlanAPI:
    """Tests for Plan API endpoints."""

    def test_list_plans(self, api_client, plan):
        """Test listing available plans."""
        response = api_client.get("/api/v1/subscriptions/plans/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_plan(self, api_client, plan):
        """Test retrieving a plan."""
        response = api_client.get(f"/api/v1/subscriptions/plans/{plan.slug}/")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Subscription API Tests
# =============================================================================

class TestSubscriptionAPI:
    """Tests for Subscription API endpoints."""

    def test_get_subscription(self, auth_api_client, subscription, owner):
        """Test getting organization's subscription."""
        response = auth_api_client.get(
            f"/api/v1/organizations/{subscription.organization.slug}/subscription/"
        )
        assert response.status_code == status.HTTP_200_OK

    def test_change_plan(self, auth_api_client, subscription, plan, owner):
        """Test changing subscription plan."""
        new_plan = Plan.objects.create(
            name="Enterprise",
            slug="enterprise",
            price=Decimal("99.99"),
            interval="monthly"
        )
        response = auth_api_client.post(
            f"/api/v1/organizations/{subscription.organization.slug}/subscription/change-plan/",
            {"plan_slug": new_plan.slug}
        )
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]

    def test_cancel_subscription(self, auth_api_client, subscription, owner):
        """Test canceling subscription."""
        response = auth_api_client.post(
            f"/api/v1/organizations/{subscription.organization.slug}/subscription/cancel/"
        )
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Invoice API Tests
# =============================================================================

class TestInvoiceAPI:
    """Tests for Invoice API endpoints."""

    def test_list_invoices(self, auth_api_client, organization, owner):
        """Test listing organization's invoices."""
        response = auth_api_client.get(
            f"/api/v1/organizations/{organization.slug}/invoices/"
        )
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# API Key API Tests
# =============================================================================

class TestAPIKeyAPI:
    """Tests for API Key API endpoints."""

    def test_list_api_keys(self, auth_api_client, organization, owner):
        """Test listing API keys."""
        response = auth_api_client.get(
            f"/api/v1/organizations/{organization.slug}/api-keys/"
        )
        assert response.status_code == status.HTTP_200_OK

    def test_create_api_key(self, auth_api_client, organization, owner):
        """Test creating an API key."""
        response = auth_api_client.post(
            f"/api/v1/organizations/{organization.slug}/api-keys/",
            {"name": "Production Key", "scopes": ["read", "write"]}
        )
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_200_OK]

    def test_revoke_api_key(self, auth_api_client, organization, api_key, owner):
        """Test revoking an API key."""
        response = auth_api_client.delete(
            f"/api/v1/organizations/{organization.slug}/api-keys/{api_key.id}/"
        )
        assert response.status_code == status.HTTP_204_NO_CONTENT


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, owner):
    """Create authenticated API client."""
    api_client.force_authenticate(user=owner)
    return api_client


@pytest.fixture
def owner(db):
    """Create an organization owner."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="owner",
        email="owner@example.com",
        password="ownerpass123"
    )


@pytest.fixture
def member_user(db):
    """Create a member user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="member",
        email="member@example.com",
        password="memberpass123"
    )


@pytest.fixture
def organization(db, owner):
    """Create a test organization."""
    return Organization.objects.create(
        name="Test Organization",
        slug="test-org",
        owner=owner
    )


@pytest.fixture
def plan(db):
    """Create a test plan."""
    return Plan.objects.create(
        name="Pro",
        slug="pro",
        price=Decimal("29.99"),
        interval="monthly"
    )


@pytest.fixture
def subscription(db, organization, plan):
    """Create a test subscription."""
    return Subscription.objects.create(
        organization=organization,
        plan=plan,
        status="active",
        current_period_start=timezone.now(),
        current_period_end=timezone.now() + timezone.timedelta(days=30)
    )


@pytest.fixture
def api_key(db, organization):
    """Create a test API key."""
    from apps.subscriptions.models import APIKey
    return APIKey.objects.create(
        organization=organization,
        name="Test Key",
        key_prefix="sk_test_",
        key_hash="hashed_value",
        scopes=["read"]
    )
