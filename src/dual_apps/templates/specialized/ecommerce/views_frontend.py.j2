"""
E-commerce Frontend Views for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template

HTMX-powered views for e-commerce frontend.
"""

from django.views.generic import (
    ListView, DetailView, TemplateView, View, CreateView
)
from django.contrib.auth.mixins import LoginRequiredMixin
from django.shortcuts import get_object_or_404, redirect
from django.http import HttpResponse
from django.contrib import messages
from django.db.models import Q, Avg

from .models import (
    Category, Product, Cart, CartItem,
    Order, Wishlist, Review, Coupon
)
from .forms import CheckoutForm, ReviewForm


# =============================================================================
# Mixins
# =============================================================================

class CartMixin:
    """Mixin to get cart for current user/session."""

    def get_cart(self):
        if self.request.user.is_authenticated:
            cart, _ = Cart.objects.get_or_create(user=self.request.user)
        else:
            session_key = self.request.session.session_key
            if not session_key:
                self.request.session.create()
                session_key = self.request.session.session_key
            cart, _ = Cart.objects.get_or_create(session_key=session_key)
        return cart


# =============================================================================
# Home & Catalog
# =============================================================================

class HomeView(TemplateView):
    """Home page with featured products."""
    template_name = "shop/home.html"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["featured_products"] = Product.objects.filter(
            is_active=True, is_featured=True
        ).select_related("category").prefetch_related("images")[:8]
        context["categories"] = Category.objects.filter(
            is_active=True, parent__isnull=True
        )[:6]
        context["new_arrivals"] = Product.objects.filter(
            is_active=True
        ).order_by("-created_at")[:8]
        return context


class ProductListView(ListView):
    """Product listing with filters."""
    model = Product
    template_name = "shop/product_list.html"
    context_object_name = "products"
    paginate_by = 12

    def get_queryset(self):
        queryset = Product.objects.filter(is_active=True).select_related(
            "category"
        ).prefetch_related("images")

        # Category filter
        category = self.request.GET.get("category")
        if category:
            queryset = queryset.filter(category__slug=category)

        # Price filter
        min_price = self.request.GET.get("min_price")
        max_price = self.request.GET.get("max_price")
        if min_price:
            queryset = queryset.filter(price__gte=min_price)
        if max_price:
            queryset = queryset.filter(price__lte=max_price)

        # In stock filter
        if self.request.GET.get("in_stock"):
            queryset = queryset.filter(stock_quantity__gt=0)

        # Sort
        sort = self.request.GET.get("sort", "-created_at")
        if sort in ["price", "-price", "name", "-name", "-created_at", "-sold_count"]:
            queryset = queryset.order_by(sort)

        return queryset

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["categories"] = Category.objects.filter(is_active=True)
        context["current_category"] = self.request.GET.get("category")
        return context


class ProductDetailView(DetailView):
    """Product detail page."""
    model = Product
    template_name = "shop/product_detail.html"
    context_object_name = "product"
    slug_field = "slug"

    def get_queryset(self):
        return Product.objects.filter(is_active=True).select_related(
            "category"
        ).prefetch_related("images", "tags", "reviews__user")

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        product = self.object

        # Increment view count
        product.view_count += 1
        product.save(update_fields=["view_count"])

        # Related products
        context["related_products"] = Product.objects.filter(
            is_active=True, category=product.category
        ).exclude(id=product.id)[:4]

        # Reviews
        context["reviews"] = product.reviews.filter(is_approved=True).select_related("user")
        context["average_rating"] = product.average_rating
        context["review_form"] = ReviewForm()

        # Check if user can review
        if self.request.user.is_authenticated:
            context["can_review"] = not Review.objects.filter(
                user=self.request.user, product=product
            ).exists()
        else:
            context["can_review"] = False

        return context


class CategoryView(ListView):
    """Category page with products."""
    model = Product
    template_name = "shop/category.html"
    context_object_name = "products"
    paginate_by = 12

    def get_queryset(self):
        self.category = get_object_or_404(Category, slug=self.kwargs["slug"], is_active=True)
        return Product.objects.filter(
            is_active=True, category=self.category
        ).select_related("category").prefetch_related("images")

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["category"] = self.category
        context["subcategories"] = self.category.children.filter(is_active=True)
        return context


class SearchView(ListView):
    """Search results page."""
    model = Product
    template_name = "shop/search.html"
    context_object_name = "products"
    paginate_by = 12

    def get_queryset(self):
        query = self.request.GET.get("q", "")
        if query:
            return Product.objects.filter(
                Q(is_active=True) & (
                    Q(name__icontains=query) |
                    Q(description__icontains=query) |
                    Q(sku__icontains=query)
                )
            ).select_related("category").prefetch_related("images")
        return Product.objects.none()

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["query"] = self.request.GET.get("q", "")
        return context


# =============================================================================
# Cart
# =============================================================================

class CartView(CartMixin, TemplateView):
    """Shopping cart page."""
    template_name = "shop/cart.html"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context["cart"] = self.get_cart()
        return context


class AddToCartView(CartMixin, View):
    """Add product to cart (HTMX)."""

    def post(self, request, product_id):
        cart = self.get_cart()
        product = get_object_or_404(Product, id=product_id, is_active=True)
        quantity = int(request.POST.get("quantity", 1))

        cart_item, created = CartItem.objects.get_or_create(
            cart=cart,
            product=product,
            defaults={"quantity": quantity}
        )

        if not created:
            cart_item.quantity += quantity
            cart_item.save()

        messages.success(request, f"Added {product.name} to cart")

        # HTMX response
        if request.headers.get("HX-Request"):
            return HttpResponse(
                f'<span id="cart-count" hx-swap-oob="true">{cart.item_count}</span>',
                content_type="text/html"
            )

        return redirect("shop:cart")


class UpdateCartItemView(CartMixin, View):
    """Update cart item quantity (HTMX)."""

    def post(self, request, item_id):
        cart = self.get_cart()
        quantity = int(request.POST.get("quantity", 1))

        try:
            item = cart.items.get(id=item_id)
            if quantity <= 0:
                item.delete()
            else:
                item.quantity = quantity
                item.save()
        except CartItem.DoesNotExist:
            pass

        if request.headers.get("HX-Request"):
            # Return updated cart partial
            return HttpResponse(
                f'<span id="cart-count" hx-swap-oob="true">{cart.item_count}</span>',
                content_type="text/html"
            )

        return redirect("shop:cart")


class RemoveFromCartView(CartMixin, View):
    """Remove item from cart (HTMX)."""

    def post(self, request, item_id):
        cart = self.get_cart()

        try:
            item = cart.items.get(id=item_id)
            item.delete()
            messages.success(request, "Item removed from cart")
        except CartItem.DoesNotExist:
            pass

        if request.headers.get("HX-Request"):
            return HttpResponse(
                f'<span id="cart-count" hx-swap-oob="true">{cart.item_count}</span>',
                content_type="text/html"
            )

        return redirect("shop:cart")


class ApplyCouponView(CartMixin, View):
    """Apply coupon to cart."""

    def post(self, request):
        cart = self.get_cart()
        code = request.POST.get("code", "").upper()

        try:
            coupon = Coupon.objects.get(code=code)
            if coupon.is_valid:
                cart.coupon = coupon
                cart.save()
                messages.success(request, "Coupon applied successfully")
            else:
                messages.error(request, "Coupon is not valid")
        except Coupon.DoesNotExist:
            messages.error(request, "Coupon not found")

        return redirect("shop:cart")


# =============================================================================
# Checkout
# =============================================================================

class CheckoutView(CartMixin, View):
    """Checkout page."""
    template_name = "shop/checkout.html"

    def get(self, request):
        cart = self.get_cart()
        if cart.item_count == 0:
            messages.warning(request, "Your cart is empty")
            return redirect("shop:cart")

        form = CheckoutForm(user=request.user if request.user.is_authenticated else None)
        return render(request, self.template_name, {"cart": cart, "form": form})

    def post(self, request):
        cart = self.get_cart()
        form = CheckoutForm(request.POST, user=request.user if request.user.is_authenticated else None)

        if form.is_valid():
            order = form.save(cart=cart, user=request.user if request.user.is_authenticated else None)
            return redirect("shop:order_confirmation", order_number=order.order_number)

        return render(request, self.template_name, {"cart": cart, "form": form})


class OrderConfirmationView(DetailView):
    """Order confirmation page."""
    model = Order
    template_name = "shop/order_confirmation.html"
    context_object_name = "order"
    slug_field = "order_number"
    slug_url_kwarg = "order_number"


# =============================================================================
# Orders
# =============================================================================

class OrderListView(LoginRequiredMixin, ListView):
    """User's orders list."""
    model = Order
    template_name = "shop/order_list.html"
    context_object_name = "orders"
    paginate_by = 10

    def get_queryset(self):
        return Order.objects.filter(user=self.request.user).order_by("-created_at")


class OrderDetailView(LoginRequiredMixin, DetailView):
    """Order detail page."""
    model = Order
    template_name = "shop/order_detail.html"
    context_object_name = "order"
    slug_field = "order_number"
    slug_url_kwarg = "order_number"

    def get_queryset(self):
        return Order.objects.filter(user=self.request.user)


# =============================================================================
# Wishlist
# =============================================================================

class WishlistView(LoginRequiredMixin, TemplateView):
    """Wishlist page."""
    template_name = "shop/wishlist.html"

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        wishlist, _ = Wishlist.objects.get_or_create(user=self.request.user)
        context["wishlist"] = wishlist
        return context


class AddToWishlistView(LoginRequiredMixin, View):
    """Add to wishlist (HTMX)."""

    def post(self, request, product_id):
        product = get_object_or_404(Product, id=product_id)
        wishlist, _ = Wishlist.objects.get_or_create(user=request.user)
        wishlist.products.add(product)

        if request.headers.get("HX-Request"):
            return HttpResponse('<span class="text-red-500">♥</span>')

        messages.success(request, f"Added {product.name} to wishlist")
        return redirect("shop:wishlist")


class RemoveFromWishlistView(LoginRequiredMixin, View):
    """Remove from wishlist (HTMX)."""

    def post(self, request, product_id):
        product = get_object_or_404(Product, id=product_id)
        wishlist, _ = Wishlist.objects.get_or_create(user=request.user)
        wishlist.products.remove(product)

        if request.headers.get("HX-Request"):
            return HttpResponse('<span class="text-gray-400">♡</span>')

        return redirect("shop:wishlist")


# =============================================================================
# Reviews
# =============================================================================

class CreateReviewView(LoginRequiredMixin, View):
    """Create review for product."""

    def post(self, request, slug):
        product = get_object_or_404(Product, slug=slug)

        # Check if already reviewed
        if Review.objects.filter(user=request.user, product=product).exists():
            messages.error(request, "You have already reviewed this product")
            return redirect("shop:product_detail", slug=slug)

        form = ReviewForm(request.POST)
        if form.is_valid():
            review = form.save(commit=False)
            review.user = request.user
            review.product = product
            review.save()
            messages.success(request, "Thank you for your review!")

        return redirect("shop:product_detail", slug=slug)


# =============================================================================
# HTMX Partials
# =============================================================================

class CartCountPartial(CartMixin, View):
    """Return cart count for header."""

    def get(self, request):
        cart = self.get_cart()
        return HttpResponse(str(cart.item_count))


class ProductCardPartial(View):
    """Return product card HTML."""

    def get(self, request, product_id):
        product = get_object_or_404(Product, id=product_id)
        return render(request, "shop/partials/product_card.html", {"product": product})


# Import render for template rendering
from django.shortcuts import render
