{% raw %}{# Product reviews partial loaded via HTMX #}
<div id="reviews" class="{% if css_framework == 'tailwind' %}space-y-6{% else %}{% endif %}">
    <!-- Review Summary -->
    <div class="{% if css_framework == 'tailwind' %}flex items-start gap-8 mb-8{% else %}row mb-4{% endif %}">
        <div class="{% if css_framework == 'tailwind' %}text-center{% else %}col-md-4 text-center{% endif %}">
            <div class="{% if css_framework == 'tailwind' %}text-5xl font-bold{% else %}display-4 fw-bold{% endif %}">{{ product.avg_rating|floatformat:1 }}</div>
            <div class="{% if css_framework == 'tailwind' %}text-yellow-400 text-2xl{% else %}text-warning h4{% endif %}">
                {% for i in "12345" %}{% if forloop.counter <= product.avg_rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}
            </div>
            <p class="{% if css_framework == 'tailwind' %}text-gray-500{% else %}text-muted{% endif %}">{{ product.review_count }} reviews</p>
        </div>
        <div class="{% if css_framework == 'tailwind' %}flex-1{% else %}col-md-8{% endif %}">
            {% for rating in rating_distribution %}
            <div class="{% if css_framework == 'tailwind' %}flex items-center gap-2 mb-2{% else %}d-flex align-items-center mb-2{% endif %}">
                <span class="{% if css_framework == 'tailwind' %}w-12{% endif %}" style="width: 60px;">{{ rating.stars }} stars</span>
                <div class="{% if css_framework == 'tailwind' %}flex-1 h-4 bg-gray-200 rounded-full overflow-hidden{% else %}progress flex-grow-1{% endif %}" style="height: 20px;">
                    <div class="{% if css_framework == 'tailwind' %}h-full bg-yellow-400{% else %}progress-bar bg-warning{% endif %}"
                         style="width: {{ rating.percentage }}%;"></div>
                </div>
                <span class="{% if css_framework == 'tailwind' %}w-12 text-right text-gray-500{% else %}text-muted{% endif %}" style="width: 50px;">
                    {{ rating.count }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Write Review Button -->
    {% if user.is_authenticated %}
    <button type="button"
            hx-get="{% url 'shop:review_form' product.pk %}"
            hx-target="#review-form-container"
            hx-swap="innerHTML"
            class="{% if css_framework == 'tailwind' %}mb-6 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700{% else %}btn btn-primary mb-4{% endif %}">
        Write a Review
    </button>
    {% else %}
    <p class="{% if css_framework == 'tailwind' %}mb-6 text-gray-600{% else %}mb-4 text-muted{% endif %}">
        <a href="{% url 'account_login' %}?next={{ request.path }}" class="{% if css_framework == 'tailwind' %}text-blue-600{% else %}text-primary{% endif %}">Log in</a> to write a review.
    </p>
    {% endif %}

    <div id="review-form-container"></div>

    <!-- Reviews List -->
    <div class="{% if css_framework == 'tailwind' %}divide-y{% else %}{% endif %}">
        {% for review in reviews %}
        <div class="{% if css_framework == 'tailwind' %}py-6{% else %}border-bottom py-4{% endif %}" id="review-{{ review.pk }}">
            <div class="{% if css_framework == 'tailwind' %}flex items-start gap-4{% else %}d-flex{% endif %}">
                <div class="{% if css_framework == 'tailwind' %}flex-shrink-0{% endif %}">
                    {% if review.user.profile.avatar %}
                    <img src="{{ review.user.profile.avatar.url }}" alt="{{ review.user.username }}"
                         class="{% if css_framework == 'tailwind' %}w-12 h-12 rounded-full{% else %}rounded-circle{% endif %}"
                         style="width: 48px; height: 48px; object-fit: cover;">
                    {% else %}
                    <div class="{% if css_framework == 'tailwind' %}w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center{% else %}rounded-circle bg-secondary d-flex align-items-center justify-content-center{% endif %}"
                         style="width: 48px; height: 48px;">
                        {{ review.user.username|first|upper }}
                    </div>
                    {% endif %}
                </div>
                <div class="{% if css_framework == 'tailwind' %}flex-1{% else %}flex-grow-1 ms-3{% endif %}">
                    <div class="{% if css_framework == 'tailwind' %}flex items-center gap-2 mb-1{% else %}d-flex align-items-center mb-1{% endif %}">
                        <span class="{% if css_framework == 'tailwind' %}font-semibold{% else %}fw-bold{% endif %}">{{ review.user.get_full_name|default:review.user.username }}</span>
                        <span class="{% if css_framework == 'tailwind' %}text-yellow-400{% else %}text-warning{% endif %}">
                            {% for i in "12345" %}{% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}
                        </span>
                        {% if review.verified_purchase %}
                        <span class="{% if css_framework == 'tailwind' %}text-green-600 text-sm{% else %}badge bg-success{% endif %}">Verified Purchase</span>
                        {% endif %}
                    </div>
                    <p class="{% if css_framework == 'tailwind' %}text-sm text-gray-500 mb-2{% else %}small text-muted mb-2{% endif %}">
                        {{ review.created_at|date:"F d, Y" }}
                    </p>
                    {% if review.title %}
                    <h6 class="{% if css_framework == 'tailwind' %}font-semibold mb-2{% else %}fw-bold mb-2{% endif %}">{{ review.title }}</h6>
                    {% endif %}
                    <p class="{% if css_framework == 'tailwind' %}text-gray-700{% else %}mb-2{% endif %}">{{ review.content }}</p>

                    {% if review.images.exists %}
                    <div class="{% if css_framework == 'tailwind' %}flex gap-2 mt-3{% else %}d-flex gap-2 mt-3{% endif %}">
                        {% for image in review.images.all %}
                        <img src="{{ image.url }}" alt="Review image"
                             class="{% if css_framework == 'tailwind' %}w-20 h-20 object-cover rounded cursor-pointer{% else %}rounded{% endif %}"
                             style="width: 80px; height: 80px; object-fit: cover;"
                             onclick="openImageModal('{{ image.url }}')">
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="{% if css_framework == 'tailwind' %}flex items-center gap-4 mt-3{% else %}d-flex align-items-center gap-3 mt-3{% endif %}">
                        <button type="button"
                                hx-post="{% url 'shop:review_helpful' review.pk %}"
                                hx-swap="outerHTML"
                                class="{% if css_framework == 'tailwind' %}text-sm text-gray-500 hover:text-gray-700{% else %}btn btn-sm btn-link text-muted{% endif %}">
                            üëç Helpful ({{ review.helpful_count }})
                        </button>
                        <button type="button"
                                hx-post="{% url 'shop:review_report' review.pk %}"
                                hx-swap="outerHTML"
                                class="{% if css_framework == 'tailwind' %}text-sm text-gray-500 hover:text-red-600{% else %}btn btn-sm btn-link text-muted{% endif %}">
                            üö© Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="{% if css_framework == 'tailwind' %}text-center py-8{% else %}text-center py-4{% endif %}">
            <p class="{% if css_framework == 'tailwind' %}text-gray-500{% else %}text-muted{% endif %}">No reviews yet. Be the first to review this product!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Load More Reviews -->
    {% if reviews.has_next %}
    <div class="{% if css_framework == 'tailwind' %}text-center mt-6{% else %}text-center mt-4{% endif %}">
        <button type="button"
                hx-get="{% url 'shop:product_reviews' product.pk %}?page={{ reviews.next_page_number }}"
                hx-target="#reviews"
                hx-swap="beforeend"
                class="{% if css_framework == 'tailwind' %}px-6 py-2 border rounded hover:bg-gray-50{% else %}btn btn-outline-primary{% endif %}">
            Load More Reviews
        </button>
    </div>
    {% endif %}
</div>
{% endraw %}
