{% raw %}/**
 * Product List Page for {{ project_name_display }}
 */
import React, { useState, useEffect, useCallback } from 'react';
import { useSearchParams, useParams, Link } from 'react-router-dom';
import { apiHelpers } from '../utils/api';
import { useCart } from '../context/CartContext';
import ProductCard from '../components/products/ProductCard';
import FilterSidebar from '../components/products/FilterSidebar';
import Pagination from '../components/common/Pagination';

function ProductListPage() {
  const [searchParams, setSearchParams] = useSearchParams();
  const { slug: categorySlug } = useParams();
  const { addItem } = useCart();

  const [products, setProducts] = useState([]);
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);

  // Get filters from URL
  const currentPage = parseInt(searchParams.get('page') || '1');
  const sortBy = searchParams.get('sort') || 'newest';
  const minPrice = searchParams.get('min_price') || '';
  const maxPrice = searchParams.get('max_price') || '';
  const rating = searchParams.get('rating') || '';
  const inStock = searchParams.get('in_stock') === '1';
  const onSale = searchParams.get('on_sale') === '1';
  const searchQuery = searchParams.get('q') || '';
  const selectedCategories = searchParams.getAll('category');

  // Fetch products
  const fetchProducts = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const params = {
        page: currentPage,
        ordering: sortBy === 'price_low' ? 'price' : sortBy === 'price_high' ? '-price' : sortBy === 'popular' ? '-sold_count' : sortBy === 'rating' ? '-avg_rating' : '-created_at',
      };

      if (categorySlug) params.category = categorySlug;
      if (searchQuery) params.search = searchQuery;
      if (minPrice) params.min_price = minPrice;
      if (maxPrice) params.max_price = maxPrice;
      if (rating) params.min_rating = rating;
      if (inStock) params.in_stock = true;
      if (onSale) params.on_sale = true;
      if (selectedCategories.length) params.categories = selectedCategories.join(',');

      const response = await apiHelpers.getProducts(params);
      setProducts(response.data.results);
      setTotalPages(Math.ceil(response.data.count / 12));
      setTotalCount(response.data.count);
    } catch (err) {
      setError('Failed to load products');
      console.error(err);
    } finally {
      setLoading(false);
    }
  }, [currentPage, sortBy, categorySlug, searchQuery, minPrice, maxPrice, rating, inStock, onSale, selectedCategories]);

  // Fetch categories
  useEffect(() => {
    const fetchCategories = async () => {
      try {
        const response = await apiHelpers.getCategories();
        setCategories(response.data);
      } catch (err) {
        console.error('Failed to load categories:', err);
      }
    };
    fetchCategories();
  }, []);

  // Fetch products when filters change
  useEffect(() => {
    fetchProducts();
  }, [fetchProducts]);

  // Update filters
  const updateFilter = (key, value) => {
    const newParams = new URLSearchParams(searchParams);
    if (value === '' || value === false) {
      newParams.delete(key);
    } else {
      newParams.set(key, value);
    }
    newParams.set('page', '1'); // Reset to first page
    setSearchParams(newParams);
  };

  const handlePageChange = (page) => {
    const newParams = new URLSearchParams(searchParams);
    newParams.set('page', page.toString());
    setSearchParams(newParams);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleAddToCart = async (productId) => {
    const result = await addItem(productId, 1);
    if (result.success) {
      // Show toast notification
    }
  };

  const clearFilters = () => {
    const newParams = new URLSearchParams();
    if (searchQuery) newParams.set('q', searchQuery);
    setSearchParams(newParams);
  };

  return (
{% if css_framework == 'tailwind' %}
    <div className="max-w-7xl mx-auto px-4 py-8">
      {/* Page Header */}
      <div className="mb-8">
        <h1 className="text-2xl font-bold">
          {categorySlug ? categories.find(c => c.slug === categorySlug)?.name || 'Category' : searchQuery ? `Search: "${searchQuery}"` : 'All Products'}
        </h1>
        <p className="text-gray-500 mt-1">{totalCount} products found</p>
      </div>

      <div className="flex flex-col lg:flex-row gap-8">
        {/* Sidebar Filters */}
        <aside className="w-full lg:w-64 shrink-0">
          <FilterSidebar
            categories={categories}
            selectedCategories={selectedCategories}
            minPrice={minPrice}
            maxPrice={maxPrice}
            rating={rating}
            inStock={inStock}
            onSale={onSale}
            onFilterChange={updateFilter}
            onClearFilters={clearFilters}
          />
        </aside>

        {/* Product Grid */}
        <div className="flex-1">
          {/* Sort Controls */}
          <div className="flex justify-between items-center mb-6">
            <span className="text-gray-500">
              Showing {products.length} of {totalCount} products
            </span>
            <select
              value={sortBy}
              onChange={(e) => updateFilter('sort', e.target.value)}
              className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="newest">Newest</option>
              <option value="price_low">Price: Low to High</option>
              <option value="price_high">Price: High to Low</option>
              <option value="popular">Most Popular</option>
              <option value="rating">Highest Rated</option>
            </select>
          </div>

          {/* Loading State */}
          {loading ? (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {[...Array(6)].map((_, i) => (
                <div key={i} className="animate-pulse">
                  <div className="bg-gray-200 h-48 rounded-lg mb-4"></div>
                  <div className="bg-gray-200 h-4 rounded w-3/4 mb-2"></div>
                  <div className="bg-gray-200 h-4 rounded w-1/2"></div>
                </div>
              ))}
            </div>
          ) : error ? (
            <div className="text-center py-12">
              <p className="text-red-500">{error}</p>
              <button
                onClick={fetchProducts}
                className="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                Try Again
              </button>
            </div>
          ) : products.length === 0 ? (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üîç</div>
              <h3 className="text-xl font-semibold mb-2">No products found</h3>
              <p className="text-gray-500 mb-4">Try adjusting your filters</p>
              <button
                onClick={clearFilters}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                Clear Filters
              </button>
            </div>
          ) : (
            <>
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {products.map((product) => (
                  <ProductCard
                    key={product.id}
                    product={product}
                    onAddToCart={() => handleAddToCart(product.id)}
                  />
                ))}
              </div>

              {/* Pagination */}
              {totalPages > 1 && (
                <Pagination
                  currentPage={currentPage}
                  totalPages={totalPages}
                  onPageChange={handlePageChange}
                />
              )}
            </>
          )}
        </div>
      </div>
    </div>
{% else %}
    <div className="container py-4">
      {/* Page Header */}
      <div className="mb-4">
        <h1>
          {categorySlug ? categories.find(c => c.slug === categorySlug)?.name || 'Category' : searchQuery ? `Search: "${searchQuery}"` : 'All Products'}
        </h1>
        <p className="text-muted">{totalCount} products found</p>
      </div>

      <div className="row">
        {/* Sidebar Filters */}
        <aside className="col-lg-3">
          <FilterSidebar
            categories={categories}
            selectedCategories={selectedCategories}
            minPrice={minPrice}
            maxPrice={maxPrice}
            rating={rating}
            inStock={inStock}
            onSale={onSale}
            onFilterChange={updateFilter}
            onClearFilters={clearFilters}
          />
        </aside>

        {/* Product Grid */}
        <div className="col-lg-9">
          {/* Sort Controls */}
          <div className="d-flex justify-content-between align-items-center mb-4">
            <span className="text-muted">
              Showing {products.length} of {totalCount} products
            </span>
            <select
              className="form-select"
              style={{ width: 'auto' }}
              value={sortBy}
              onChange={(e) => updateFilter('sort', e.target.value)}
            >
              <option value="newest">Newest</option>
              <option value="price_low">Price: Low to High</option>
              <option value="price_high">Price: High to Low</option>
              <option value="popular">Most Popular</option>
              <option value="rating">Highest Rated</option>
            </select>
          </div>

          {/* Products */}
          {loading ? (
            <div className="row">
              {[...Array(6)].map((_, i) => (
                <div key={i} className="col-md-6 col-lg-4 mb-4">
                  <div className="card h-100">
                    <div className="card-body">
                      <div className="placeholder-glow">
                        <div className="placeholder col-12 mb-3" style={{ height: 200 }}></div>
                        <span className="placeholder col-8"></span>
                        <span className="placeholder col-4"></span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : error ? (
            <div className="text-center py-5">
              <p className="text-danger">{error}</p>
              <button className="btn btn-primary mt-3" onClick={fetchProducts}>
                Try Again
              </button>
            </div>
          ) : products.length === 0 ? (
            <div className="text-center py-5">
              <div className="mb-4" style={{ fontSize: '5rem' }}>üîç</div>
              <h3>No products found</h3>
              <p className="text-muted">Try adjusting your filters</p>
              <button className="btn btn-primary" onClick={clearFilters}>
                Clear Filters
              </button>
            </div>
          ) : (
            <>
              <div className="row">
                {products.map((product) => (
                  <div key={product.id} className="col-md-6 col-lg-4 mb-4">
                    <ProductCard
                      product={product}
                      onAddToCart={() => handleAddToCart(product.id)}
                    />
                  </div>
                ))}
              </div>

              {totalPages > 1 && (
                <Pagination
                  currentPage={currentPage}
                  totalPages={totalPages}
                  onPageChange={handlePageChange}
                />
              )}
            </>
          )}
        </div>
      </div>
    </div>
{% endif %}
  );
}

export default ProductListPage;
{% endraw %}
