{% raw %}/**
 * Cart Context for {{ project_name_display }}
 * Manages shopping cart state and operations
 */
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import api from '../utils/api';
import { useAuth } from './AuthContext';

const CartContext = createContext(null);

export function useCart() {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
}

export function CartProvider({ children }) {
  const { isAuthenticated } = useAuth();
  const [cart, setCart] = useState({
    items: [],
    subtotal: 0,
    shipping: 0,
    tax: 0,
    discount: 0,
    total: 0,
    coupon: null,
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Local storage key for guest cart
  const CART_KEY = '{{ project_name }}_cart';

  // Load cart from API or localStorage
  const loadCart = useCallback(async () => {
    setLoading(true);
    try {
      if (isAuthenticated) {
        const response = await api.get('/api/v1/cart/');
        setCart(response.data);
      } else {
        // Load from localStorage for guests
        const savedCart = localStorage.getItem(CART_KEY);
        if (savedCart) {
          setCart(JSON.parse(savedCart));
        }
      }
    } catch (err) {
      console.error('Failed to load cart:', err);
      setError('Failed to load cart');
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated]);

  // Load cart on mount and when auth changes
  useEffect(() => {
    loadCart();
  }, [loadCart]);

  // Save guest cart to localStorage
  const saveGuestCart = useCallback((cartData) => {
    localStorage.setItem(CART_KEY, JSON.stringify(cartData));
  }, []);

  // Calculate totals for guest cart
  const calculateTotals = (items) => {
    const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * 0.08; // 8% tax
    const total = subtotal + tax;
    return { subtotal, tax, total, shipping: 0, discount: 0 };
  };

  // Add item to cart
  const addItem = useCallback(async (productId, quantity = 1, variantId = null) => {
    setError(null);
    try {
      if (isAuthenticated) {
        const response = await api.post('/api/v1/cart/items/', {
          product_id: productId,
          quantity,
          variant_id: variantId,
        });
        setCart(response.data);
        return { success: true };
      } else {
        // Handle guest cart
        const productResponse = await api.get(`/api/v1/products/${productId}/`);
        const product = productResponse.data;

        setCart((prevCart) => {
          const existingIndex = prevCart.items.findIndex(
            (item) => item.product_id === productId && item.variant_id === variantId
          );

          let newItems;
          if (existingIndex >= 0) {
            newItems = prevCart.items.map((item, index) =>
              index === existingIndex
                ? { ...item, quantity: item.quantity + quantity }
                : item
            );
          } else {
            newItems = [
              ...prevCart.items,
              {
                id: Date.now(),
                product_id: productId,
                variant_id: variantId,
                name: product.name,
                image: product.image,
                price: product.sale_price || product.price,
                quantity,
              },
            ];
          }

          const newCart = { ...prevCart, items: newItems, ...calculateTotals(newItems) };
          saveGuestCart(newCart);
          return newCart;
        });
        return { success: true };
      }
    } catch (err) {
      const message = err.response?.data?.detail || 'Failed to add item';
      setError(message);
      return { success: false, error: message };
    }
  }, [isAuthenticated, saveGuestCart]);

  // Update item quantity
  const updateItem = useCallback(async (itemId, quantity) => {
    setError(null);
    try {
      if (quantity <= 0) {
        return removeItem(itemId);
      }

      if (isAuthenticated) {
        const response = await api.patch(`/api/v1/cart/items/${itemId}/`, { quantity });
        setCart(response.data);
        return { success: true };
      } else {
        setCart((prevCart) => {
          const newItems = prevCart.items.map((item) =>
            item.id === itemId ? { ...item, quantity } : item
          );
          const newCart = { ...prevCart, items: newItems, ...calculateTotals(newItems) };
          saveGuestCart(newCart);
          return newCart;
        });
        return { success: true };
      }
    } catch (err) {
      const message = err.response?.data?.detail || 'Failed to update item';
      setError(message);
      return { success: false, error: message };
    }
  }, [isAuthenticated, saveGuestCart]);

  // Remove item from cart
  const removeItem = useCallback(async (itemId) => {
    setError(null);
    try {
      if (isAuthenticated) {
        const response = await api.delete(`/api/v1/cart/items/${itemId}/`);
        setCart(response.data);
        return { success: true };
      } else {
        setCart((prevCart) => {
          const newItems = prevCart.items.filter((item) => item.id !== itemId);
          const newCart = { ...prevCart, items: newItems, ...calculateTotals(newItems) };
          saveGuestCart(newCart);
          return newCart;
        });
        return { success: true };
      }
    } catch (err) {
      const message = err.response?.data?.detail || 'Failed to remove item';
      setError(message);
      return { success: false, error: message };
    }
  }, [isAuthenticated, saveGuestCart]);

  // Clear cart
  const clearCart = useCallback(async () => {
    setError(null);
    try {
      if (isAuthenticated) {
        await api.delete('/api/v1/cart/');
      }
      const emptyCart = {
        items: [],
        subtotal: 0,
        shipping: 0,
        tax: 0,
        discount: 0,
        total: 0,
        coupon: null,
      };
      setCart(emptyCart);
      saveGuestCart(emptyCart);
      return { success: true };
    } catch (err) {
      const message = err.response?.data?.detail || 'Failed to clear cart';
      setError(message);
      return { success: false, error: message };
    }
  }, [isAuthenticated, saveGuestCart]);

  // Apply coupon
  const applyCoupon = useCallback(async (code) => {
    setError(null);
    try {
      const response = await api.post('/api/v1/cart/coupon/', { code });
      setCart(response.data);
      return { success: true };
    } catch (err) {
      const message = err.response?.data?.detail || 'Invalid coupon code';
      setError(message);
      return { success: false, error: message };
    }
  }, []);

  // Remove coupon
  const removeCoupon = useCallback(async () => {
    setError(null);
    try {
      const response = await api.delete('/api/v1/cart/coupon/');
      setCart(response.data);
      return { success: true };
    } catch (err) {
      const message = err.response?.data?.detail || 'Failed to remove coupon';
      setError(message);
      return { success: false, error: message };
    }
  }, []);

  // Merge guest cart with user cart after login
  const mergeGuestCart = useCallback(async () => {
    const savedCart = localStorage.getItem(CART_KEY);
    if (!savedCart) return;

    const guestCart = JSON.parse(savedCart);
    if (guestCart.items.length === 0) return;

    try {
      await api.post('/api/v1/cart/merge/', { items: guestCart.items });
      localStorage.removeItem(CART_KEY);
      await loadCart();
    } catch (err) {
      console.error('Failed to merge cart:', err);
    }
  }, [loadCart]);

  const value = {
    cart,
    loading,
    error,
    itemCount: cart.items.reduce((sum, item) => sum + item.quantity, 0),
    addItem,
    updateItem,
    removeItem,
    clearCart,
    applyCoupon,
    removeCoupon,
    loadCart,
    mergeGuestCart,
  };

  return (
    <CartContext.Provider value={value}>
      {children}
    </CartContext.Provider>
  );
}

export default CartContext;
{% endraw %}
