{% raw %}{% extends "base.html" %}

{% block title %}Checkout - {{ project_name_display }}{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Checkout</h1>

    <form method="post" action="{% url 'shop:checkout' %}" id="checkout-form">
        {% csrf_token %}
        <div class="row">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <!-- Contact Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">1. Contact Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email"
                                       value="{{ user.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" name="phone"
                                       placeholder="+1 (555) 000-0000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">2. Shipping Address</h5>
                    </div>
                    <div class="card-body">
                        {% if user.addresses.exists %}
                        <div class="mb-3">
                            <label class="form-label">Saved Addresses</label>
                            {% for address in user.addresses.all %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shipping_address"
                                       id="address_{{ address.pk }}" value="{{ address.pk }}"
                                       {% if forloop.first %}checked{% endif %}>
                                <label class="form-check-label" for="address_{{ address.pk }}">
                                    {{ address.full_name }}, {{ address.address_line_1 }}, {{ address.city }}, {{ address.state }} {{ address.postal_code }}
                                </label>
                            </div>
                            {% endfor %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="shipping_address"
                                       id="address_new" value="new">
                                <label class="form-check-label" for="address_new">
                                    Use a new address
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <div id="new-address-form" {% if user.addresses.exists %}style="display: none;"{% endif %}>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name">
                                </div>
                                <div class="col-md-6">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name">
                                </div>
                                <div class="col-12">
                                    <label for="address1" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address1" name="address_line_1"
                                           placeholder="123 Main St">
                                </div>
                                <div class="col-12">
                                    <label for="address2" class="form-label">Address Line 2 <small class="text-muted">(Optional)</small></label>
                                    <input type="text" class="form-control" id="address2" name="address_line_2"
                                           placeholder="Apartment, suite, etc.">
                                </div>
                                <div class="col-md-6">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city">
                                </div>
                                <div class="col-md-4">
                                    <label for="state" class="form-label">State</label>
                                    <input type="text" class="form-control" id="state" name="state">
                                </div>
                                <div class="col-md-2">
                                    <label for="postal_code" class="form-label">ZIP</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code">
                                </div>
                                <div class="col-12">
                                    <label for="country" class="form-label">Country</label>
                                    <select class="form-select" id="country" name="country">
                                        <option value="US" selected>United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="GB">United Kingdom</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Method -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">3. Shipping Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="shipping_method"
                                   id="shipping_standard" value="standard" checked>
                            <label class="form-check-label d-flex justify-content-between" for="shipping_standard">
                                <span>Standard Shipping (5-7 business days)</span>
                                <span>$5.99</span>
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="shipping_method"
                                   id="shipping_express" value="express">
                            <label class="form-check-label d-flex justify-content-between" for="shipping_express">
                                <span>Express Shipping (2-3 business days)</span>
                                <span>$12.99</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="shipping_method"
                                   id="shipping_overnight" value="overnight">
                            <label class="form-check-label d-flex justify-content-between" for="shipping_overnight">
                                <span>Overnight Shipping (next business day)</span>
                                <span>$24.99</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">4. Payment Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="card_number" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="card_number" name="card_number"
                                   placeholder="1234 5678 9012 3456" maxlength="19" required>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="expiry" class="form-label">Expiration Date</label>
                                <input type="text" class="form-control" id="expiry" name="expiry"
                                       placeholder="MM/YY" maxlength="5" required>
                            </div>
                            <div class="col-md-6">
                                <label for="cvv" class="form-label">CVV</label>
                                <input type="text" class="form-control" id="cvv" name="cvv"
                                       placeholder="123" maxlength="4" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label for="card_name" class="form-label">Name on Card</label>
                            <input type="text" class="form-control" id="card_name" name="card_name" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cart Items -->
                        {% for item in cart.items.all %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>
                                {{ item.product.name|truncatewords:3 }}
                                <small class="text-muted">Ã— {{ item.quantity }}</small>
                            </span>
                            <span>${{ item.total }}</span>
                        </div>
                        {% endfor %}

                        <hr>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span>${{ cart.subtotal }}</span>
                        </div>
                        {% if cart.discount %}
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Discount</span>
                            <span>-${{ cart.discount }}</span>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span id="shipping-cost">$5.99</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax</span>
                            <span>${{ cart.tax|default:"0.00" }}</span>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total</strong>
                            <strong class="h5" id="order-total">${{ cart.total }}</strong>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            Place Order
                        </button>

                        <p class="small text-muted text-center mt-3">
                            By placing this order, you agree to our
                            <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Toggle new address form
document.querySelectorAll('input[name="shipping_address"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        var form = document.getElementById('new-address-form');
        form.style.display = this.value === 'new' ? 'block' : 'none';
    });
});

// Update shipping cost display
document.querySelectorAll('input[name="shipping_method"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        var costs = {'standard': '$5.99', 'express': '$12.99', 'overnight': '$24.99'};
        document.getElementById('shipping-cost').textContent = costs[this.value];
    });
});
</script>
{% endblock %}
{% endraw %}