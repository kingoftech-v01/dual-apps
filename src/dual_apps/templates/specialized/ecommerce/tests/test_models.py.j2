"""
E-commerce Model Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template

Tests for all e-commerce models:
- Category, Product, ProductImage, Tag
- Cart, CartItem
- Order, OrderItem, Payment, Shipment
- Discount, Coupon
- Review, Wishlist
"""

import pytest
from decimal import Decimal
from django.utils import timezone
from django.core.exceptions import ValidationError

from apps.shop.models import (
    Category, Product, ProductImage, Tag,
    Cart, CartItem, Order, OrderItem, Payment, Shipment,
    Discount, Coupon, Review, Wishlist
)


# =============================================================================
# Category Tests
# =============================================================================

class TestCategory:
    """Tests for Category model."""

    def test_create_category(self, db):
        """Test creating a category."""
        category = Category.objects.create(
            name="Electronics",
            description="Electronic devices"
        )
        assert category.id is not None
        assert category.name == "Electronics"
        assert category.slug == "electronics"
        assert category.is_active is True

    def test_category_auto_slug(self, db):
        """Test automatic slug generation."""
        category = Category.objects.create(name="Home & Garden")
        assert category.slug == "home-garden"

    def test_category_hierarchy(self, db):
        """Test parent-child category relationship."""
        parent = Category.objects.create(name="Electronics")
        child = Category.objects.create(name="Phones", parent=parent)

        assert child.parent == parent
        assert child in parent.children.all()

    def test_category_full_path(self, db):
        """Test full_path property for nested categories."""
        parent = Category.objects.create(name="Electronics")
        child = Category.objects.create(name="Phones", parent=parent)
        grandchild = Category.objects.create(name="Smartphones", parent=child)

        assert grandchild.full_path == "Electronics > Phones > Smartphones"


# =============================================================================
# Product Tests
# =============================================================================

class TestProduct:
    """Tests for Product model."""

    def test_create_product(self, db, category):
        """Test creating a product."""
        product = Product.objects.create(
            name="Test Product",
            description="A test product",
            price=Decimal("99.99"),
            category=category
        )
        assert product.id is not None
        assert product.name == "Test Product"
        assert product.price == Decimal("99.99")
        assert product.is_active is True
        assert product.stock_status == "in_stock"

    def test_product_auto_slug(self, db, category):
        """Test automatic slug generation."""
        product = Product.objects.create(
            name="Amazing Product 123",
            description="Test",
            price=Decimal("10.00"),
            category=category
        )
        assert product.slug == "amazing-product-123"

    def test_product_is_on_sale(self, db, category):
        """Test is_on_sale property."""
        product = Product.objects.create(
            name="Sale Product",
            description="Test",
            price=Decimal("79.99"),
            compare_at_price=Decimal("99.99"),
            category=category
        )
        assert product.is_on_sale is True

    def test_product_discount_percentage(self, db, category):
        """Test discount_percentage property."""
        product = Product.objects.create(
            name="Discount Product",
            description="Test",
            price=Decimal("80.00"),
            compare_at_price=Decimal("100.00"),
            category=category
        )
        assert product.discount_percentage == 20

    def test_product_is_in_stock(self, db, category):
        """Test is_in_stock property."""
        product = Product.objects.create(
            name="In Stock Product",
            description="Test",
            price=Decimal("10.00"),
            stock_quantity=10,
            category=category
        )
        assert product.is_in_stock is True

        product.stock_quantity = 0
        product.save()
        assert product.is_in_stock is False

    def test_product_average_rating(self, db, product, user):
        """Test average_rating property."""
        Review.objects.create(product=product, user=user, rating=5)
        Review.objects.create(product=product, user=user, rating=3)

        # Since unique_together is product/user, we need different users
        from django.contrib.auth import get_user_model
        User = get_user_model()
        user2 = User.objects.create_user(username="reviewer2", password="pass123")
        Review.objects.filter(rating=3).update(user=user2)

        assert product.average_rating == 4.0


# =============================================================================
# Cart Tests
# =============================================================================

class TestCart:
    """Tests for Cart and CartItem models."""

    def test_create_cart_for_user(self, db, user):
        """Test creating a cart for authenticated user."""
        cart = Cart.objects.create(user=user)
        assert cart.id is not None
        assert cart.user == user

    def test_create_cart_for_guest(self, db):
        """Test creating a cart for guest user."""
        cart = Cart.objects.create(session_key="test-session-key")
        assert cart.session_key == "test-session-key"
        assert cart.user is None

    def test_cart_add_item(self, db, user, product):
        """Test adding item to cart."""
        cart = Cart.objects.create(user=user)
        item = CartItem.objects.create(cart=cart, product=product, quantity=2)

        assert item.quantity == 2
        assert item.product == product
        assert cart.items.count() == 1

    def test_cart_subtotal(self, db, user, product):
        """Test cart subtotal calculation."""
        cart = Cart.objects.create(user=user)
        CartItem.objects.create(cart=cart, product=product, quantity=2)

        expected = product.price * 2
        assert cart.subtotal == expected

    def test_cart_item_count(self, db, user, product, category):
        """Test cart item count."""
        cart = Cart.objects.create(user=user)
        CartItem.objects.create(cart=cart, product=product, quantity=2)

        product2 = Product.objects.create(
            name="Product 2",
            description="Test",
            price=Decimal("50.00"),
            category=category
        )
        CartItem.objects.create(cart=cart, product=product2, quantity=3)

        assert cart.item_count == 5

    def test_cart_merge(self, db, user, product, category):
        """Test merging two carts."""
        cart1 = Cart.objects.create(user=user)
        CartItem.objects.create(cart=cart1, product=product, quantity=1)

        cart2 = Cart.objects.create(session_key="guest-session")
        product2 = Product.objects.create(
            name="Product 2",
            description="Test",
            price=Decimal("50.00"),
            category=category
        )
        CartItem.objects.create(cart=cart2, product=product2, quantity=2)

        cart1.merge_with(cart2)

        assert cart1.items.count() == 2
        assert not Cart.objects.filter(id=cart2.id).exists()


# =============================================================================
# Order Tests
# =============================================================================

class TestOrder:
    """Tests for Order model."""

    def test_create_order(self, db, user):
        """Test creating an order."""
        order = Order.objects.create(
            user=user,
            email=user.email or "test@example.com",
            subtotal=Decimal("100.00"),
            total=Decimal("100.00"),
            shipping_first_name="John",
            shipping_last_name="Doe",
            shipping_address1="123 Main St",
            shipping_city="New York",
            shipping_state="NY",
            shipping_postal_code="10001",
            shipping_country="USA"
        )
        assert order.id is not None
        assert order.order_number is not None
        assert order.status == "pending"

    def test_order_number_generation(self, db, user):
        """Test order number is auto-generated."""
        order = Order.objects.create(
            user=user,
            email="test@example.com",
            subtotal=Decimal("100.00"),
            total=Decimal("100.00"),
            shipping_first_name="John",
            shipping_last_name="Doe",
            shipping_address1="123 Main St",
            shipping_city="New York",
            shipping_state="NY",
            shipping_postal_code="10001",
            shipping_country="USA"
        )
        assert len(order.order_number) > 0
        assert "-" in order.order_number

    def test_order_items(self, db, user, product):
        """Test order with items."""
        order = Order.objects.create(
            user=user,
            email="test@example.com",
            subtotal=Decimal("99.99"),
            total=Decimal("99.99"),
            shipping_first_name="John",
            shipping_last_name="Doe",
            shipping_address1="123 Main St",
            shipping_city="New York",
            shipping_state="NY",
            shipping_postal_code="10001",
            shipping_country="USA"
        )

        item = OrderItem.objects.create(
            order=order,
            product=product,
            quantity=1,
            unit_price=product.price
        )

        assert item.product_name == product.name
        assert item.total == product.price


# =============================================================================
# Discount and Coupon Tests
# =============================================================================

class TestDiscount:
    """Tests for Discount model."""

    def test_create_percentage_discount(self, db):
        """Test creating a percentage discount."""
        discount = Discount.objects.create(
            name="Summer Sale",
            discount_type="percentage",
            value=Decimal("20"),
            start_date=timezone.now(),
            end_date=timezone.now() + timezone.timedelta(days=30)
        )
        assert discount.calculate_discount(Decimal("100.00")) == Decimal("20.00")

    def test_create_fixed_discount(self, db):
        """Test creating a fixed amount discount."""
        discount = Discount.objects.create(
            name="$10 Off",
            discount_type="fixed",
            value=Decimal("10"),
            start_date=timezone.now(),
            end_date=timezone.now() + timezone.timedelta(days=30)
        )
        assert discount.calculate_discount(Decimal("100.00")) == Decimal("10.00")

    def test_discount_is_valid(self, db):
        """Test discount validity check."""
        valid_discount = Discount.objects.create(
            name="Valid",
            discount_type="percentage",
            value=Decimal("10"),
            start_date=timezone.now() - timezone.timedelta(days=1),
            end_date=timezone.now() + timezone.timedelta(days=30)
        )
        assert valid_discount.is_valid is True

        expired_discount = Discount.objects.create(
            name="Expired",
            discount_type="percentage",
            value=Decimal("10"),
            start_date=timezone.now() - timezone.timedelta(days=30),
            end_date=timezone.now() - timezone.timedelta(days=1)
        )
        assert expired_discount.is_valid is False

    def test_discount_max_amount(self, db):
        """Test discount with maximum amount limit."""
        discount = Discount.objects.create(
            name="Big Sale",
            discount_type="percentage",
            value=Decimal("50"),
            max_discount_amount=Decimal("25.00"),
            start_date=timezone.now(),
            end_date=timezone.now() + timezone.timedelta(days=30)
        )
        # 50% of 100 = 50, but max is 25
        assert discount.calculate_discount(Decimal("100.00")) == Decimal("25.00")


class TestCoupon:
    """Tests for Coupon model."""

    def test_create_coupon(self, db, discount):
        """Test creating a coupon."""
        coupon = Coupon.objects.create(
            code="SAVE20",
            discount=discount,
            max_uses=100
        )
        assert coupon.code == "SAVE20"
        assert coupon.used_count == 0

    def test_coupon_use(self, db, discount):
        """Test using a coupon."""
        coupon = Coupon.objects.create(
            code="SINGLE",
            discount=discount,
            max_uses=1
        )
        assert coupon.is_valid is True

        coupon.use()
        assert coupon.used_count == 1
        assert coupon.is_valid is False


# =============================================================================
# Review Tests
# =============================================================================

class TestReview:
    """Tests for Review model."""

    def test_create_review(self, db, product, user):
        """Test creating a review."""
        review = Review.objects.create(
            product=product,
            user=user,
            rating=5,
            title="Great product!",
            comment="I love this product."
        )
        assert review.rating == 5
        assert review.is_approved is True

    def test_review_unique_per_user(self, db, product, user):
        """Test user can only review a product once."""
        Review.objects.create(product=product, user=user, rating=5)

        from django.db import IntegrityError
        with pytest.raises(IntegrityError):
            Review.objects.create(product=product, user=user, rating=3)


# =============================================================================
# Wishlist Tests
# =============================================================================

class TestWishlist:
    """Tests for Wishlist model."""

    def test_create_wishlist(self, db, user):
        """Test creating a wishlist."""
        wishlist = Wishlist.objects.create(user=user)
        assert wishlist.user == user
        assert wishlist.count == 0

    def test_add_to_wishlist(self, db, user, product):
        """Test adding product to wishlist."""
        wishlist = Wishlist.objects.create(user=user)
        wishlist.products.add(product)

        assert wishlist.count == 1
        assert product in wishlist.products.all()


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(name="Test Category")


@pytest.fixture
def product(db, category):
    """Create a test product."""
    return Product.objects.create(
        name="Test Product",
        description="A test product",
        price=Decimal("99.99"),
        stock_quantity=100,
        category=category
    )


@pytest.fixture
def user(db):
    """Create a test user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="testuser",
        email="test@example.com",
        password="testpass123"
    )


@pytest.fixture
def discount(db):
    """Create a test discount."""
    return Discount.objects.create(
        name="Test Discount",
        discount_type="percentage",
        value=Decimal("10"),
        start_date=timezone.now(),
        end_date=timezone.now() + timezone.timedelta(days=30)
    )
