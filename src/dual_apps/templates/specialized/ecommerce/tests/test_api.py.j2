"""
E-commerce API Tests for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template

Tests for all e-commerce API endpoints.
"""

import pytest
from decimal import Decimal
from rest_framework import status
from django.urls import reverse

from apps.shop.models import (
    Category, Product, Cart, CartItem, Order, Review, Wishlist
)


# =============================================================================
# Category API Tests
# =============================================================================

class TestCategoryAPI:
    """Tests for Category API endpoints."""

    def test_list_categories(self, api_client, category):
        """Test listing categories."""
        response = api_client.get("/api/v1/shop/categories/")
        assert response.status_code == status.HTTP_200_OK
        assert len(response.data["results"]) >= 1

    def test_retrieve_category(self, api_client, category):
        """Test retrieving a category."""
        response = api_client.get(f"/api/v1/shop/categories/{category.id}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["name"] == category.name

    def test_filter_categories_by_parent(self, api_client, db):
        """Test filtering categories by parent."""
        parent = Category.objects.create(name="Parent")
        child = Category.objects.create(name="Child", parent=parent)

        response = api_client.get(f"/api/v1/shop/categories/?parent={parent.id}")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Product API Tests
# =============================================================================

class TestProductAPI:
    """Tests for Product API endpoints."""

    def test_list_products(self, api_client, product):
        """Test listing products."""
        response = api_client.get("/api/v1/shop/products/")
        assert response.status_code == status.HTTP_200_OK

    def test_retrieve_product(self, api_client, product):
        """Test retrieving a product."""
        response = api_client.get(f"/api/v1/shop/products/{product.id}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["name"] == product.name

    def test_filter_products_by_category(self, api_client, product, category):
        """Test filtering products by category."""
        response = api_client.get(f"/api/v1/shop/products/?category={category.id}")
        assert response.status_code == status.HTTP_200_OK

    def test_search_products(self, api_client, product):
        """Test searching products."""
        response = api_client.get(f"/api/v1/shop/products/?search={product.name[:4]}")
        assert response.status_code == status.HTTP_200_OK

    def test_filter_products_in_stock(self, api_client, product):
        """Test filtering in-stock products."""
        response = api_client.get("/api/v1/shop/products/?in_stock=true")
        assert response.status_code == status.HTTP_200_OK

    def test_filter_featured_products(self, api_client, db, category):
        """Test filtering featured products."""
        Product.objects.create(
            name="Featured",
            description="Test",
            price=Decimal("10.00"),
            is_featured=True,
            category=category
        )
        response = api_client.get("/api/v1/shop/products/?is_featured=true")
        assert response.status_code == status.HTTP_200_OK


# =============================================================================
# Cart API Tests
# =============================================================================

class TestCartAPI:
    """Tests for Cart API endpoints."""

    def test_get_cart(self, auth_api_client, user):
        """Test getting user's cart."""
        response = auth_api_client.get("/api/v1/shop/cart/")
        assert response.status_code == status.HTTP_200_OK

    def test_add_to_cart(self, auth_api_client, product, user):
        """Test adding item to cart."""
        response = auth_api_client.post("/api/v1/shop/cart/add/", {
            "product_id": str(product.id),
            "quantity": 2
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_update_cart_item(self, auth_api_client, cart_with_item, user):
        """Test updating cart item quantity."""
        cart, item = cart_with_item
        response = auth_api_client.patch(f"/api/v1/shop/cart/items/{item.id}/", {
            "quantity": 5
        })
        assert response.status_code == status.HTTP_200_OK

    def test_remove_from_cart(self, auth_api_client, cart_with_item, user):
        """Test removing item from cart."""
        cart, item = cart_with_item
        response = auth_api_client.delete(f"/api/v1/shop/cart/items/{item.id}/")
        assert response.status_code == status.HTTP_204_NO_CONTENT

    def test_clear_cart(self, auth_api_client, cart_with_item, user):
        """Test clearing cart."""
        response = auth_api_client.post("/api/v1/shop/cart/clear/")
        assert response.status_code == status.HTTP_200_OK

    def test_apply_coupon(self, auth_api_client, cart_with_item, coupon, user):
        """Test applying coupon to cart."""
        response = auth_api_client.post("/api/v1/shop/cart/apply-coupon/", {
            "code": coupon.code
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_400_BAD_REQUEST]


# =============================================================================
# Order API Tests
# =============================================================================

class TestOrderAPI:
    """Tests for Order API endpoints."""

    def test_list_orders_authenticated(self, auth_api_client, order, user):
        """Test listing user's orders."""
        response = auth_api_client.get("/api/v1/shop/orders/")
        assert response.status_code == status.HTTP_200_OK

    def test_list_orders_unauthenticated(self, api_client):
        """Test orders require authentication."""
        response = api_client.get("/api/v1/shop/orders/")
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]

    def test_retrieve_own_order(self, auth_api_client, order, user):
        """Test retrieving own order."""
        response = auth_api_client.get(f"/api/v1/shop/orders/{order.id}/")
        assert response.status_code == status.HTTP_200_OK
        assert response.data["order_number"] == order.order_number

    def test_create_order_from_cart(self, auth_api_client, cart_with_item, user):
        """Test creating order from cart."""
        response = auth_api_client.post("/api/v1/shop/orders/checkout/", {
            "shipping_first_name": "John",
            "shipping_last_name": "Doe",
            "shipping_address1": "123 Main St",
            "shipping_city": "New York",
            "shipping_state": "NY",
            "shipping_postal_code": "10001",
            "shipping_country": "USA",
            "email": "test@example.com"
        })
        # Could be 201 or redirect/other status depending on implementation
        assert response.status_code in [
            status.HTTP_200_OK,
            status.HTTP_201_CREATED,
            status.HTTP_400_BAD_REQUEST  # If cart is empty after test
        ]


# =============================================================================
# Review API Tests
# =============================================================================

class TestReviewAPI:
    """Tests for Review API endpoints."""

    def test_list_product_reviews(self, api_client, product, review):
        """Test listing product reviews."""
        response = api_client.get(f"/api/v1/shop/products/{product.id}/reviews/")
        assert response.status_code == status.HTTP_200_OK

    def test_create_review_authenticated(self, auth_api_client, product, user):
        """Test creating a review when authenticated."""
        response = auth_api_client.post(f"/api/v1/shop/products/{product.id}/reviews/", {
            "rating": 5,
            "title": "Great!",
            "comment": "Love it!"
        })
        assert response.status_code in [status.HTTP_201_CREATED, status.HTTP_400_BAD_REQUEST]

    def test_create_review_unauthenticated(self, api_client, product):
        """Test reviews require authentication."""
        response = api_client.post(f"/api/v1/shop/products/{product.id}/reviews/", {
            "rating": 5
        })
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]


# =============================================================================
# Wishlist API Tests
# =============================================================================

class TestWishlistAPI:
    """Tests for Wishlist API endpoints."""

    def test_get_wishlist(self, auth_api_client, user):
        """Test getting user's wishlist."""
        response = auth_api_client.get("/api/v1/shop/wishlist/")
        assert response.status_code == status.HTTP_200_OK

    def test_add_to_wishlist(self, auth_api_client, product, user):
        """Test adding product to wishlist."""
        response = auth_api_client.post("/api/v1/shop/wishlist/add/", {
            "product_id": str(product.id)
        })
        assert response.status_code in [status.HTTP_200_OK, status.HTTP_201_CREATED]

    def test_remove_from_wishlist(self, auth_api_client, wishlist_with_product, user):
        """Test removing product from wishlist."""
        wishlist, product = wishlist_with_product
        response = auth_api_client.post("/api/v1/shop/wishlist/remove/", {
            "product_id": str(product.id)
        })
        assert response.status_code == status.HTTP_200_OK

    def test_wishlist_unauthenticated(self, api_client):
        """Test wishlist requires authentication."""
        response = api_client.get("/api/v1/shop/wishlist/")
        assert response.status_code in [status.HTTP_401_UNAUTHORIZED, status.HTTP_403_FORBIDDEN]


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, user):
    """Create authenticated API client."""
    api_client.force_authenticate(user=user)
    return api_client


@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(name="Test Category")


@pytest.fixture
def product(db, category):
    """Create a test product."""
    return Product.objects.create(
        name="Test Product",
        description="A test product",
        price=Decimal("99.99"),
        stock_quantity=100,
        category=category
    )


@pytest.fixture
def user(db):
    """Create a test user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="testuser",
        email="test@example.com",
        password="testpass123"
    )


@pytest.fixture
def cart_with_item(db, user, product):
    """Create a cart with one item."""
    cart = Cart.objects.create(user=user)
    item = CartItem.objects.create(cart=cart, product=product, quantity=2)
    return cart, item


@pytest.fixture
def order(db, user):
    """Create a test order."""
    return Order.objects.create(
        user=user,
        email="test@example.com",
        subtotal=Decimal("100.00"),
        total=Decimal("100.00"),
        shipping_first_name="John",
        shipping_last_name="Doe",
        shipping_address1="123 Main St",
        shipping_city="New York",
        shipping_state="NY",
        shipping_postal_code="10001",
        shipping_country="USA"
    )


@pytest.fixture
def review(db, product, user):
    """Create a test review."""
    return Review.objects.create(
        product=product,
        user=user,
        rating=5,
        title="Great!",
        comment="Excellent product"
    )


@pytest.fixture
def coupon(db):
    """Create a test coupon."""
    from apps.shop.models import Discount, Coupon
    from django.utils import timezone

    discount = Discount.objects.create(
        name="Test Discount",
        discount_type="percentage",
        value=Decimal("10"),
        start_date=timezone.now(),
        end_date=timezone.now() + timezone.timedelta(days=30)
    )
    return Coupon.objects.create(code="TEST10", discount=discount)


@pytest.fixture
def wishlist_with_product(db, user, product):
    """Create a wishlist with a product."""
    wishlist = Wishlist.objects.create(user=user)
    wishlist.products.add(product)
    return wishlist, product
