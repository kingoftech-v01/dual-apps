"""
E-commerce Test Fixtures for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template

Shared pytest fixtures for e-commerce tests.
"""

import pytest
from decimal import Decimal
from django.utils import timezone

from apps.shop.models import (
    Category, Product, ProductImage, Tag,
    Cart, CartItem, Order, OrderItem, Payment,
    Discount, Coupon, Review, Wishlist
)


# =============================================================================
# User Fixtures
# =============================================================================

@pytest.fixture
def user(db):
    """Create a regular test user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="shopuser",
        email="shop@example.com",
        password="testpass123"
    )


@pytest.fixture
def admin_user(db):
    """Create an admin user."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_superuser(
        username="shopadmin",
        email="admin@example.com",
        password="adminpass123"
    )


@pytest.fixture
def other_user(db):
    """Create another test user for multi-user tests."""
    from django.contrib.auth import get_user_model
    User = get_user_model()
    return User.objects.create_user(
        username="otheruser",
        email="other@example.com",
        password="otherpass123"
    )


# =============================================================================
# API Client Fixtures
# =============================================================================

@pytest.fixture
def api_client():
    """Create an unauthenticated API client."""
    from rest_framework.test import APIClient
    return APIClient()


@pytest.fixture
def auth_api_client(api_client, user):
    """Create an authenticated API client."""
    api_client.force_authenticate(user=user)
    return api_client


@pytest.fixture
def admin_api_client(api_client, admin_user):
    """Create an admin-authenticated API client."""
    api_client.force_authenticate(user=admin_user)
    return api_client


# =============================================================================
# Category Fixtures
# =============================================================================

@pytest.fixture
def category(db):
    """Create a test category."""
    return Category.objects.create(
        name="Electronics",
        description="Electronic devices and accessories"
    )


@pytest.fixture
def category_with_children(db, category):
    """Create a category with child categories."""
    phones = Category.objects.create(name="Phones", parent=category)
    computers = Category.objects.create(name="Computers", parent=category)
    return category, [phones, computers]


@pytest.fixture
def multiple_categories(db):
    """Create multiple categories."""
    return [
        Category.objects.create(name="Electronics"),
        Category.objects.create(name="Clothing"),
        Category.objects.create(name="Home & Garden"),
    ]


# =============================================================================
# Product Fixtures
# =============================================================================

@pytest.fixture
def product(db, category):
    """Create a test product."""
    return Product.objects.create(
        name="Test Product",
        description="A great test product",
        short_description="Great product",
        price=Decimal("99.99"),
        stock_quantity=100,
        category=category
    )


@pytest.fixture
def product_on_sale(db, category):
    """Create a product on sale."""
    return Product.objects.create(
        name="Sale Product",
        description="This product is on sale",
        price=Decimal("79.99"),
        compare_at_price=Decimal("99.99"),
        stock_quantity=50,
        category=category
    )


@pytest.fixture
def product_out_of_stock(db, category):
    """Create an out-of-stock product."""
    return Product.objects.create(
        name="Out of Stock Product",
        description="This product is out of stock",
        price=Decimal("49.99"),
        stock_quantity=0,
        stock_status="out_of_stock",
        category=category
    )


@pytest.fixture
def featured_product(db, category):
    """Create a featured product."""
    return Product.objects.create(
        name="Featured Product",
        description="This is a featured product",
        price=Decimal("149.99"),
        is_featured=True,
        category=category
    )


@pytest.fixture
def multiple_products(db, category):
    """Create multiple products."""
    products = []
    for i in range(5):
        products.append(Product.objects.create(
            name=f"Product {i+1}",
            description=f"Description for product {i+1}",
            price=Decimal(f"{(i+1)*10}.99"),
            stock_quantity=10 * (i + 1),
            category=category
        ))
    return products


# =============================================================================
# Cart Fixtures
# =============================================================================

@pytest.fixture
def cart(db, user):
    """Create an empty cart for user."""
    return Cart.objects.create(user=user)


@pytest.fixture
def cart_with_item(db, user, product):
    """Create a cart with one item."""
    cart = Cart.objects.create(user=user)
    item = CartItem.objects.create(cart=cart, product=product, quantity=2)
    return cart, item


@pytest.fixture
def cart_with_items(db, user, multiple_products):
    """Create a cart with multiple items."""
    cart = Cart.objects.create(user=user)
    items = []
    for i, product in enumerate(multiple_products[:3]):
        items.append(CartItem.objects.create(
            cart=cart,
            product=product,
            quantity=i + 1
        ))
    return cart, items


@pytest.fixture
def guest_cart(db, product):
    """Create a guest cart (session-based)."""
    cart = Cart.objects.create(session_key="test-session-12345")
    CartItem.objects.create(cart=cart, product=product, quantity=1)
    return cart


# =============================================================================
# Order Fixtures
# =============================================================================

@pytest.fixture
def order(db, user):
    """Create a test order."""
    return Order.objects.create(
        user=user,
        email=user.email,
        subtotal=Decimal("199.98"),
        total=Decimal("199.98"),
        shipping_first_name="John",
        shipping_last_name="Doe",
        shipping_address1="123 Main Street",
        shipping_city="New York",
        shipping_state="NY",
        shipping_postal_code="10001",
        shipping_country="USA"
    )


@pytest.fixture
def order_with_items(db, order, product):
    """Create an order with items."""
    item = OrderItem.objects.create(
        order=order,
        product=product,
        quantity=2,
        unit_price=product.price
    )
    return order, [item]


@pytest.fixture
def multiple_orders(db, user):
    """Create multiple orders with different statuses."""
    statuses = ["pending", "confirmed", "shipped", "delivered"]
    orders = []
    for i, status in enumerate(statuses):
        orders.append(Order.objects.create(
            user=user,
            email=user.email,
            status=status,
            subtotal=Decimal(f"{(i+1)*50}.00"),
            total=Decimal(f"{(i+1)*50}.00"),
            shipping_first_name="John",
            shipping_last_name="Doe",
            shipping_address1="123 Main St",
            shipping_city="New York",
            shipping_state="NY",
            shipping_postal_code="10001",
            shipping_country="USA"
        ))
    return orders


# =============================================================================
# Discount & Coupon Fixtures
# =============================================================================

@pytest.fixture
def discount(db):
    """Create a percentage discount."""
    return Discount.objects.create(
        name="Summer Sale",
        discount_type="percentage",
        value=Decimal("20"),
        start_date=timezone.now() - timezone.timedelta(days=1),
        end_date=timezone.now() + timezone.timedelta(days=30)
    )


@pytest.fixture
def fixed_discount(db):
    """Create a fixed amount discount."""
    return Discount.objects.create(
        name="$10 Off",
        discount_type="fixed",
        value=Decimal("10.00"),
        start_date=timezone.now() - timezone.timedelta(days=1),
        end_date=timezone.now() + timezone.timedelta(days=30)
    )


@pytest.fixture
def expired_discount(db):
    """Create an expired discount."""
    return Discount.objects.create(
        name="Expired Sale",
        discount_type="percentage",
        value=Decimal("50"),
        start_date=timezone.now() - timezone.timedelta(days=30),
        end_date=timezone.now() - timezone.timedelta(days=1)
    )


@pytest.fixture
def coupon(db, discount):
    """Create a coupon."""
    return Coupon.objects.create(
        code="SAVE20",
        discount=discount,
        max_uses=100
    )


@pytest.fixture
def single_use_coupon(db, discount):
    """Create a single-use coupon."""
    return Coupon.objects.create(
        code="ONEUSE",
        discount=discount,
        max_uses=1
    )


# =============================================================================
# Review Fixtures
# =============================================================================

@pytest.fixture
def review(db, product, user):
    """Create a product review."""
    return Review.objects.create(
        product=product,
        user=user,
        rating=5,
        title="Excellent!",
        comment="This product exceeded my expectations."
    )


@pytest.fixture
def multiple_reviews(db, product, user, other_user):
    """Create multiple reviews for a product."""
    return [
        Review.objects.create(
            product=product,
            user=user,
            rating=5,
            title="Great!",
            comment="Love it!"
        ),
        Review.objects.create(
            product=product,
            user=other_user,
            rating=4,
            title="Good",
            comment="Pretty good product."
        ),
    ]


# =============================================================================
# Wishlist Fixtures
# =============================================================================

@pytest.fixture
def wishlist(db, user):
    """Create an empty wishlist."""
    return Wishlist.objects.create(user=user)


@pytest.fixture
def wishlist_with_product(db, user, product):
    """Create a wishlist with a product."""
    wishlist = Wishlist.objects.create(user=user)
    wishlist.products.add(product)
    return wishlist, product


@pytest.fixture
def wishlist_with_products(db, user, multiple_products):
    """Create a wishlist with multiple products."""
    wishlist = Wishlist.objects.create(user=user)
    for product in multiple_products[:3]:
        wishlist.products.add(product)
    return wishlist
