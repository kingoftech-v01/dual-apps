"""
E-commerce Serializers for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template
"""

from decimal import Decimal
from rest_framework import serializers
from django.db import transaction

from .models import (
    Category, Product, ProductImage, Tag,
    Cart, CartItem, Order, OrderItem,
    Review, Wishlist, Coupon, Payment
)


# =============================================================================
# Category Serializers
# =============================================================================

class CategoryListSerializer(serializers.ModelSerializer):
    """Category list serializer."""
    product_count = serializers.SerializerMethodField()

    class Meta:
        model = Category
        fields = ["id", "name", "slug", "image", "product_count"]

    def get_product_count(self, obj):
        return obj.products.filter(is_active=True).count()


class CategorySerializer(serializers.ModelSerializer):
    """Category detail serializer with children."""
    children = serializers.SerializerMethodField()
    product_count = serializers.SerializerMethodField()

    class Meta:
        model = Category
        fields = ["id", "name", "slug", "description", "image", "parent", "children", "product_count"]

    def get_children(self, obj):
        children = obj.children.filter(is_active=True)
        return CategoryListSerializer(children, many=True).data

    def get_product_count(self, obj):
        return obj.products.filter(is_active=True).count()


# =============================================================================
# Product Serializers
# =============================================================================

class ProductImageSerializer(serializers.ModelSerializer):
    """Product image serializer."""
    class Meta:
        model = ProductImage
        fields = ["id", "image", "alt_text", "is_primary", "order"]


class TagSerializer(serializers.ModelSerializer):
    """Tag serializer."""
    class Meta:
        model = Tag
        fields = ["id", "name", "slug"]


class ProductListSerializer(serializers.ModelSerializer):
    """Product list serializer (lightweight)."""
    category_name = serializers.CharField(source="category.name", read_only=True)
    primary_image = serializers.SerializerMethodField()
    average_rating = serializers.FloatField(read_only=True)
    review_count = serializers.SerializerMethodField()

    class Meta:
        model = Product
        fields = [
            "id", "name", "slug", "price", "compare_at_price",
            "is_on_sale", "discount_percentage", "is_in_stock",
            "category_name", "primary_image", "average_rating", "review_count",
            "is_featured"
        ]

    def get_primary_image(self, obj):
        image = obj.primary_image
        if image:
            return ProductImageSerializer(image).data
        return None

    def get_review_count(self, obj):
        return obj.reviews.filter(is_approved=True).count()


class ProductDetailSerializer(serializers.ModelSerializer):
    """Product detail serializer (full)."""
    category = CategoryListSerializer(read_only=True)
    images = ProductImageSerializer(many=True, read_only=True)
    tags = TagSerializer(many=True, read_only=True)
    average_rating = serializers.FloatField(read_only=True)
    review_count = serializers.SerializerMethodField()
    reviews = serializers.SerializerMethodField()

    class Meta:
        model = Product
        fields = [
            "id", "name", "slug", "sku", "description", "short_description",
            "price", "compare_at_price", "is_on_sale", "discount_percentage",
            "category", "tags", "brand",
            "stock_quantity", "stock_status", "is_in_stock",
            "is_featured", "is_digital",
            "images", "average_rating", "review_count", "reviews",
            "meta_title", "meta_description",
            "view_count", "sold_count", "created_at"
        ]

    def get_review_count(self, obj):
        return obj.reviews.filter(is_approved=True).count()

    def get_reviews(self, obj):
        reviews = obj.reviews.filter(is_approved=True)[:5]
        return ReviewSerializer(reviews, many=True).data


class ProductSerializer(serializers.ModelSerializer):
    """Standard product serializer."""
    class Meta:
        model = Product
        fields = "__all__"


# =============================================================================
# Cart Serializers
# =============================================================================

class CartItemSerializer(serializers.ModelSerializer):
    """Cart item serializer."""
    product = ProductListSerializer(read_only=True)
    unit_price = serializers.DecimalField(max_digits=10, decimal_places=2, read_only=True)
    total = serializers.DecimalField(max_digits=10, decimal_places=2, read_only=True)

    class Meta:
        model = CartItem
        fields = ["id", "product", "quantity", "unit_price", "total"]


class CartSerializer(serializers.ModelSerializer):
    """Cart serializer with items."""
    items = CartItemSerializer(many=True, read_only=True)
    subtotal = serializers.DecimalField(max_digits=10, decimal_places=2, read_only=True)
    discount_amount = serializers.DecimalField(max_digits=10, decimal_places=2, read_only=True)
    total = serializers.DecimalField(max_digits=10, decimal_places=2, read_only=True)
    item_count = serializers.IntegerField(read_only=True)
    coupon_code = serializers.CharField(source="coupon.code", read_only=True, allow_null=True)

    class Meta:
        model = Cart
        fields = ["id", "items", "subtotal", "discount_amount", "total", "item_count", "coupon_code"]


class AddToCartSerializer(serializers.Serializer):
    """Serializer for adding items to cart."""
    product_id = serializers.UUIDField()
    quantity = serializers.IntegerField(min_value=1, default=1)

    def validate_product_id(self, value):
        if not Product.objects.filter(id=value, is_active=True).exists():
            raise serializers.ValidationError("Product not found or not available")
        return value


class CouponValidateSerializer(serializers.Serializer):
    """Serializer for validating coupon."""
    code = serializers.CharField(max_length=50)


# =============================================================================
# Order Serializers
# =============================================================================

class OrderItemSerializer(serializers.ModelSerializer):
    """Order item serializer."""
    class Meta:
        model = OrderItem
        fields = ["id", "product_name", "product_sku", "quantity", "unit_price", "total"]


class OrderListSerializer(serializers.ModelSerializer):
    """Order list serializer."""
    item_count = serializers.SerializerMethodField()

    class Meta:
        model = Order
        fields = [
            "id", "order_number", "status", "total",
            "item_count", "created_at"
        ]

    def get_item_count(self, obj):
        return obj.items.count()


class OrderSerializer(serializers.ModelSerializer):
    """Order detail serializer."""
    items = OrderItemSerializer(many=True, read_only=True)

    class Meta:
        model = Order
        fields = [
            "id", "order_number", "status", "email",
            "subtotal", "discount_amount", "shipping_cost", "tax_amount", "total",
            "coupon_code",
            "shipping_first_name", "shipping_last_name",
            "shipping_address1", "shipping_address2",
            "shipping_city", "shipping_state", "shipping_postal_code", "shipping_country",
            "shipping_phone",
            "customer_notes",
            "items",
            "created_at", "confirmed_at", "shipped_at", "delivered_at"
        ]


class CreateOrderSerializer(serializers.Serializer):
    """Serializer for creating order from cart."""
    email = serializers.EmailField()

    # Shipping
    shipping_first_name = serializers.CharField(max_length=100)
    shipping_last_name = serializers.CharField(max_length=100)
    shipping_address1 = serializers.CharField(max_length=255)
    shipping_address2 = serializers.CharField(max_length=255, required=False, allow_blank=True)
    shipping_city = serializers.CharField(max_length=100)
    shipping_state = serializers.CharField(max_length=100)
    shipping_postal_code = serializers.CharField(max_length=20)
    shipping_country = serializers.CharField(max_length=100)
    shipping_phone = serializers.CharField(max_length=20, required=False, allow_blank=True)

    # Payment
    payment_method = serializers.ChoiceField(choices=["stripe", "paypal", "bank_transfer", "cash_on_delivery"])

    # Notes
    customer_notes = serializers.CharField(required=False, allow_blank=True)

    @transaction.atomic
    def create(self, validated_data):
        user = self.context["request"].user
        cart = Cart.objects.get(user=user)

        if cart.items.count() == 0:
            raise serializers.ValidationError("Cart is empty")

        # Create order
        order = Order.objects.create(
            user=user,
            email=validated_data["email"],
            subtotal=cart.subtotal,
            discount_amount=cart.discount_amount,
            total=cart.total,
            coupon_code=cart.coupon.code if cart.coupon else "",
            shipping_first_name=validated_data["shipping_first_name"],
            shipping_last_name=validated_data["shipping_last_name"],
            shipping_address1=validated_data["shipping_address1"],
            shipping_address2=validated_data.get("shipping_address2", ""),
            shipping_city=validated_data["shipping_city"],
            shipping_state=validated_data["shipping_state"],
            shipping_postal_code=validated_data["shipping_postal_code"],
            shipping_country=validated_data["shipping_country"],
            shipping_phone=validated_data.get("shipping_phone", ""),
            customer_notes=validated_data.get("customer_notes", ""),
        )

        # Create order items
        for cart_item in cart.items.all():
            OrderItem.objects.create(
                order=order,
                product=cart_item.product,
                quantity=cart_item.quantity,
                unit_price=cart_item.unit_price,
            )

            # Update product stock
            if cart_item.product.track_inventory:
                cart_item.product.stock_quantity -= cart_item.quantity
                cart_item.product.sold_count += cart_item.quantity
                cart_item.product.save()

        # Use coupon
        if cart.coupon:
            cart.coupon.use()

        # Create payment record
        Payment.objects.create(
            order=order,
            amount=order.total,
            method=validated_data["payment_method"],
            status="pending"
        )

        # Clear cart
        cart.items.all().delete()
        cart.coupon = None
        cart.save()

        return order


# =============================================================================
# Review Serializers
# =============================================================================

class ReviewSerializer(serializers.ModelSerializer):
    """Review serializer."""
    user_name = serializers.CharField(source="user.get_full_name", read_only=True)

    class Meta:
        model = Review
        fields = [
            "id", "user_name", "rating", "title", "comment",
            "is_verified_purchase", "created_at"
        ]


class CreateReviewSerializer(serializers.ModelSerializer):
    """Serializer for creating review."""
    class Meta:
        model = Review
        fields = ["rating", "title", "comment"]

    def validate(self, data):
        user = self.context["request"].user
        product = self.context.get("product")

        if product and Review.objects.filter(user=user, product=product).exists():
            raise serializers.ValidationError("You have already reviewed this product")

        return data


# =============================================================================
# Wishlist Serializers
# =============================================================================

class WishlistSerializer(serializers.ModelSerializer):
    """Wishlist serializer."""
    products = ProductListSerializer(many=True, read_only=True)
    count = serializers.IntegerField(read_only=True)

    class Meta:
        model = Wishlist
        fields = ["id", "products", "count"]
