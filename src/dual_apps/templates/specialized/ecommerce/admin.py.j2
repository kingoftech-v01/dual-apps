"""
E-commerce Admin Configuration for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template
"""

from django.contrib import admin
from django.utils.html import format_html
from .models import (
    Category, Product, ProductImage, Tag,
    Discount, Coupon,
    Cart, CartItem,
    Order, OrderItem, Payment, Shipment,
    Review, Wishlist
)


# =============================================================================
# Inlines
# =============================================================================

class ProductImageInline(admin.TabularInline):
    model = ProductImage
    extra = 1
    fields = ["image", "alt_text", "is_primary", "order"]


class OrderItemInline(admin.TabularInline):
    model = OrderItem
    extra = 0
    readonly_fields = ["product_name", "product_sku", "quantity", "unit_price", "total"]
    can_delete = False


class PaymentInline(admin.TabularInline):
    model = Payment
    extra = 0
    readonly_fields = ["amount", "method", "status", "transaction_id", "created_at"]
    can_delete = False


class ShipmentInline(admin.TabularInline):
    model = Shipment
    extra = 0


class CartItemInline(admin.TabularInline):
    model = CartItem
    extra = 0
    readonly_fields = ["product", "quantity"]


# =============================================================================
# Category Admin
# =============================================================================

@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    list_display = ["name", "slug", "parent", "is_active", "order", "product_count"]
    list_filter = ["is_active", "parent"]
    search_fields = ["name", "slug"]
    prepopulated_fields = {"slug": ("name",)}
    ordering = ["order", "name"]

    def product_count(self, obj):
        return obj.products.count()
    product_count.short_description = "Products"


# =============================================================================
# Product Admin
# =============================================================================

@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = [
        "name", "sku", "category", "price_display", "stock_status",
        "is_active", "is_featured", "sold_count"
    ]
    list_filter = ["is_active", "is_featured", "stock_status", "category"]
    search_fields = ["name", "sku", "description"]
    prepopulated_fields = {"slug": ("name",)}
    readonly_fields = ["view_count", "sold_count", "created_at", "updated_at"]
    inlines = [ProductImageInline]
    filter_horizontal = ["tags"]

    fieldsets = (
        ("Basic Info", {
            "fields": ("name", "slug", "sku", "description", "short_description")
        }),
        ("Pricing", {
            "fields": ("price", "compare_at_price", "cost_price")
        }),
        ("Organization", {
            "fields": ("category", "tags", "brand")
        }),
        ("Inventory", {
            "fields": ("stock_quantity", "stock_status", "low_stock_threshold", "track_inventory")
        }),
        ("Status", {
            "fields": ("is_active", "is_featured", "is_digital")
        }),
        ("SEO", {
            "fields": ("meta_title", "meta_description"),
            "classes": ("collapse",)
        }),
        ("Stats", {
            "fields": ("view_count", "sold_count", "created_at", "updated_at"),
            "classes": ("collapse",)
        }),
    )

    def price_display(self, obj):
        if obj.is_on_sale:
            return format_html(
                '<span style="text-decoration: line-through; color: #999;">${}</span> '
                '<span style="color: #e53e3e;">${}</span>',
                obj.compare_at_price, obj.price
            )
        return f"${obj.price}"
    price_display.short_description = "Price"


@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    list_display = ["name", "slug", "product_count"]
    search_fields = ["name"]
    prepopulated_fields = {"slug": ("name",)}

    def product_count(self, obj):
        return obj.products.count()
    product_count.short_description = "Products"


# =============================================================================
# Discount & Coupon Admin
# =============================================================================

@admin.register(Discount)
class DiscountAdmin(admin.ModelAdmin):
    list_display = ["name", "discount_type", "value", "start_date", "end_date", "is_active", "is_valid"]
    list_filter = ["discount_type", "is_active"]
    search_fields = ["name"]
    filter_horizontal = ["products", "categories"]

    def is_valid(self, obj):
        return obj.is_valid
    is_valid.boolean = True


@admin.register(Coupon)
class CouponAdmin(admin.ModelAdmin):
    list_display = ["code", "discount", "max_uses", "used_count", "is_valid"]
    list_filter = ["discount"]
    search_fields = ["code"]
    readonly_fields = ["used_count"]

    def is_valid(self, obj):
        return obj.is_valid
    is_valid.boolean = True


# =============================================================================
# Cart Admin
# =============================================================================

@admin.register(Cart)
class CartAdmin(admin.ModelAdmin):
    list_display = ["id", "user", "session_key", "item_count", "total", "created_at"]
    list_filter = ["created_at"]
    search_fields = ["user__email", "session_key"]
    readonly_fields = ["item_count", "subtotal", "total"]
    inlines = [CartItemInline]

    def item_count(self, obj):
        return obj.item_count


# =============================================================================
# Order Admin
# =============================================================================

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = [
        "order_number", "user", "email", "status",
        "total", "created_at"
    ]
    list_filter = ["status", "created_at"]
    search_fields = ["order_number", "email", "user__email"]
    readonly_fields = [
        "order_number", "subtotal", "discount_amount", "total",
        "created_at", "confirmed_at", "shipped_at", "delivered_at"
    ]
    inlines = [OrderItemInline, PaymentInline, ShipmentInline]
    date_hierarchy = "created_at"

    fieldsets = (
        ("Order Info", {
            "fields": ("order_number", "user", "email", "status")
        }),
        ("Pricing", {
            "fields": ("subtotal", "discount_amount", "shipping_cost", "tax_amount", "total", "coupon_code")
        }),
        ("Shipping Address", {
            "fields": (
                "shipping_first_name", "shipping_last_name",
                "shipping_address1", "shipping_address2",
                "shipping_city", "shipping_state", "shipping_postal_code", "shipping_country",
                "shipping_phone"
            )
        }),
        ("Billing Address", {
            "fields": (
                "billing_same_as_shipping",
                "billing_first_name", "billing_last_name",
                "billing_address1", "billing_address2",
                "billing_city", "billing_state", "billing_postal_code", "billing_country"
            ),
            "classes": ("collapse",)
        }),
        ("Notes", {
            "fields": ("customer_notes", "admin_notes")
        }),
        ("Timestamps", {
            "fields": ("created_at", "confirmed_at", "shipped_at", "delivered_at"),
            "classes": ("collapse",)
        }),
    )

    actions = ["mark_confirmed", "mark_shipped", "mark_delivered"]

    def mark_confirmed(self, request, queryset):
        from django.utils import timezone
        queryset.update(status="confirmed", confirmed_at=timezone.now())
    mark_confirmed.short_description = "Mark as confirmed"

    def mark_shipped(self, request, queryset):
        from django.utils import timezone
        queryset.update(status="shipped", shipped_at=timezone.now())
    mark_shipped.short_description = "Mark as shipped"

    def mark_delivered(self, request, queryset):
        from django.utils import timezone
        queryset.update(status="delivered", delivered_at=timezone.now())
    mark_delivered.short_description = "Mark as delivered"


# =============================================================================
# Review Admin
# =============================================================================

@admin.register(Review)
class ReviewAdmin(admin.ModelAdmin):
    list_display = ["product", "user", "rating", "is_approved", "is_verified_purchase", "created_at"]
    list_filter = ["rating", "is_approved", "is_verified_purchase"]
    search_fields = ["product__name", "user__email", "comment"]
    readonly_fields = ["created_at"]
    actions = ["approve_reviews", "reject_reviews"]

    def approve_reviews(self, request, queryset):
        queryset.update(is_approved=True)
    approve_reviews.short_description = "Approve selected reviews"

    def reject_reviews(self, request, queryset):
        queryset.update(is_approved=False)
    reject_reviews.short_description = "Reject selected reviews"


# =============================================================================
# Wishlist Admin
# =============================================================================

@admin.register(Wishlist)
class WishlistAdmin(admin.ModelAdmin):
    list_display = ["user", "product_count", "created_at"]
    search_fields = ["user__email"]
    filter_horizontal = ["products"]

    def product_count(self, obj):
        return obj.count
    product_count.short_description = "Products"
