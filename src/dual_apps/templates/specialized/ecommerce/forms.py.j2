"""
E-commerce forms for {{ app_name }} app.

Checkout, cart, and review forms with validation.

Generated by dual-apps v{{ version }}
"""

from django import forms
from django.core.validators import MinValueValidator, MaxValueValidator

from .models import Order, Review


class AddToCartForm(forms.Form):
    """Form for adding products to cart."""
    product_id = forms.UUIDField(widget=forms.HiddenInput())
    quantity = forms.IntegerField(
        min_value=1,
        max_value=100,
        initial=1,
        widget=forms.NumberInput(attrs={
            "class": "form-control",
            "style": "width: 80px;",
        })
    )

    def clean_quantity(self):
        quantity = self.cleaned_data["quantity"]
        if quantity < 1:
            raise forms.ValidationError("Quantity must be at least 1.")
        return quantity


class UpdateCartForm(forms.Form):
    """Form for updating cart item quantity."""
    item_id = forms.UUIDField(widget=forms.HiddenInput())
    quantity = forms.IntegerField(
        min_value=0,
        max_value=100,
        widget=forms.NumberInput(attrs={
            "class": "form-control",
            "style": "width: 80px;",
        })
    )


class CheckoutForm(forms.Form):
    """Multi-step checkout form."""

    # Shipping address
    shipping_first_name = forms.CharField(max_length=100, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_last_name = forms.CharField(max_length=100, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_email = forms.EmailField(widget=forms.EmailInput(attrs={"class": "form-control"}))
    shipping_phone = forms.CharField(max_length=20, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_address_1 = forms.CharField(max_length=255, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_address_2 = forms.CharField(max_length=255, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_city = forms.CharField(max_length=100, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_state = forms.CharField(max_length=100, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_postal_code = forms.CharField(max_length=20, widget=forms.TextInput(attrs={"class": "form-control"}))
    shipping_country = forms.CharField(max_length=2, initial="US", widget=forms.TextInput(attrs={"class": "form-control"}))

    # Billing same as shipping?
    billing_same_as_shipping = forms.BooleanField(
        required=False,
        initial=True,
        widget=forms.CheckboxInput(attrs={"class": "form-check-input"})
    )

    # Billing address (optional if same as shipping)
    billing_first_name = forms.CharField(max_length=100, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_last_name = forms.CharField(max_length=100, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_address_1 = forms.CharField(max_length=255, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_address_2 = forms.CharField(max_length=255, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_city = forms.CharField(max_length=100, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_state = forms.CharField(max_length=100, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_postal_code = forms.CharField(max_length=20, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))
    billing_country = forms.CharField(max_length=2, required=False, widget=forms.TextInput(attrs={"class": "form-control"}))

    # Payment
    payment_method = forms.ChoiceField(
        choices=[
            ("card", "Credit/Debit Card"),
            ("paypal", "PayPal"),
            ("cod", "Cash on Delivery"),
        ],
        widget=forms.RadioSelect(attrs={"class": "form-check-input"})
    )

    # Notes
    order_notes = forms.CharField(
        required=False,
        widget=forms.Textarea(attrs={
            "class": "form-control",
            "rows": 3,
            "placeholder": "Notes about your order (optional)"
        })
    )

    def clean(self):
        cleaned_data = super().clean()
        billing_same = cleaned_data.get("billing_same_as_shipping")

        if not billing_same:
            # Billing address is required
            required_fields = [
                "billing_first_name", "billing_last_name",
                "billing_address_1", "billing_city",
                "billing_state", "billing_postal_code"
            ]
            for field in required_fields:
                if not cleaned_data.get(field):
                    self.add_error(field, "This field is required.")

        return cleaned_data


class ReviewForm(forms.ModelForm):
    """Form for product reviews."""

    class Meta:
        model = Review
        fields = ["rating", "title", "comment"]
        widgets = {
            "rating": forms.RadioSelect(
                choices=[(i, "â˜…" * i) for i in range(1, 6)],
                attrs={"class": "rating-stars"}
            ),
            "title": forms.TextInput(attrs={
                "class": "form-control",
                "placeholder": "Review title"
            }),
            "comment": forms.Textarea(attrs={
                "class": "form-control",
                "rows": 4,
                "placeholder": "Write your review..."
            }),
        }

    def clean_rating(self):
        rating = self.cleaned_data["rating"]
        if rating < 1 or rating > 5:
            raise forms.ValidationError("Rating must be between 1 and 5.")
        return rating


class CouponForm(forms.Form):
    """Form for applying coupon codes."""
    code = forms.CharField(
        max_length=50,
        widget=forms.TextInput(attrs={
            "class": "form-control",
            "placeholder": "Enter coupon code"
        })
    )


class ProductFilterForm(forms.Form):
    """Form for filtering products."""
    category = forms.ChoiceField(
        required=False,
        widget=forms.Select(attrs={"class": "form-select"})
    )
    min_price = forms.DecimalField(
        required=False,
        min_value=0,
        widget=forms.NumberInput(attrs={
            "class": "form-control",
            "placeholder": "Min price"
        })
    )
    max_price = forms.DecimalField(
        required=False,
        min_value=0,
        widget=forms.NumberInput(attrs={
            "class": "form-control",
            "placeholder": "Max price"
        })
    )
    in_stock = forms.BooleanField(
        required=False,
        widget=forms.CheckboxInput(attrs={"class": "form-check-input"})
    )
    sort_by = forms.ChoiceField(
        required=False,
        choices=[
            ("", "Default"),
            ("price_asc", "Price: Low to High"),
            ("price_desc", "Price: High to Low"),
            ("name", "Name: A-Z"),
            ("-name", "Name: Z-A"),
            ("-created_at", "Newest First"),
        ],
        widget=forms.Select(attrs={"class": "form-select"})
    )

    def __init__(self, *args, categories=None, **kwargs):
        super().__init__(*args, **kwargs)
        if categories:
            self.fields["category"].choices = [("", "All Categories")] + [
                (str(c.id), c.name) for c in categories
            ]
