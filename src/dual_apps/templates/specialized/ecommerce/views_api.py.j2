"""
E-commerce API Views for {{ project_name }}.
Generated by dual-apps v{{ version }} - E-commerce Template

DRF ViewSets for complete e-commerce functionality.
"""

from rest_framework import viewsets, status, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated, IsAuthenticatedOrReadOnly, AllowAny
from django_filters.rest_framework import DjangoFilterBackend
from django.db.models import Avg, Count
from drf_spectacular.utils import extend_schema, extend_schema_view, OpenApiParameter

from .models import (
    Category, Product, ProductImage, Tag,
    Cart, CartItem, Order, OrderItem,
    Review, Wishlist, Coupon
)
from .serializers import (
    CategorySerializer, CategoryListSerializer,
    ProductSerializer, ProductListSerializer, ProductDetailSerializer,
    CartSerializer, CartItemSerializer, AddToCartSerializer,
    OrderSerializer, OrderListSerializer, CreateOrderSerializer,
    ReviewSerializer, CreateReviewSerializer,
    WishlistSerializer, CouponValidateSerializer
)
from .permissions import IsOwnerOrReadOnly


# =============================================================================
# Category ViewSet
# =============================================================================

@extend_schema_view(
    list=extend_schema(summary="List categories", tags=["Categories"]),
    retrieve=extend_schema(summary="Get category", tags=["Categories"]),
)
class CategoryViewSet(viewsets.ReadOnlyModelViewSet):
    """
    Category API - Read only.

    Endpoints:
    - GET /api/v1/categories/ - List all categories
    - GET /api/v1/categories/{slug}/ - Get category with products
    """
    queryset = Category.objects.filter(is_active=True)
    permission_classes = [AllowAny]
    lookup_field = "slug"

    def get_serializer_class(self):
        if self.action == "list":
            return CategoryListSerializer
        return CategorySerializer

    @extend_schema(summary="Get category tree", tags=["Categories"])
    @action(detail=False, methods=["get"])
    def tree(self, request):
        """Get hierarchical category tree."""
        root_categories = self.queryset.filter(parent__isnull=True)
        serializer = CategorySerializer(root_categories, many=True)
        return Response(serializer.data)


# =============================================================================
# Product ViewSet
# =============================================================================

@extend_schema_view(
    list=extend_schema(summary="List products", tags=["Products"]),
    retrieve=extend_schema(summary="Get product", tags=["Products"]),
)
class ProductViewSet(viewsets.ReadOnlyModelViewSet):
    """
    Product API - Read only.

    Endpoints:
    - GET /api/v1/products/ - List products with filtering
    - GET /api/v1/products/{slug}/ - Get product details
    - GET /api/v1/products/featured/ - Featured products
    - GET /api/v1/products/on-sale/ - Products on sale
    """
    queryset = Product.objects.filter(is_active=True).select_related("category").prefetch_related("images", "tags")
    permission_classes = [AllowAny]
    lookup_field = "slug"

    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ["category__slug", "brand", "is_featured", "stock_status"]
    search_fields = ["name", "description", "sku"]
    ordering_fields = ["price", "created_at", "sold_count", "name"]
    ordering = ["-created_at"]

    def get_serializer_class(self):
        if self.action == "list":
            return ProductListSerializer
        return ProductDetailSerializer

    def retrieve(self, request, *args, **kwargs):
        """Get product and increment view count."""
        instance = self.get_object()
        instance.view_count += 1
        instance.save(update_fields=["view_count"])
        serializer = self.get_serializer(instance)
        return Response(serializer.data)

    @extend_schema(summary="Featured products", tags=["Products"])
    @action(detail=False, methods=["get"])
    def featured(self, request):
        """Get featured products."""
        queryset = self.queryset.filter(is_featured=True)[:12]
        serializer = ProductListSerializer(queryset, many=True)
        return Response(serializer.data)

    @extend_schema(summary="Products on sale", tags=["Products"])
    @action(detail=False, methods=["get"])
    def on_sale(self, request):
        """Get products on sale."""
        queryset = self.queryset.filter(compare_at_price__isnull=False).exclude(compare_at_price__lte=models.F("price"))
        serializer = ProductListSerializer(queryset, many=True)
        return Response(serializer.data)

    @extend_schema(summary="Related products", tags=["Products"])
    @action(detail=True, methods=["get"])
    def related(self, request, slug=None):
        """Get related products based on category."""
        product = self.get_object()
        queryset = self.queryset.filter(category=product.category).exclude(id=product.id)[:8]
        serializer = ProductListSerializer(queryset, many=True)
        return Response(serializer.data)


# =============================================================================
# Cart ViewSet
# =============================================================================

class CartViewSet(viewsets.ViewSet):
    """
    Cart API.

    Supports both authenticated and guest users.

    Endpoints:
    - GET /api/v1/cart/ - Get current cart
    - POST /api/v1/cart/add/ - Add item to cart
    - POST /api/v1/cart/update/ - Update item quantity
    - POST /api/v1/cart/remove/ - Remove item from cart
    - POST /api/v1/cart/clear/ - Clear cart
    - POST /api/v1/cart/apply-coupon/ - Apply coupon
    """
    permission_classes = [AllowAny]

    def get_cart(self, request):
        """Get or create cart for user/session."""
        if request.user.is_authenticated:
            cart, _ = Cart.objects.get_or_create(user=request.user)
        else:
            session_key = request.session.session_key
            if not session_key:
                request.session.create()
                session_key = request.session.session_key
            cart, _ = Cart.objects.get_or_create(session_key=session_key)
        return cart

    @extend_schema(summary="Get cart", tags=["Cart"])
    def list(self, request):
        """Get current cart."""
        cart = self.get_cart(request)
        serializer = CartSerializer(cart)
        return Response(serializer.data)

    @extend_schema(summary="Add to cart", tags=["Cart"], request=AddToCartSerializer)
    @action(detail=False, methods=["post"])
    def add(self, request):
        """Add item to cart."""
        cart = self.get_cart(request)
        serializer = AddToCartSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        product = Product.objects.get(id=serializer.validated_data["product_id"])
        quantity = serializer.validated_data.get("quantity", 1)

        cart_item, created = CartItem.objects.get_or_create(
            cart=cart,
            product=product,
            defaults={"quantity": quantity}
        )

        if not created:
            cart_item.quantity += quantity
            cart_item.save()

        return Response(CartSerializer(cart).data, status=status.HTTP_201_CREATED)

    @extend_schema(summary="Update cart item", tags=["Cart"])
    @action(detail=False, methods=["post"], url_path="update-quantity")
    def update_quantity(self, request):
        """Update item quantity."""
        cart = self.get_cart(request)
        item_id = request.data.get("item_id")
        quantity = request.data.get("quantity", 1)

        try:
            item = cart.items.get(id=item_id)
            if quantity <= 0:
                item.delete()
            else:
                item.quantity = quantity
                item.save()
            return Response(CartSerializer(cart).data)
        except CartItem.DoesNotExist:
            return Response({"error": "Item not found"}, status=status.HTTP_404_NOT_FOUND)

    @extend_schema(summary="Remove from cart", tags=["Cart"])
    @action(detail=False, methods=["post"])
    def remove(self, request):
        """Remove item from cart."""
        cart = self.get_cart(request)
        item_id = request.data.get("item_id")

        try:
            item = cart.items.get(id=item_id)
            item.delete()
            return Response(CartSerializer(cart).data)
        except CartItem.DoesNotExist:
            return Response({"error": "Item not found"}, status=status.HTTP_404_NOT_FOUND)

    @extend_schema(summary="Clear cart", tags=["Cart"])
    @action(detail=False, methods=["post"])
    def clear(self, request):
        """Clear all items from cart."""
        cart = self.get_cart(request)
        cart.items.all().delete()
        cart.coupon = None
        cart.save()
        return Response(CartSerializer(cart).data)

    @extend_schema(summary="Apply coupon", tags=["Cart"], request=CouponValidateSerializer)
    @action(detail=False, methods=["post"], url_path="apply-coupon")
    def apply_coupon(self, request):
        """Apply coupon code to cart."""
        cart = self.get_cart(request)
        code = request.data.get("code", "").upper()

        try:
            coupon = Coupon.objects.get(code=code)
            if not coupon.is_valid:
                return Response({"error": "Coupon is not valid"}, status=status.HTTP_400_BAD_REQUEST)

            cart.coupon = coupon
            cart.save()
            return Response(CartSerializer(cart).data)
        except Coupon.DoesNotExist:
            return Response({"error": "Coupon not found"}, status=status.HTTP_404_NOT_FOUND)


# =============================================================================
# Order ViewSet
# =============================================================================

@extend_schema_view(
    list=extend_schema(summary="List orders", tags=["Orders"]),
    retrieve=extend_schema(summary="Get order", tags=["Orders"]),
    create=extend_schema(summary="Create order", tags=["Orders"]),
)
class OrderViewSet(viewsets.ModelViewSet):
    """
    Order API.

    Endpoints:
    - GET /api/v1/orders/ - List user's orders
    - GET /api/v1/orders/{order_number}/ - Get order details
    - POST /api/v1/orders/ - Create order from cart
    """
    permission_classes = [IsAuthenticated]
    lookup_field = "order_number"
    http_method_names = ["get", "post", "head", "options"]

    def get_queryset(self):
        return Order.objects.filter(user=self.request.user).prefetch_related("items")

    def get_serializer_class(self):
        if self.action == "list":
            return OrderListSerializer
        elif self.action == "create":
            return CreateOrderSerializer
        return OrderSerializer

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)

    @extend_schema(summary="Cancel order", tags=["Orders"])
    @action(detail=True, methods=["post"])
    def cancel(self, request, order_number=None):
        """Cancel pending order."""
        order = self.get_object()
        if order.status not in ["pending", "confirmed"]:
            return Response(
                {"error": "Order cannot be cancelled"},
                status=status.HTTP_400_BAD_REQUEST
            )
        order.status = "cancelled"
        order.save()
        return Response(OrderSerializer(order).data)


# =============================================================================
# Review ViewSet
# =============================================================================

@extend_schema_view(
    list=extend_schema(summary="List reviews", tags=["Reviews"]),
    create=extend_schema(summary="Create review", tags=["Reviews"]),
)
class ReviewViewSet(viewsets.ModelViewSet):
    """
    Review API.

    Endpoints:
    - GET /api/v1/products/{slug}/reviews/ - List product reviews
    - POST /api/v1/products/{slug}/reviews/ - Create review
    """
    permission_classes = [IsAuthenticatedOrReadOnly, IsOwnerOrReadOnly]
    http_method_names = ["get", "post", "delete", "head", "options"]

    def get_queryset(self):
        return Review.objects.filter(
            product__slug=self.kwargs.get("product_slug"),
            is_approved=True
        ).select_related("user")

    def get_serializer_class(self):
        if self.action == "create":
            return CreateReviewSerializer
        return ReviewSerializer

    def perform_create(self, serializer):
        product = Product.objects.get(slug=self.kwargs.get("product_slug"))
        serializer.save(user=self.request.user, product=product)


# =============================================================================
# Wishlist ViewSet
# =============================================================================

class WishlistViewSet(viewsets.ViewSet):
    """
    Wishlist API.

    Endpoints:
    - GET /api/v1/wishlist/ - Get wishlist
    - POST /api/v1/wishlist/add/ - Add product
    - POST /api/v1/wishlist/remove/ - Remove product
    """
    permission_classes = [IsAuthenticated]

    def get_wishlist(self, request):
        wishlist, _ = Wishlist.objects.get_or_create(user=request.user)
        return wishlist

    @extend_schema(summary="Get wishlist", tags=["Wishlist"])
    def list(self, request):
        """Get user's wishlist."""
        wishlist = self.get_wishlist(request)
        serializer = WishlistSerializer(wishlist)
        return Response(serializer.data)

    @extend_schema(summary="Add to wishlist", tags=["Wishlist"])
    @action(detail=False, methods=["post"])
    def add(self, request):
        """Add product to wishlist."""
        wishlist = self.get_wishlist(request)
        product_id = request.data.get("product_id")

        try:
            product = Product.objects.get(id=product_id)
            wishlist.products.add(product)
            return Response(WishlistSerializer(wishlist).data)
        except Product.DoesNotExist:
            return Response({"error": "Product not found"}, status=status.HTTP_404_NOT_FOUND)

    @extend_schema(summary="Remove from wishlist", tags=["Wishlist"])
    @action(detail=False, methods=["post"])
    def remove(self, request):
        """Remove product from wishlist."""
        wishlist = self.get_wishlist(request)
        product_id = request.data.get("product_id")

        try:
            product = Product.objects.get(id=product_id)
            wishlist.products.remove(product)
            return Response(WishlistSerializer(wishlist).data)
        except Product.DoesNotExist:
            return Response({"error": "Product not found"}, status=status.HTTP_404_NOT_FOUND)


# Import for F expressions
from django.db import models
