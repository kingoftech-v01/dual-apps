#!/bin/bash
# Deploy script for {{ project_name }}
# Generated by dual-apps v{{ version }}
#
# Usage: ./scripts/deploy.sh [staging|production]

set -e

ENVIRONMENT=${1:-staging}

echo "ðŸš€ Deploying {{ project_name }} to ${ENVIRONMENT}..."

# Build Docker image
echo "ðŸ³ Building Docker image..."
docker build -f docker/Dockerfile.app -t {{ project_name }}:${ENVIRONMENT} .

# Run tests
echo "ðŸ§ª Running tests..."
docker run --rm {{ project_name }}:${ENVIRONMENT} pytest

# Tag and push
if [ "$ENVIRONMENT" = "production" ]; then
    VERSION=$(cat VERSION 2>/dev/null || echo "latest")
    docker tag {{ project_name }}:${ENVIRONMENT} {{ project_name }}:${VERSION}
    docker tag {{ project_name }}:${ENVIRONMENT} {{ project_name }}:latest
    echo "ðŸ“¦ Tagged: {{ project_name }}:${VERSION}"
fi

# Deploy based on environment
if [ "$ENVIRONMENT" = "staging" ]; then
    echo "ðŸ“¤ Deploying to staging..."
    docker-compose -f docker-compose.dev.yml up -d
elif [ "$ENVIRONMENT" = "production" ]; then
    echo "ðŸ“¤ Deploying to production..."
    docker-compose -f docker-compose.prod.yml pull
    docker-compose -f docker-compose.prod.yml up -d --no-deps app
    docker-compose -f docker-compose.prod.yml exec app python manage.py migrate --noinput
    docker-compose -f docker-compose.prod.yml exec app python manage.py collectstatic --noinput
fi

echo "âœ… Deployment complete!"
echo "   Environment: ${ENVIRONMENT}"
echo "   URL: http://localhost:8000"
